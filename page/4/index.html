<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="lxm798">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="lxm798">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="lxm798">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/4/">





  <title>lxm798</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">lxm798</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/分布式一致性/redis和mysql一致性/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/分布式一致性/redis和mysql一致性/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="redis-和mysql-一致性"><a href="#redis-和mysql-一致性" class="headerlink" title="redis 和mysql 一致性"></a>redis 和mysql 一致性</h1><h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>redis 和mysql 中的数据不可能保证一致,只能尽量保证数据是一致的.所以有线性一致性的数据,可以选择etcd/zk来存储数据.<br>下面从几个方面来说明</p>
<h2 id="同步复制和异步复制"><a href="#同步复制和异步复制" class="headerlink" title="同步复制和异步复制"></a>同步复制和异步复制</h2><p>同步复制时需要将数据同步到从节点后再提交,而异步复制系统则提交和同步是分离的.mysql提供了同步,半同步和异步的方式.而redis只提供了异步复制,这样在主节点失效后,在做主从切换的时候,主节点的变更没有复制到从节点就会导致数据丢失,此时即使协议上能完全保证mysql-redis完全一致,也会由于数据丢失导致不一致. 所以下面从以下几个方面来考虑降低不一致的概率</p>
<h2 id="业务场景"><a href="#业务场景" class="headerlink" title="业务场景"></a>业务场景</h2><ul>
<li>有没有热点数据</li>
<li>并发量是不是高</li>
</ul>
<h3 id="旁路更新"><a href="#旁路更新" class="headerlink" title="旁路更新"></a>旁路更新</h3><p>旁路更新:<br>读数据: 查询redis,如果miss,读取db,更新redis<br>写数据: 更新db,删除redis<br>产生不一致的情况:更新和删除操作操作在读取和更新redis之间,但是读db一般比更新快,所以概率会小一点</p>
<p>好在redis本身提供了事务,但是redis的事务是不加锁的方案<br>旁路更新2:<br>读数据: 查询redis,如果miss,watch key,multi,读取db,更新redis,exec<br>写数据: 更新db,删除redis<br>在读取db之前设置watch key,如果提交失败,可以再读一次,但是如果对于读的并发很高,会在某个瞬间多次读数据库,不过概率应该比较低</p>
<p>旁路更新不适合有热点数据并且读写入很高的场景,但是对于读并发较高的场景很合适.</p>
<h3 id="串行化"><a href="#串行化" class="headerlink" title="串行化"></a>串行化</h3><p>串行化,将对同一个key的操作串行化</p>
<h4 id="同步的串行化"><a href="#同步的串行化" class="headerlink" title="同步的串行化"></a>同步的串行化</h4><p>每一层服务都做一致性hash,然后在同一个进程中hash处理key,保证同一个key对应的操作串行化,但是这样在有较大的并发且有热点数据的时候有可能会hang住</p>
<h4 id="异步串行化"><a href="#异步串行化" class="headerlink" title="异步串行化"></a>异步串行化</h4><p>redis的操作通过一个后台服务来处理,通过binlog同步写入的数据到redis.但是这时候对于读操作仍然需要触发,此时读操作实际就是load数据到redis,在redis没有命中的时候,将读操作转化为load操作放入队列中,后台服务将同一个key的操作在同一个线程中处理.在操作结束后返回数据.<br>考虑一种场景,对于读操作如果没有命中redis,直接请求数据库,然后将数据返回,同时异步发送到更新服务中.这时能比较及时的返回数据(减少了一次rpc),但是由于此时的数据可能和db不一致,所以这个数据可能是错误的,如果数据本身是有版本号的是不是想想就比较简单了呢,通过cas的操作来比较数据,然而redis并不支持数据的版本操作比较.所以这个方案放弃</p>
<p>串行化可以在更新的时候就将数据写入,通常由于局部性原理,应该也比较容易被读到,这种情况下读写较高的请求都可以</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/分布式一致性/tcc-transaction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/分布式一致性/tcc-transaction/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="tcc-transaction-源码分析"><a href="#tcc-transaction-源码分析" class="headerlink" title="tcc-transaction 源码分析"></a>tcc-transaction 源码分析</h1><h2 id="总揽"><a href="#总揽" class="headerlink" title="总揽"></a>总揽</h2><p>tcc 的方案使用TM管理事务,root事务管理分支事务.在root事务达到confirming状态后就相当于事务已经完成.<br>tcc 包含try/commit/cancel三个步骤. 但不是仅仅是这个步骤.例如AP 崩溃的情况,需要处理悬空事务.<br>悬空事务的处理是由TM首先写入本地日志,来记录ROOT事务,同时每次分支事务都需要记录本地日志.<br>通过定时任务扫描超时的事务,根据事务的状态确定是confirm还是cancel</p>
<h2 id="处理"><a href="#处理" class="headerlink" title="处理"></a>处理</h2><p>具体的参数说明与tcc-transaction-http-order 中传入参数一致<br>ConfigurableTransactionAspect</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 事务管理器</span></span><br><span class="line">    TransactionManager transactionManager = transactionConfigurator.getTransactionManager();</span><br><span class="line"></span><br><span class="line">    CompensableTransactionInterceptor compensableTransactionInterceptor = <span class="keyword">new</span> CompensableTransactionInterceptor();</span><br><span class="line">    <span class="comment">// 注入事务管理器</span></span><br><span class="line">    compensableTransactionInterceptor.setTransactionManager(transactionManager);</span><br><span class="line">    <span class="comment">// 注入延时处理exeception</span></span><br><span class="line">    compensableTransactionInterceptor.setDelayCancelExceptions(transactionConfigurator.getRecoverConfig().getDelayCancelExceptions());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.setCompensableTransactionInterceptor(compensableTransactionInterceptor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompensableTransactionInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理包含Compensable注解的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">interceptCompensableMethod</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">        Method method = CompensableMethodUtils.getCompensableMethod(pjp);</span><br><span class="line"></span><br><span class="line">        Compensable compensable = method.getAnnotation(Compensable.class);</span><br><span class="line">        <span class="comment">// REQUIRED</span></span><br><span class="line">        Propagation propagation = compensable.propagation();</span><br><span class="line">        TransactionContext transactionContext = FactoryBuilder.factoryOf(compensable.transactionContextEditor()).getInstance().get(pjp.getTarget(), method, pjp.getArgs());</span><br><span class="line">        <span class="comment">// 异步comfirm true</span></span><br><span class="line">        <span class="keyword">boolean</span> asyncConfirm = compensable.asyncConfirm();</span><br><span class="line">        <span class="comment">// 异步concel, false</span></span><br><span class="line">        <span class="keyword">boolean</span> asyncCancel = compensable.asyncCancel();</span><br><span class="line">        <span class="comment">// 当前线程是否有事务在处理</span></span><br><span class="line">        <span class="keyword">boolean</span> isTransactionActive = transactionManager.isTransactionActive();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!TransactionUtils.isLegalTransactionContext(isTransactionActive, propagation, transactionContext)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(<span class="string">"no active compensable transaction while propagation is mandatory for method "</span> + method.getName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        MethodType methodType = CompensableMethodUtils.calculateMethodType(propagation, isTransactionActive, transactionContext);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (methodType) &#123;</span><br><span class="line">            <span class="keyword">case</span> ROOT:</span><br><span class="line">                <span class="keyword">return</span> rootMethodProceed(pjp, asyncConfirm, asyncCancel);</span><br><span class="line">            <span class="keyword">case</span> PROVIDER:</span><br><span class="line">                <span class="keyword">return</span> providerMethodProceed(pjp, transactionContext, asyncConfirm, asyncCancel);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> pjp.proceed();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">rootMethodProceed</span><span class="params">(ProceedingJoinPoint pjp, <span class="keyword">boolean</span> asyncConfirm, <span class="keyword">boolean</span> asyncCancel)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">        Object returnValue = <span class="keyword">null</span>;</span><br><span class="line">        Transaction transaction = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 将transcation写入数据库</span></span><br><span class="line">            transaction = transactionManager.begin();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// try</span></span><br><span class="line">                returnValue = pjp.proceed();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable tryingException) &#123;</span><br><span class="line">                <span class="comment">// 异常不需要延时处理</span></span><br><span class="line">                <span class="keyword">if</span> (!isDelayCancelException(tryingException)) &#123;</span><br><span class="line">                   </span><br><span class="line">                    logger.warn(String.format(<span class="string">"compensable transaction trying failed. transaction content:%s"</span>, JSON.toJSONString(transaction)), tryingException);</span><br><span class="line">                    <span class="comment">// 执行rollback</span></span><br><span class="line">                    transactionManager.rollback(asyncCancel);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">throw</span> tryingException;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 提交</span></span><br><span class="line">            transactionManager.commit(asyncConfirm);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 清除threadlocal 但是不清除数据库</span></span><br><span class="line">            transactionManager.cleanAfterCompletion(transaction);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> returnValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">providerMethodProceed</span><span class="params">(ProceedingJoinPoint pjp, TransactionContext transactionContext, <span class="keyword">boolean</span> asyncConfirm, <span class="keyword">boolean</span> asyncCancel)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">        Transaction transaction = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (TransactionStatus.valueOf(transactionContext.getStatus())) &#123;</span><br><span class="line">                <span class="keyword">case</span> TRYING:</span><br><span class="line">                    transaction = transactionManager.propagationNewBegin(transactionContext);</span><br><span class="line">                    <span class="keyword">return</span> pjp.proceed();</span><br><span class="line">                <span class="keyword">case</span> CONFIRMING:</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        transaction = transactionManager.propagationExistBegin(transactionContext);</span><br><span class="line">                        transactionManager.commit(asyncConfirm);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (NoExistedTransactionException excepton) &#123;</span><br><span class="line">                        <span class="comment">//the transaction has been commit,ignore it.</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> CANCELLING:</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        transaction = transactionManager.propagationExistBegin(transactionContext);</span><br><span class="line">                        transactionManager.rollback(asyncCancel);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (NoExistedTransactionException exception) &#123;</span><br><span class="line">                        <span class="comment">//the transaction has been rollback,ignore it.</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            transactionManager.cleanAfterCompletion(transaction);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Method method = ((MethodSignature) (pjp.getSignature())).getMethod();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ReflectionUtils.getNullValue(method.getReturnType());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isDelayCancelException</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (delayCancelExceptions != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Class delayCancelException : delayCancelExceptions) &#123;</span><br><span class="line"></span><br><span class="line">                Throwable rootCause = ExceptionUtils.getRootCause(throwable);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (delayCancelException.isAssignableFrom(throwable.getClass())</span><br><span class="line">                        || (rootCause != <span class="keyword">null</span> &amp;&amp; delayCancelException.isAssignableFrom(rootCause.getClass()))) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Transaction</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7291423944314337931L</span>;</span><br><span class="line">    <span class="comment">// 事务唯一ID</span></span><br><span class="line">    <span class="keyword">private</span> TransactionXid xid;</span><br><span class="line">    <span class="comment">// 事务状态 TRYING(1), CONFIRMING(2), CANCELLING(3);</span></span><br><span class="line">    <span class="keyword">private</span> TransactionStatus status;</span><br><span class="line">    <span class="comment">// 事务类型    ROOT(1),    BRANCH(2);</span></span><br><span class="line">    <span class="keyword">private</span> TransactionType transactionType;</span><br><span class="line">    <span class="comment">// 重试次数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> retriedCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date createTime = <span class="keyword">new</span> Date();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date lastUpdateTime = <span class="keyword">new</span> Date();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> version = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 参与者</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Participant&gt; participants = <span class="keyword">new</span> ArrayList&lt;Participant&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; attachments = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Object&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Transaction</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Transaction</span><span class="params">(TransactionContext transactionContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.xid = transactionContext.getXid();</span><br><span class="line">        <span class="keyword">this</span>.status = TransactionStatus.TRYING;</span><br><span class="line">        <span class="keyword">this</span>.transactionType = TransactionType.BRANCH;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Transaction</span><span class="params">(TransactionType transactionType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.xid = <span class="keyword">new</span> TransactionXid();</span><br><span class="line">        <span class="keyword">this</span>.status = TransactionStatus.TRYING;</span><br><span class="line">        <span class="keyword">this</span>.transactionType = transactionType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enlistParticipant</span><span class="params">(Participant participant)</span> </span>&#123;</span><br><span class="line">        participants.add(participant);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Xid <span class="title">getXid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> xid.clone();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TransactionStatus <span class="title">getStatus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Participant&gt; <span class="title">getParticipants</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> participants;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TransactionType <span class="title">getTransactionType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> transactionType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">changeStatus</span><span class="params">(TransactionStatus status)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.status = status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历所有Participant,执行commit</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Participant participant : participants) &#123;</span><br><span class="line">            participant.commit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 遍历所有Participant,执行rollback</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Participant participant : participants) &#123;</span><br><span class="line">            participant.rollback();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getRetriedCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> retriedCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRetriedCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.retriedCount++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">resetRetriedCount</span><span class="params">(<span class="keyword">int</span> retriedCount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.retriedCount = retriedCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getAttachments</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> attachments;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getVersion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> version;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateVersion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.version++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVersion</span><span class="params">(<span class="keyword">long</span> version)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.version = version;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getLastUpdateTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lastUpdateTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLastUpdateTime</span><span class="params">(Date date)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lastUpdateTime = date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getCreateTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lastUpdateTime = <span class="keyword">new</span> Date();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = Logger.getLogger(TransactionManager.class.getSimpleName());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TransactionRepository transactionRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Deque&lt;Transaction&gt;&gt; CURRENT = <span class="keyword">new</span> ThreadLocal&lt;Deque&lt;Transaction&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ExecutorService executorService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTransactionRepository</span><span class="params">(TransactionRepository transactionRepository)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.transactionRepository = transactionRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExecutorService</span><span class="params">(ExecutorService executorService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.executorService = executorService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TransactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Transaction <span class="title">begin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 初始化xid,status,transcationType</span></span><br><span class="line">        Transaction transaction = <span class="keyword">new</span> Transaction(TransactionType.ROOT);</span><br><span class="line">        <span class="comment">// 插入tcc数据库</span></span><br><span class="line">        transactionRepository.create(transaction);</span><br><span class="line">        <span class="comment">// 注册threadlocal</span></span><br><span class="line">        registerTransaction(transaction);</span><br><span class="line">        <span class="keyword">return</span> transaction;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Transaction <span class="title">propagationNewBegin</span><span class="params">(TransactionContext transactionContext)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Transaction transaction = <span class="keyword">new</span> Transaction(transactionContext);</span><br><span class="line">        transactionRepository.create(transaction);</span><br><span class="line"></span><br><span class="line">        registerTransaction(transaction);</span><br><span class="line">        <span class="keyword">return</span> transaction;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Transaction <span class="title">propagationExistBegin</span><span class="params">(TransactionContext transactionContext)</span> <span class="keyword">throws</span> NoExistedTransactionException </span>&#123;</span><br><span class="line">        Transaction transaction = transactionRepository.findByXid(transactionContext.getXid());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (transaction != <span class="keyword">null</span>) &#123;</span><br><span class="line">            transaction.changeStatus(TransactionStatus.valueOf(transactionContext.getStatus()));</span><br><span class="line">            registerTransaction(transaction);</span><br><span class="line">            <span class="keyword">return</span> transaction;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoExistedTransactionException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">(<span class="keyword">boolean</span> asyncCommit)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 当前事务</span></span><br><span class="line">        <span class="keyword">final</span> Transaction transaction = getCurrentTransaction();</span><br><span class="line">        <span class="comment">// 更新为提交中</span></span><br><span class="line">        transaction.changeStatus(TransactionStatus.CONFIRMING);</span><br><span class="line">        <span class="comment">// 更新tcc数据库</span></span><br><span class="line">        transactionRepository.update(transaction);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (asyncCommit) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Long statTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">                executorService.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        commitTransaction(transaction);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                logger.debug(<span class="string">"async submit cost time:"</span> + (System.currentTimeMillis() - statTime));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable commitException) &#123;</span><br><span class="line">                logger.warn(<span class="string">"compensable transaction async submit confirm failed, recovery job will try to confirm later."</span>, commitException);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConfirmingException(commitException);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            commitTransaction(transaction);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">(<span class="keyword">boolean</span> asyncRollback)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Transaction transaction = getCurrentTransaction();</span><br><span class="line">        transaction.changeStatus(TransactionStatus.CANCELLING);</span><br><span class="line"></span><br><span class="line">        transactionRepository.update(transaction);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (asyncRollback) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                executorService.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        rollbackTransaction(transaction);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable rollbackException) &#123;</span><br><span class="line">                logger.warn(<span class="string">"compensable transaction async rollback failed, recovery job will try to rollback later."</span>, rollbackException);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> CancellingException(rollbackException);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            rollbackTransaction(transaction);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">commitTransaction</span><span class="params">(Transaction transaction)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            transaction.commit();</span><br><span class="line">            <span class="comment">// 删除tcc记录</span></span><br><span class="line">            transactionRepository.delete(transaction);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable commitException) &#123;</span><br><span class="line">            logger.warn(<span class="string">"compensable transaction confirm failed, recovery job will try to confirm later."</span>, commitException);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConfirmingException(commitException);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rollbackTransaction</span><span class="params">(Transaction transaction)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            transaction.rollback();</span><br><span class="line">            transactionRepository.delete(transaction);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable rollbackException) &#123;</span><br><span class="line">            logger.warn(<span class="string">"compensable transaction rollback failed, recovery job will try to rollback later."</span>, rollbackException);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CancellingException(rollbackException);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Transaction <span class="title">getCurrentTransaction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isTransactionActive()) &#123;</span><br><span class="line">            <span class="keyword">return</span> CURRENT.get().peek();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTransactionActive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Deque&lt;Transaction&gt; transactions = CURRENT.get();</span><br><span class="line">        <span class="keyword">return</span> transactions != <span class="keyword">null</span> &amp;&amp; !transactions.isEmpty();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerTransaction</span><span class="params">(Transaction transaction)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (CURRENT.get() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            CURRENT.set(<span class="keyword">new</span> LinkedList&lt;Transaction&gt;());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        CURRENT.get().push(transaction);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cleanAfterCompletion</span><span class="params">(Transaction transaction)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isTransactionActive() &amp;&amp; transaction != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Transaction currentTransaction = getCurrentTransaction();</span><br><span class="line">            <span class="keyword">if</span> (currentTransaction == transaction) &#123;</span><br><span class="line">                CURRENT.get().pop();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(<span class="string">"Illegal transaction when clean after completion"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enlistParticipant</span><span class="params">(Participant participant)</span> </span>&#123;</span><br><span class="line">        Transaction transaction = <span class="keyword">this</span>.getCurrentTransaction();</span><br><span class="line">        transaction.enlistParticipant(participant);</span><br><span class="line">        transactionRepository.update(transaction);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>悬挂事务恢复</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionRecovery</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = Logger.getLogger(TransactionRecovery.class.getSimpleName());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TransactionConfigurator transactionConfigurator;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startRecover</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        List&lt;Transaction&gt; transactions = loadErrorTransactions();</span><br><span class="line"></span><br><span class="line">        recoverErrorTransactions(transactions);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;Transaction&gt; <span class="title">loadErrorTransactions</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> currentTimeInMillis = Calendar.getInstance().getTimeInMillis();</span><br><span class="line"></span><br><span class="line">        TransactionRepository transactionRepository = transactionConfigurator.getTransactionRepository();</span><br><span class="line">        RecoverConfig recoverConfig = transactionConfigurator.getRecoverConfig();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> transactionRepository.findAllUnmodifiedSince(<span class="keyword">new</span> Date(currentTimeInMillis - recoverConfig.getRecoverDuration() * <span class="number">1000</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">recoverErrorTransactions</span><span class="params">(List&lt;Transaction&gt; transactions)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Transaction transaction : transactions) &#123;</span><br><span class="line">            <span class="comment">// 大于最大重试次数</span></span><br><span class="line">            <span class="keyword">if</span> (transaction.getRetriedCount() &gt; transactionConfigurator.getRecoverConfig().getMaxRetryCount()) &#123;</span><br><span class="line"></span><br><span class="line">                logger.error(String.format(<span class="string">"recover failed with max retry count,will not try again. txid:%s, status:%s,retried count:%d,transaction content:%s"</span>, transaction.getXid(), transaction.getStatus().getId(), transaction.getRetriedCount(), JSON.toJSONString(transaction)));</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 分支事务</span></span><br><span class="line">            <span class="keyword">if</span> (transaction.getTransactionType().equals(TransactionType.BRANCH)</span><br><span class="line">                    &amp;&amp; (transaction.getCreateTime().getTime() +</span><br><span class="line">                    transactionConfigurator.getRecoverConfig().getMaxRetryCount() *</span><br><span class="line">                            transactionConfigurator.getRecoverConfig().getRecoverDuration() * <span class="number">1000</span></span><br><span class="line">                    &gt; System.currentTimeMillis())) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 增加重试次数</span></span><br><span class="line">                transaction.addRetriedCount();</span><br><span class="line">                <span class="comment">// try 结束,提交前失败,进入CONFIRMING阶段就认为成功</span></span><br><span class="line">                <span class="keyword">if</span> (transaction.getStatus().equals(TransactionStatus.CONFIRMING)) &#123;</span><br><span class="line"></span><br><span class="line">                    transaction.changeStatus(TransactionStatus.CONFIRMING);</span><br><span class="line">                    transactionConfigurator.getTransactionRepository().update(transaction);</span><br><span class="line">                    <span class="comment">// 这时的transcation 已经写入</span></span><br><span class="line">                    transaction.commit();</span><br><span class="line">                    transactionConfigurator.getTransactionRepository().delete(transaction);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (transaction.getStatus().equals(TransactionStatus.CANCELLING)</span><br><span class="line">                        || transaction.getTransactionType().equals(TransactionType.ROOT)) &#123;</span><br><span class="line">                    <span class="comment">//在try 或者cancel阶段直接失败</span></span><br><span class="line">                    transaction.changeStatus(TransactionStatus.CANCELLING);</span><br><span class="line">                    transactionConfigurator.getTransactionRepository().update(transaction);</span><br><span class="line">                    transaction.rollback();</span><br><span class="line">                    transactionConfigurator.getTransactionRepository().delete(transaction);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (throwable <span class="keyword">instanceof</span> OptimisticLockException</span><br><span class="line">                        || ExceptionUtils.getRootCause(throwable) <span class="keyword">instanceof</span> OptimisticLockException) &#123;</span><br><span class="line">                    logger.warn(String.format(<span class="string">"optimisticLockException happened while recover. txid:%s, status:%s,retried count:%d,transaction content:%s"</span>, transaction.getXid(), transaction.getStatus().getId(), transaction.getRetriedCount(), JSON.toJSONString(transaction)), throwable);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    logger.error(String.format(<span class="string">"recover failed, txid:%s, status:%s,retried count:%d,transaction content:%s"</span>, transaction.getXid(), transaction.getStatus().getId(), transaction.getRetriedCount(), JSON.toJSONString(transaction)), throwable);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTransactionConfigurator</span><span class="params">(TransactionConfigurator transactionConfigurator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.transactionConfigurator = transactionConfigurator;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/spring/spring aop 组织顺序源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/spring/spring aop 组织顺序源码分析/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="spring-切面组织源码分析"><a href="#spring-切面组织源码分析" class="headerlink" title="spring 切面组织源码分析"></a>spring 切面组织源码分析</h1><h2 id="spring-aop简介"><a href="#spring-aop简介" class="headerlink" title="spring aop简介"></a>spring aop简介</h2><p>在运行时，动态地将代码切入到类的指定方法、指定位置上的编程思想就是面向切面的编程。</p>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p>spring 中需配置aop</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/aop/spring-aop.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"classpath:conf/datasource.xml"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"classpath:dubbo/provider.xml"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"classpath:conf/spring-redis.xml"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">"logAspect"</span> <span class="attr">ref</span>=<span class="string">"logInterceptor"</span> <span class="attr">order</span>=<span class="string">"11"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"servicePointcut"</span></span></span><br><span class="line"><span class="tag">                          <span class="attr">expression</span>=<span class="string">"execution(public* com.test..*.*(..))"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:around</span> <span class="attr">pointcut-ref</span>=<span class="string">"servicePointcut"</span> <span class="attr">method</span>=<span class="string">"logAround"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:after</span> <span class="attr">pointcut-ref</span>=<span class="string">"servicePointcut"</span> <span class="attr">method</span>=<span class="string">"doAfter"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"logInterceptor"</span> <span class="attr">class</span>=<span class="string">"com.test.aop.LogAspect1"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogAspect1</span> <span class="keyword">implements</span> <span class="title">Ordered</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(LogAspect.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LogAspect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAfter</span><span class="params">(JoinPoint point)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"doAfter"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">logAround</span><span class="params">(ProceedingJoinPoint proceeding)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String clientIP = RpcContext.getContext().getRemoteHost();</span><br><span class="line">        Object ret = proceeding.proceed(proceeding.getArgs());</span><br><span class="line">        logger.info(<span class="string">"requestIp:&#123;&#125;"</span>, clientIP);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样在执行时会输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">requestIp:<span class="number">127.0</span>.0.1</span><br><span class="line">doAfter</span><br></pre></td></tr></table></figure>

<h2 id="Aspect-执行顺序"><a href="#Aspect-执行顺序" class="headerlink" title="Aspect 执行顺序"></a>Aspect 执行顺序</h2><p>Aspect 中提供了以下切面的方式:</p>
<ul>
<li>before：在join point 之前咨询的advice，不能阻止join point</li>
<li>after： 在join point之后执行</li>
<li>After throwing advice：join point 抛出异常后的advice</li>
<li>After(finally) advice：在join point返回或者抛出异常之后的advice</li>
<li>Around advice：在join point方法执行之前和之后的advice<br>调用顺序如下:</li>
<li>正常结束<br><img src="./pic/aop_order.jpg" alt="正常"></li>
<li>出现异常<br><img src="./pic/aop_order_exception.jpg" alt="异常"></li>
<li>嵌套结构<br><img src="./pic/aop_nest.jpg" alt="嵌套"><br>那么spring 时如何组织和描述切面的呢?</li>
</ul>
<h2 id="spring-组织切面源码分析"><a href="#spring-组织切面源码分析" class="headerlink" title="spring 组织切面源码分析"></a>spring 组织切面源码分析</h2><h3 id="猜想"><a href="#猜想" class="headerlink" title="猜想"></a>猜想</h3><p>在看源码前,我以为会按照上面的流程逐层包装原有的函数. 类似</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Object ret = origin;</span><br><span class="line"><span class="keyword">while</span>(nextAspect != <span class="keyword">null</span>) &#123;</span><br><span class="line">    ret = wrap(ret, nextAspect);</span><br><span class="line">    nextAspect = nextAspect.next;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ret;</span><br></pre></td></tr></table></figure>

<p>其中wrap为生成动态代理的函数,这样会有很多层动态代理.##</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>spring 源码中处理aop 是将Advisor提前排序,然后递归调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> List&lt;Advisor&gt; <span class="title">findEligibleAdvisors</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> </span>&#123;</span><br><span class="line">    List&lt;Advisor&gt; candidateAdvisors = <span class="keyword">this</span>.findCandidateAdvisors();</span><br><span class="line">    List&lt;Advisor&gt; eligibleAdvisors = <span class="keyword">this</span>.findAdvisorsThatCanApply(candidateAdvisors, beanClass, beanName);</span><br><span class="line">    <span class="keyword">this</span>.extendAdvisors(eligibleAdvisors);</span><br><span class="line">    <span class="keyword">if</span> (!eligibleAdvisors.isEmpty()) &#123;</span><br><span class="line">        eligibleAdvisors = <span class="keyword">this</span>.sortAdvisors(eligibleAdvisors);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> eligibleAdvisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>前面两步返回有效的advisor,然后对advisor进行排序,排序实际按照优先级和Joinpoint的类型进行排序,优先级高的先执行:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> List&lt;Advisor&gt; <span class="title">sortAdvisors</span><span class="params">(List&lt;Advisor&gt; advisors)</span> </span>&#123;</span><br><span class="line">	List&lt;PartiallyComparableAdvisorHolder&gt; partiallyComparableAdvisors =</span><br><span class="line">			<span class="keyword">new</span> ArrayList&lt;PartiallyComparableAdvisorHolder&gt;(advisors.size());</span><br><span class="line">	<span class="keyword">for</span> (Advisor element : advisors) &#123;</span><br><span class="line">		partiallyComparableAdvisors.add(</span><br><span class="line">				<span class="keyword">new</span> PartiallyComparableAdvisorHolder(element, DEFAULT_PRECEDENCE_COMPARATOR));</span><br><span class="line">	&#125;</span><br><span class="line">	List&lt;PartiallyComparableAdvisorHolder&gt; sorted =</span><br><span class="line">			PartialOrder.sort(partiallyComparableAdvisors);</span><br><span class="line">	<span class="keyword">if</span> (sorted != <span class="keyword">null</span>) &#123;</span><br><span class="line">		List&lt;Advisor&gt; result = <span class="keyword">new</span> ArrayList&lt;Advisor&gt;(advisors.size());</span><br><span class="line">		<span class="keyword">for</span> (PartiallyComparableAdvisorHolder pcAdvisor : sorted) &#123;</span><br><span class="line">			result.add(pcAdvisor.getAdvisor());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">super</span>.sortAdvisors(advisors);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PartiallyComparableAdvisorHolder 将Advisor包装成为可比较对象,然后利用PartialOrder进行排序,首先看下PartiallyComparableAdvisorHolder的结构</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PartiallyComparableAdvisorHolder</span><span class="params">(Advisor advisor, Comparator&lt;Advisor&gt; comparator)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.advisor = advisor;</span><br><span class="line">    <span class="keyword">this</span>.comparator = comparator;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">    Advisor otherAdvisor = ((PartiallyComparableAdvisorHolder) obj).advisor;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.comparator.compare(<span class="keyword">this</span>.advisor, otherAdvisor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PartiallyComparableAdvisorHolder 实际就是利用DEFAULT_PRECEDENCE_COMPARATOR来比较Advisor,DEFAULT_PRECEDENCE_COMPARATOR 的代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AspectJPrecedenceComparator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.advisorComparator = AnnotationAwareOrderComparator.INSTANCE;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Advisor o1, Advisor o2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> advisorPrecedence = <span class="keyword">this</span>.advisorComparator.compare(o1, o2);</span><br><span class="line">    <span class="keyword">if</span> (advisorPrecedence == SAME_PRECEDENCE &amp;&amp; declaredInSameAspect(o1, o2)) &#123;</span><br><span class="line">        advisorPrecedence = comparePrecedenceWithinAspect(o1, o2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> advisorPrecedence;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先利用advisorComparator 进行比较,如果相等,然后在比较comparePrecedenceWithinAspect,advisorComparator实际是AnnotationAwareOrderComparator,实现如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Object o1, Object o2)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> doCompare(o1, o2, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">doCompare</span><span class="params">(Object o1, Object o2, OrderSourceProvider sourceProvider)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">boolean</span> p1 = (o1 <span class="keyword">instanceof</span> PriorityOrdered);</span><br><span class="line">	<span class="keyword">boolean</span> p2 = (o2 <span class="keyword">instanceof</span> PriorityOrdered);</span><br><span class="line">	<span class="keyword">if</span> (p1 &amp;&amp; !p2) &#123;</span><br><span class="line">		<span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (p2 &amp;&amp; !p1) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Direct evaluation instead of Integer.compareTo to avoid unnecessary object creation.</span></span><br><span class="line">	<span class="keyword">int</span> i1 = getOrder(o1, sourceProvider);</span><br><span class="line">	<span class="keyword">int</span> i2 = getOrder(o2, sourceProvider);</span><br><span class="line">	<span class="keyword">return</span> (i1 &lt; i2) ? -<span class="number">1</span> : (i1 &gt; i2) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里主要是比较优先级,getOrder函数实现如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">(Object obj, OrderSourceProvider sourceProvider)</span> </span>&#123;</span><br><span class="line">    Integer order = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (sourceProvider != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Object orderSource = sourceProvider.getOrderSource(obj);</span><br><span class="line">        <span class="keyword">if</span> (orderSource != <span class="keyword">null</span> &amp;&amp; orderSource.getClass().isArray()) &#123;</span><br><span class="line">            Object[] sources = ObjectUtils.toObjectArray(orderSource);</span><br><span class="line">            <span class="keyword">for</span> (Object source : sources) &#123;</span><br><span class="line">                order = findOrder(source);</span><br><span class="line">                <span class="keyword">if</span> (order != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            order = findOrder(orderSource);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (order != <span class="keyword">null</span> ? order : getOrder(obj));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Integer <span class="title">findOrder</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Check for regular Ordered interface</span></span><br><span class="line">    Integer order = <span class="keyword">super</span>.findOrder(obj);</span><br><span class="line">    <span class="keyword">if</span> (order != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check for @Order and @Priority on various kinds of elements</span></span><br><span class="line">    <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">        <span class="keyword">return</span> OrderUtils.getOrder((Class&lt;?&gt;) obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Method) &#123;</span><br><span class="line">        Order ann = AnnotationUtils.findAnnotation((Method) obj, Order.class);</span><br><span class="line">        <span class="keyword">if</span> (ann != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ann.value();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> AnnotatedElement) &#123;</span><br><span class="line">        Order ann = AnnotationUtils.getAnnotation((AnnotatedElement) obj, Order.class);</span><br><span class="line">        <span class="keyword">if</span> (ann != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ann.value();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (obj != <span class="keyword">null</span>) &#123;</span><br><span class="line">        order = OrderUtils.getOrder(obj.getClass());</span><br><span class="line">        <span class="keyword">if</span> (order == <span class="keyword">null</span> &amp;&amp; obj <span class="keyword">instanceof</span> DecoratingProxy) &#123;</span><br><span class="line">            order = OrderUtils.getOrder(((DecoratingProxy) obj).getDecoratedClass());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> order;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于相同优先级的Advisor会根据Advisor的类型进行比较:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">comparePrecedenceWithinAspect</span><span class="params">(Advisor advisor1, Advisor advisor2)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">boolean</span> oneOrOtherIsAfterAdvice =</span><br><span class="line">			(AspectJAopUtils.isAfterAdvice(advisor1) || AspectJAopUtils.isAfterAdvice(advisor2));</span><br><span class="line">	<span class="keyword">int</span> adviceDeclarationOrderDelta = getAspectDeclarationOrder(advisor1) - getAspectDeclarationOrder(advisor2);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (oneOrOtherIsAfterAdvice) &#123;</span><br><span class="line">		<span class="comment">// the advice declared last has higher precedence</span></span><br><span class="line">		<span class="keyword">if</span> (adviceDeclarationOrderDelta &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">// advice1 was declared before advice2</span></span><br><span class="line">			<span class="comment">// so advice1 has lower precedence</span></span><br><span class="line">			<span class="keyword">return</span> LOWER_PRECEDENCE;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (adviceDeclarationOrderDelta == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> SAME_PRECEDENCE;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> HIGHER_PRECEDENCE;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// the advice declared first has higher precedence</span></span><br><span class="line">		<span class="keyword">if</span> (adviceDeclarationOrderDelta &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">// advice1 was declared before advice2</span></span><br><span class="line">			<span class="comment">// so advice1 has higher precedence</span></span><br><span class="line">			<span class="keyword">return</span> HIGHER_PRECEDENCE;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (adviceDeclarationOrderDelta == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> SAME_PRECEDENCE;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> LOWER_PRECEDENCE;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里对于实现了AfterAdvice接口的对象,数值越大优先级越高,对于没有实现该借口的函数,数值越小优先级越高,其实和上面的嵌套的图对应,顺序时调用顺序的逆序.AfterAdvice接口会在之前的函数都完成后再调用. 相同优先级的Advisor,After比Around靠前.</p>
<p>上面还有个PartialOrder,这个类实际只进行偏序排序,如果两个Advisor 拍不出优先级,哪个在前都可以</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List <span class="title">sort</span><span class="params">(List objects)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// lists of size 0 or 1 don't need any sorting</span></span><br><span class="line">    <span class="keyword">if</span> (objects.size() &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> objects;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ??? we might want to optimize a few other cases of small size</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ??? I don't like creating this data structure, but it does give good</span></span><br><span class="line">    <span class="comment">// ??? separation of concerns.</span></span><br><span class="line">    List&lt;SortObject&gt; sortList = <span class="keyword">new</span> LinkedList&lt;SortObject&gt;(); <span class="comment">// objects.size());</span></span><br><span class="line">    <span class="keyword">for</span> (Iterator i = objects.iterator(); i.hasNext();) &#123;</span><br><span class="line">        addNewPartialComparable(sortList, (PartialComparable) i.next());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// System.out.println(sortList);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// now we have built our directed graph</span></span><br><span class="line">    <span class="comment">// use a simple sort algorithm from here</span></span><br><span class="line">    <span class="comment">// can increase efficiency later</span></span><br><span class="line">    <span class="comment">// List ret = new ArrayList(objects.size());</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = objects.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; N; index++) &#123;</span><br><span class="line">        <span class="comment">// System.out.println(sortList);</span></span><br><span class="line">        <span class="comment">// System.out.println("--&gt;" + ret);</span></span><br><span class="line"></span><br><span class="line">        SortObject leastWithNoSmallers = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Iterator i = sortList.iterator(); i.hasNext();) &#123;</span><br><span class="line">            SortObject so = (SortObject) i.next();</span><br><span class="line">            <span class="comment">// System.out.println(so);</span></span><br><span class="line">            <span class="keyword">if</span> (so.hasNoSmallerObjects()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (leastWithNoSmallers == <span class="keyword">null</span> || so.object.fallbackCompareTo(leastWithNoSmallers.object) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    leastWithNoSmallers = so;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (leastWithNoSmallers == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        removeFromGraph(sortList, leastWithNoSmallers);</span><br><span class="line">        objects.set(index, leastWithNoSmallers.object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> objects;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SortObject</span> </span>&#123;</span><br><span class="line">    PartialComparable object;</span><br><span class="line">    List&lt;SortObject&gt; smallerObjects = <span class="keyword">new</span> LinkedList&lt;SortObject&gt;();</span><br><span class="line">    List&lt;SortObject&gt; biggerObjects = <span class="keyword">new</span> LinkedList&lt;SortObject&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的实现按照对象间的关系保存一个图结构DAG,然后遍历DAG,找出当前优先级最低的节点,然后删除节点在图中的所有信息,循环此过程直到所有的节点都处理为止.到得一个偏序的链表</p>
<p>在这里可能有个疑问,相同的优先级都优先调用如何实现前面的调用关系?</p>
<h3 id="运行时调用顺序"><a href="#运行时调用顺序" class="headerlink" title="运行时调用顺序"></a>运行时调用顺序</h3><h4 id="JdkDynamicAopProxy"><a href="#JdkDynamicAopProxy" class="headerlink" title="JdkDynamicAopProxy"></a>JdkDynamicAopProxy</h4><p>JdkDynamicAopProxy 是依据Advisor生成的动态代理,实际执行的函数为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    List&lt;Object&gt; chain = <span class="keyword">this</span>.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</span><br><span class="line">    <span class="keyword">if</span> (chain.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// We can skip creating a MethodInvocation: just invoke the target directly</span></span><br><span class="line">        <span class="comment">// Note that the final invoker must be an InvokerInterceptor so we know it does</span></span><br><span class="line">        <span class="comment">// nothing but a reflective operation on the target, and no hot swapping or fancy proxying.</span></span><br><span class="line">        Object[] argsToUse = AopProxyUtils.adaptArgumentsIfNecessary(method, args);</span><br><span class="line">        retVal = AopUtils.invokeJoinpointUsingReflection(target, method, argsToUse);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// We need to create a method invocation...</span></span><br><span class="line">        invocation = <span class="keyword">new</span> ReflectiveMethodInvocation(proxy, target, method, args, targetClass, chain);</span><br><span class="line">        <span class="comment">// Proceed to the joinpoint through the interceptor chain.</span></span><br><span class="line">        retVal = invocation.proceed();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果没有Advisor,则直接调用方法,如果有Advisor则通过ReflectiveMethodInvocation调用,其中process函数实现如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">proceed</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="comment">//	We start with an index of -1 and increment early.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.currentInterceptorIndex == <span class="keyword">this</span>.interceptorsAndDynamicMethodMatchers.size() - <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> invokeJoinpoint();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用下一个Advisor</span></span><br><span class="line">    Object interceptorOrInterceptionAdvice =</span><br><span class="line">            <span class="keyword">this</span>.interceptorsAndDynamicMethodMatchers.get(++<span class="keyword">this</span>.currentInterceptorIndex);</span><br><span class="line">    <span class="keyword">if</span> (interceptorOrInterceptionAdvice <span class="keyword">instanceof</span> InterceptorAndDynamicMethodMatcher) &#123;</span><br><span class="line">        <span class="comment">// Evaluate dynamic method matcher here: static part will already have</span></span><br><span class="line">        <span class="comment">// been evaluated and found to match.</span></span><br><span class="line">        InterceptorAndDynamicMethodMatcher dm =</span><br><span class="line">                (InterceptorAndDynamicMethodMatcher) interceptorOrInterceptionAdvice;</span><br><span class="line">        <span class="keyword">if</span> (dm.methodMatcher.matches(<span class="keyword">this</span>.method, <span class="keyword">this</span>.targetClass, <span class="keyword">this</span>.arguments)) &#123;</span><br><span class="line">            <span class="keyword">return</span> dm.interceptor.invoke(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Dynamic matching failed.</span></span><br><span class="line">            <span class="comment">// Skip this interceptor and invoke the next in the chain.</span></span><br><span class="line">            <span class="keyword">return</span> proceed();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// It's an interceptor, so we just invoke it: The pointcut will have</span></span><br><span class="line">        <span class="comment">// been evaluated statically before this object was constructed.</span></span><br><span class="line">        <span class="keyword">return</span> ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里调用实际是递归调用,invoke传入的参数时this,以After为例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(MethodInvocation mi)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    Object var2;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        var2 = mi.proceed();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.invokeAdviceMethod(<span class="keyword">this</span>.getJoinPointMatch(), (Object)<span class="keyword">null</span>, (Throwable)<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> var2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的mi就是上面的ReflectiveMethodInvocation,并且在前面说明中 After比Around优先调用,但是用户自定义过程比Around迟.按照该函数会先执行ReflectiveMethodInvocation.proceed,按照proceed方法的说明如果有Advisor就执行advisor的切面,这样如果有一个Aspect需要执行After和Around,<br>先执行After,在After中递归调用到Around,在Around执行完成后,堆栈退回执行invokeAdviceMethod</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/工作/工作杂谈/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/工作/工作杂谈/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id><a href="#" class="headerlink" title></a></h1><p>技能,过去工作,未来规划<br>技能 / 公司JD</p>
<p>过去的工作:<br>以技术中台服务为主,主要内容集中在即时通讯,广告工程,媒体服务调度<br>即时通讯挑战:高并发,消息不丢不重复,高可用<br>广告:</p>
<p>未来工作:</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/分布式一致性/分布式一致性/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/分布式一致性/分布式一致性/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="分布式一致性"><a href="#分布式一致性" class="headerlink" title="分布式一致性"></a>分布式一致性</h1><h2 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h2><h3 id="TCC"><a href="#TCC" class="headerlink" title="TCC"></a>TCC</h3><p>TCC需要将事务信息添加到内存中,溶蚀进行外部持久化</p>
<h3 id="XA"><a href="#XA" class="headerlink" title="XA"></a>XA</h3><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>####悬挂</p>
<h2 id="强一致"><a href="#强一致" class="headerlink" title="强一致"></a>强一致</h2><h2 id="最终一致"><a href="#最终一致" class="headerlink" title="最终一致"></a>最终一致</h2><p>都是通过定时任务回查root事务是否超时或者完成或者失败,来更新是否commit 消息\数据</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/server/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/server/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>消峰：<br>内存队列</p>
<p>批处理：<br>批量发送到前端机器</p>
<p>内存缓存：<br>直播间状态在内存中缓存：api 控制直播间是否已经关闭</p>
<p>降级<br>1.消息分级–分级丢弃<br>2.CDN</p>
<p>降低带宽：<br>压缩</p>
<p>延迟请求：</p>
<p>负载均衡：<br>一致性hash<br>前端负载均衡</p>
<p>限流：</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/数据结构和算法/skiplist/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/数据结构和算法/skiplist/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="skiplist"><a href="#skiplist" class="headerlink" title="skiplist"></a>skiplist</h1><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>去年在redis中看到skiplist,作为Hash结构的一种实现,了解了下原理.现在在java中又看到ConcurrentSkipList, 这里回头看看整体实现.<br>skiplist 作为一种概率型索引结构,经常用来和平衡二叉树作为对比,个人实现后感觉实现比各类平衡二叉树要好很多</p>
<h2 id="数据结构说明"><a href="#数据结构说明" class="headerlink" title="数据结构说明"></a>数据结构说明</h2><p>对于有header的结构来说,总体描述如下:</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>Node和skipList定义</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> V&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:de(<span class="keyword">int</span> level, <span class="keyword">const</span> T &amp; t, <span class="keyword">const</span> V &amp;v) &#123;</span><br><span class="line">    <span class="keyword">this</span>-&gt;t = t;</span><br><span class="line">    <span class="keyword">this</span>-&gt;v = v;</span><br><span class="line">    <span class="keyword">this</span>-&gt;level = level;</span><br><span class="line">    <span class="keyword">this</span>-&gt;nodes = (Node&lt;T,V&gt; **) <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">void</span> *) * level);</span><br><span class="line">    <span class="built_in">memset</span>(<span class="keyword">this</span>-&gt;nodes, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *) * level);</span><br><span class="line">&#125;</span><br><span class="line">T t;</span><br><span class="line">V v;</span><br><span class="line"><span class="keyword">int</span> level;</span><br><span class="line">Node&lt;T, V&gt; **nodes;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> V&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SkipList</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Node&lt;T, V&gt; * head;</span><br><span class="line">    <span class="keyword">int</span> level;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>增删改查</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">SkipList(<span class="keyword">int</span> level) &#123;</span><br><span class="line">    <span class="keyword">this</span>-&gt;level = level;</span><br><span class="line">    head = <span class="keyword">new</span> Node&lt;T, V&gt;(level, <span class="number">-1000</span>, <span class="number">-1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">const</span> T &amp;t, <span class="keyword">const</span> V &amp;v)</span> </span>&#123;</span><br><span class="line">    Node&lt;T, V&gt; * node2Insert = <span class="keyword">new</span> Node&lt;T, V&gt;(level, t, v);</span><br><span class="line">    Node&lt;T, V&gt; * node = head;</span><br><span class="line">    <span class="comment">//待插入数据每个level的前驱节点</span></span><br><span class="line">    Node&lt;T, V&gt; *update[level];</span><br><span class="line">    <span class="built_in">memset</span>(update, <span class="number">0</span> ,<span class="keyword">sizeof</span>(<span class="keyword">void</span> *) *level);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> l = level - <span class="number">1</span> ; l &gt;= <span class="number">0</span>; --l) &#123;</span><br><span class="line">        <span class="comment">// 如果当前节点的l层没有后继,则跳过</span></span><br><span class="line">        <span class="keyword">while</span> (node-&gt;nodes[l] &amp;&amp; node-&gt;nodes[l]-&gt;t &lt; t)&#123;</span><br><span class="line">            node = node-&gt;nodes[l];</span><br><span class="line">        &#125;</span><br><span class="line">        update[l] = node;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> totalLevel = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (totalLevel &lt; level &amp;&amp; rand()%<span class="number">2</span>) &#123;</span><br><span class="line">        ++totalLevel;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; totalLevel; ++i) &#123;</span><br><span class="line">        node2Insert-&gt;nodes[i] = update[i]-&gt;nodes[i];</span><br><span class="line">        update[i]-&gt;nodes[i] = node2Insert;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Node&lt;T, V&gt; * findNode(T t) &#123;</span><br><span class="line">    Node&lt;T, V&gt; * node = head;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> l = level - <span class="number">1</span> ; l &gt;= <span class="number">0</span>; --l) &#123;</span><br><span class="line">        <span class="keyword">while</span> (node-&gt;nodes[l] &amp;&amp; node-&gt;nodes[l]-&gt;t &lt; t)&#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"goon"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">            node = node-&gt;nodes[l];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (node-&gt;nodes[l]) &#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; node-&gt;nodes[l]-&gt;t &lt;&lt; l &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (node-&gt;nodes[l] &amp;&amp; !(node-&gt;nodes[l]-&gt;t &lt; t) &amp;&amp; !(t &lt;node-&gt;nodes[l]-&gt;t)) &#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"find inner"</span> &lt;&lt; node-&gt;nodes[l]-&gt;t &lt;&lt; l &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">            <span class="keyword">return</span> node-&gt;nodes[l];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">update</span><span class="params">(<span class="keyword">const</span> T &amp;t, <span class="keyword">const</span> V &amp;v)</span> </span>&#123;</span><br><span class="line">    Node&lt;T, V&gt; * node = findNode(t);</span><br><span class="line">    <span class="keyword">if</span> (!node) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    node-&gt;v = v;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">remove</span><span class="params">(<span class="keyword">const</span> T &amp;t)</span> </span>&#123;</span><br><span class="line">    Node&lt;T, V&gt; *update[level];</span><br><span class="line">    <span class="built_in">memset</span>(update, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">void</span>*) * level);</span><br><span class="line">    Node&lt;T,V&gt;* node = head;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = level - <span class="number">1</span>; i &gt;=<span class="number">0</span>; --i) &#123;</span><br><span class="line">        <span class="keyword">while</span>(node-&gt;nodes[i] &amp;&amp; node-&gt;nodes[i]-&gt;t &lt; t) &#123;</span><br><span class="line">            node = node-&gt;nodes[i];</span><br><span class="line">        &#125;</span><br><span class="line">        update[i] = node; </span><br><span class="line">    &#125;</span><br><span class="line">    Node&lt;T,V&gt; *toDelete = update[<span class="number">0</span>]-&gt;nodes[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span> (!toDelete || toDelete-&gt;t != t) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i =<span class="number">0</span> ; i &lt; level; ++i) &#123;</span><br><span class="line">        update[i]-&gt;nodes[i] = toDelete-&gt;nodes[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(toDelete-&gt;nodes);</span><br><span class="line">    <span class="built_in">free</span>(toDelete);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">debug</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Node&lt;T,V&gt; * node = head;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"debug::start"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">while</span> (node) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span>&lt;&lt; node-&gt;t &lt;&lt; <span class="string">":"</span> &lt;&lt; node-&gt;v &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        node = node-&gt;nodes[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"debug::stop"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/linux/pthread/futex/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/linux/pthread/futex/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="futex-源码分析"><a href="#futex-源码分析" class="headerlink" title="futex 源码分析"></a>futex 源码分析</h1><h2 id="futex数据结构"><a href="#futex数据结构" class="headerlink" title="futex数据结构"></a>futex数据结构</h2><p>futex_q futex等待队列</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct futex_q - The hashed futex queue entry, one per waiting task</span></span><br><span class="line"><span class="comment"> * @task:       the task waiting on the futex</span></span><br><span class="line"><span class="comment"> * @lock_ptr:       the hash bucket lock</span></span><br><span class="line"><span class="comment"> * @key:        the key the futex is hashed on</span></span><br><span class="line"><span class="comment"> * @pi_state:       optional priority inheritance state</span></span><br><span class="line"><span class="comment"> * @rt_waiter:      rt_waiter storage for use with requeue_pi</span></span><br><span class="line"><span class="comment"> * @requeue_pi_key: the requeue_pi target futex key</span></span><br><span class="line"><span class="comment"> * @bitset:     bitset for the optional bitmasked wakeup</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * We use this hashed waitqueue, instead of a normal wait_queue_t, so</span></span><br><span class="line"><span class="comment"> * we can wake only the relevant ones (hashed queues may be shared).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * A futex_q has a woken state, just like tasks have TASK_RUNNING.</span></span><br><span class="line"><span class="comment"> * It is considered woken when plist_node_empty(&amp;q-&gt;list) || q-&gt;lock_ptr == 0.</span></span><br><span class="line"><span class="comment"> * The order of wakup is always to make the first condition true, then</span></span><br><span class="line"><span class="comment"> * the second.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * PI futexes are typically woken before they are removed from the hash list via</span></span><br><span class="line"><span class="comment"> * the rt_mutex code. See unqueue_me_pi().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">futex_q</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">plist_node</span> <span class="title">list</span>;</span></span><br><span class="line">  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">task</span>;</span></span><br><span class="line">    <span class="keyword">spinlock_t</span> *lock_ptr;</span><br><span class="line">    <span class="keyword">union</span> futex_key key;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">futex_pi_state</span> *<span class="title">pi_state</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rt_mutex_waiter</span> *<span class="title">rt_waiter</span>;</span></span><br><span class="line">    <span class="keyword">union</span> futex_key *requeue_pi_key;</span><br><span class="line">    u32 <span class="built_in">bitset</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">union</span> futex_key &#123;                                                 </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> pgoff;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span>;</span></span><br><span class="line">        <span class="keyword">int</span> offset;</span><br><span class="line">    &#125; shared;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="comment">// 用户态futex 地址</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> address;</span><br><span class="line">        <span class="comment">// addr 所在mm</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span>;</span></span><br><span class="line">        <span class="comment">// 用户态地址页内偏移</span></span><br><span class="line">        <span class="keyword">int</span> offset;</span><br><span class="line">    &#125; <span class="keyword">private</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> word;</span><br><span class="line">        <span class="keyword">void</span> *ptr;</span><br><span class="line">        <span class="keyword">int</span> offset;</span><br><span class="line">    &#125; both;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*              </span></span><br><span class="line"><span class="comment"> * Hash buckets are shared by all the futex_keys that hash to the same</span></span><br><span class="line"><span class="comment"> * location.  Each key may have multiple futex_q structures, one for each task</span></span><br><span class="line"><span class="comment"> * waiting on a futex.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">futex_hash_bucket</span> &#123;</span></span><br><span class="line">    <span class="keyword">spinlock_t</span> lock;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">plist_head</span> <span class="title">chain</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">futex_hash_bucket</span> <span class="title">futex_queues</span>[1&lt;&lt;FUTEX_HASHBITS];</span></span><br></pre></td></tr></table></figure>

<h2 id="futex-流程"><a href="#futex-流程" class="headerlink" title="futex 流程"></a>futex 流程</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">futex_wait</span><span class="params">(u32 __user *uaddr, <span class="keyword">int</span> fshared,</span></span></span><br><span class="line"><span class="function"><span class="params">              u32 val, <span class="keyword">ktime_t</span> *abs_time, u32 <span class="built_in">bitset</span>, <span class="keyword">int</span> clockrt)</span></span></span><br><span class="line"><span class="function"></span>&#123;   <span class="comment">// 高精度定时器</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hrtimer_sleeper</span> <span class="title">timeout</span>, *<span class="title">to</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">restart_block</span> *<span class="title">restart</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">futex_hash_bucket</span> *<span class="title">hb</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">futex_q</span> <span class="title">q</span>;</span></span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">           </span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">bitset</span>)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">           </span><br><span class="line">    q.pi_state = <span class="literal">NULL</span>;</span><br><span class="line">    q.<span class="built_in">bitset</span> = <span class="built_in">bitset</span>;</span><br><span class="line">    q.rt_waiter = <span class="literal">NULL</span>;</span><br><span class="line">    q.requeue_pi_key = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 设置等待超时</span></span><br><span class="line">    <span class="keyword">if</span> (abs_time) &#123;</span><br><span class="line">        to = &amp;timeout;</span><br><span class="line">           </span><br><span class="line">        hrtimer_init_on_stack(&amp;to-&gt;timer, clockrt ? CLOCK_REALTIME :</span><br><span class="line">                      CLOCK_MONOTONIC, HRTIMER_MODE_ABS);</span><br><span class="line">        hrtimer_init_sleeper(to, current);</span><br><span class="line">        hrtimer_set_expires_range_ns(&amp;to-&gt;timer, *abs_time,</span><br><span class="line">                         current-&gt;timer_slack_ns);</span><br><span class="line">    &#125;      </span><br><span class="line">           </span><br><span class="line">retry:     </span><br><span class="line">    <span class="comment">/* Prepare to wait on uaddr. */</span></span><br><span class="line">    ret = futex_wait_setup(uaddr, val, fshared, &amp;q, &amp;hb);</span><br><span class="line">    <span class="comment">// 用户态数据已经和val一致</span></span><br><span class="line">    <span class="keyword">if</span> (ret)</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">           </span><br><span class="line">    <span class="comment">/* queue_me and wait for wakeup, timeout, or a signal. */</span></span><br><span class="line">    futex_wait_queue_me(hb, &amp;q, to);</span><br><span class="line">           </span><br><span class="line">    <span class="comment">/* If we were woken (and unqueued), we succeeded, whatever. */</span></span><br><span class="line">    ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!unqueue_me(&amp;q))</span><br><span class="line">        <span class="keyword">goto</span> out_put_key;</span><br><span class="line">    ret = -ETIMEDOUT;</span><br><span class="line">    <span class="keyword">if</span> (to &amp;&amp; !to-&gt;task)</span><br><span class="line">        <span class="keyword">goto</span> out_put_key;</span><br><span class="line">           </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * We expect signal_pending(current), but we might be the</span></span><br><span class="line"><span class="comment">     * victim of a spurious wakeup as well.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">         <span class="keyword">if</span> (!signal_pending(current)) &#123;</span><br><span class="line">        put_futex_key(fshared, &amp;q.key);</span><br><span class="line">        <span class="keyword">goto</span> retry;                                                                                                                                                                                                </span><br><span class="line">    &#125;    </span><br><span class="line">         </span><br><span class="line">    ret = -ERESTARTSYS;</span><br><span class="line">    <span class="keyword">if</span> (!abs_time)</span><br><span class="line">        <span class="keyword">goto</span> out_put_key;</span><br><span class="line">         </span><br><span class="line">    restart = &amp;current_thread_info()-&gt;restart_block;</span><br><span class="line">    restart-&gt;fn = futex_wait_restart;</span><br><span class="line">    restart-&gt;futex.uaddr = (u32 *)uaddr;</span><br><span class="line">    restart-&gt;futex.val = val;</span><br><span class="line">    restart-&gt;futex.time = abs_time-&gt;tv64;</span><br><span class="line">    restart-&gt;futex.<span class="built_in">bitset</span> = <span class="built_in">bitset</span>;</span><br><span class="line">    restart-&gt;futex.flags = FLAGS_HAS_TIMEOUT;</span><br><span class="line">         </span><br><span class="line">    <span class="keyword">if</span> (fshared)</span><br><span class="line">        restart-&gt;futex.flags |= FLAGS_SHARED;</span><br><span class="line">    <span class="keyword">if</span> (clockrt)</span><br><span class="line">        restart-&gt;futex.flags |= FLAGS_CLOCKRT;</span><br><span class="line">         </span><br><span class="line">    ret = -ERESTART_RESTARTBLOCK;</span><br><span class="line">         </span><br><span class="line">out_put_key:</span><br><span class="line">    put_futex_key(fshared, &amp;q.key);</span><br><span class="line">out:     </span><br><span class="line">    <span class="keyword">if</span> (to) &#123;</span><br><span class="line">        hrtimer_cancel(&amp;to-&gt;timer);</span><br><span class="line">        destroy_hrtimer_on_stack(&amp;to-&gt;timer);</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**                                                                  </span></span><br><span class="line"><span class="comment"> * futex_wait_setup() - Prepare to wait on a futex</span></span><br><span class="line"><span class="comment"> * @uaddr:  the futex userspace address</span></span><br><span class="line"><span class="comment"> * @val:    the expected value</span></span><br><span class="line"><span class="comment"> * @fshared:    whether the futex is shared (1) or not (0)</span></span><br><span class="line"><span class="comment"> * @q:      the associated futex_q</span></span><br><span class="line"><span class="comment"> * @hb:     storage for hash_bucket pointer to be returned to caller</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Setup the futex_q and locate the hash_bucket.  Get the futex value and</span></span><br><span class="line"><span class="comment"> * compare it with the expected value.  Handle atomic faults internally.</span></span><br><span class="line"><span class="comment"> * Return with the hb lock held and a q.key reference on success, and unlocked</span></span><br><span class="line"><span class="comment"> * with no q.key reference on failure.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Returns:</span></span><br><span class="line"><span class="comment"> *  0 - uaddr contains val and hb has been locked</span></span><br><span class="line"><span class="comment"> * &lt;1 - -EFAULT or -EWOULDBLOCK (uaddr does not contain val) and hb is unlcoked</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">futex_wait_setup</span><span class="params">(u32 __user *uaddr, u32 val, <span class="keyword">int</span> fshared,</span></span></span><br><span class="line"><span class="function"><span class="params">               struct futex_q *q, struct futex_hash_bucket **hb)</span></span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    u32 uval;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Access the page AFTER the hash-bucket is locked.</span></span><br><span class="line"><span class="comment">     * Order is important:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *   Userspace waiter: val = var; if (cond(val)) futex_wait(&amp;var, val);</span></span><br><span class="line"><span class="comment">     *   Userspace waker:  if (cond(var)) &#123; var = new; futex_wake(&amp;var); &#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * The basic logical guarantee of a futex is that it blocks ONLY</span></span><br><span class="line"><span class="comment">     * if cond(var) is known to be true at the time of blocking, for</span></span><br><span class="line"><span class="comment">     * any cond.  If we queued after testing *uaddr, that would open</span></span><br><span class="line"><span class="comment">     * a race condition where we could block indefinitely with</span></span><br><span class="line"><span class="comment">     * cond(var) false, which would violate the guarantee.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * A consequence is that futex_wait() can return zero and absorb</span></span><br><span class="line"><span class="comment">     * a wakeup when *uaddr != val on entry to the syscall.  This is</span></span><br><span class="line"><span class="comment">     * rare, but normal.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">retry:</span><br><span class="line">    <span class="comment">// 初始化所有值为0</span></span><br><span class="line">    q-&gt;key = FUTEX_KEY_INIT;</span><br><span class="line">    <span class="comment">// 初始化futex_key</span></span><br><span class="line">    ret = get_futex_key(uaddr, fshared, &amp;q-&gt;key);</span><br><span class="line">    <span class="keyword">if</span> (unlikely(ret != <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">       </span><br><span class="line">retry_private:</span><br><span class="line">    <span class="comment">// 初始化q-&gt;lock_ptr，并加锁</span></span><br><span class="line">    *hb = queue_lock(q);</span><br><span class="line">    <span class="comment">// 关闭缺页中断，复制用户态值uaddr到uval</span></span><br><span class="line">    ret = get_futex_value_locked(&amp;uval, uaddr);</span><br><span class="line">    <span class="comment">// 失败</span></span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        queue_unlock(q, *hb);</span><br><span class="line">       <span class="comment">// 重试</span></span><br><span class="line">        ret = get_user(uval, uaddr);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">       <span class="comment">// 单进程的锁</span></span><br><span class="line">        <span class="keyword">if</span> (!fshared)</span><br><span class="line">            <span class="keyword">goto</span> retry_private;</span><br><span class="line">       </span><br><span class="line">        put_futex_key(fshared, &amp;q-&gt;key);</span><br><span class="line">        <span class="keyword">goto</span> retry;</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">// 用户态数据不等于expect 的val</span></span><br><span class="line">    <span class="keyword">if</span> (uval != val) &#123;</span><br><span class="line">        queue_unlock(q, *hb);</span><br><span class="line">        ret = -EWOULDBLOCK;</span><br><span class="line">    &#125;  </span><br><span class="line">       </span><br><span class="line">out:   </span><br><span class="line">    <span class="keyword">if</span> (ret)</span><br><span class="line">        put_futex_key(fshared, &amp;q-&gt;key);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * get_futex_key() - Get parameters which are the keys for a futex</span></span><br><span class="line"><span class="comment"> * @uaddr:	virtual address of the futex</span></span><br><span class="line"><span class="comment"> * @fshared:	0 for a PROCESS_PRIVATE futex, 1 for PROCESS_SHARED</span></span><br><span class="line"><span class="comment"> * @key:	address where result is stored.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Returns a negative error code or 0</span></span><br><span class="line"><span class="comment"> * The key words are stored in *key on success.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * For shared mappings, it's (page-&gt;index, vma-&gt;vm_file-&gt;f_path.dentry-&gt;d_inode,</span></span><br><span class="line"><span class="comment"> * offset_within_page).  For private mappings, it's (uaddr, current-&gt;mm).</span></span><br><span class="line"><span class="comment"> * We can usually work out the index without swapping in the page.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * lock_page() might sleep, the caller should not hold a spinlock.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">get_futex_key(u32 __user *uaddr, <span class="keyword">int</span> fshared, <span class="keyword">union</span> futex_key *key)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> address = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)uaddr;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> = <span class="title">current</span>-&gt;<span class="title">mm</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The futex address must be "naturally" aligned.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	key-&gt;both.offset = address % PAGE_SIZE;</span><br><span class="line">	<span class="keyword">if</span> (unlikely((address % <span class="keyword">sizeof</span>(u32)) != <span class="number">0</span>))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	address -= key-&gt;both.offset;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * PROCESS_PRIVATE futexes are fast.</span></span><br><span class="line"><span class="comment">	 * As the mm cannot disappear under us and the 'key' only needs</span></span><br><span class="line"><span class="comment">	 * virtual address, we dont even have to find the underlying vma.</span></span><br><span class="line"><span class="comment">	 * Note : We do have to check 'uaddr' is a valid user address,</span></span><br><span class="line"><span class="comment">	 *        but access_ok() should be faster than find_vma()</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (!fshared) &#123;</span><br><span class="line">		<span class="keyword">if</span> (unlikely(!access_ok(VERIFY_WRITE, uaddr, <span class="keyword">sizeof</span>(u32))))</span><br><span class="line">			<span class="keyword">return</span> -EFAULT;</span><br><span class="line">		key-&gt;<span class="keyword">private</span>.mm = mm;</span><br><span class="line">		key-&gt;<span class="keyword">private</span>.address = address;</span><br><span class="line">		get_futex_key_refs(key);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">again:</span><br><span class="line">	err = get_user_pages_fast(address, <span class="number">1</span>, <span class="number">1</span>, &amp;page);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	page = compound_head(page);</span><br><span class="line">	lock_page(page);</span><br><span class="line">	<span class="keyword">if</span> (!page-&gt;mapping) &#123;</span><br><span class="line">		unlock_page(page);</span><br><span class="line">		put_page(page);</span><br><span class="line">		<span class="keyword">goto</span> again;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Private mappings are handled in a simple way.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">NOTE:</span> When userspace waits on a MAP_SHARED mapping, even if</span></span><br><span class="line"><span class="comment">	 * it's a read-only handle, it's expected that futexes attach to</span></span><br><span class="line"><span class="comment">	 * the object not the particular process.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (PageAnon(page)) &#123;</span><br><span class="line">		key-&gt;both.offset |= FUT_OFF_MMSHARED; <span class="comment">/* ref taken on mm */</span></span><br><span class="line">		key-&gt;<span class="keyword">private</span>.mm = mm;</span><br><span class="line">		key-&gt;<span class="keyword">private</span>.address = address;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		key-&gt;both.offset |= FUT_OFF_INODE; <span class="comment">/* inode-based key */</span></span><br><span class="line">		key-&gt;shared.inode = page-&gt;mapping-&gt;host;</span><br><span class="line">		key-&gt;shared.pgoff = page-&gt;index;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	get_futex_key_refs(key);</span><br><span class="line"></span><br><span class="line">	unlock_page(page);</span><br><span class="line">	put_page(page);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*           </span></span><br><span class="line"><span class="comment"> * Take a reference to the resource addressed by a key.</span></span><br><span class="line"><span class="comment"> * Can be called while holding spinlocks.</span></span><br><span class="line"><span class="comment"> *           </span></span><br><span class="line"><span class="comment"> */</span>          </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">get_futex_key_refs</span><span class="params">(<span class="keyword">union</span> futex_key *key)</span></span></span><br><span class="line"><span class="function"></span>&#123;            </span><br><span class="line">    <span class="keyword">if</span> (!key-&gt;both.ptr)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">             </span><br><span class="line">    <span class="keyword">switch</span> (key-&gt;both.offset &amp; (FUT_OFF_INODE|FUT_OFF_MMSHARED)) &#123;</span><br><span class="line">    <span class="keyword">case</span> FUT_OFF_INODE:</span><br><span class="line">        atomic_inc(&amp;key-&gt;shared.inode-&gt;i_count);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> FUT_OFF_MMSHARED:</span><br><span class="line">        atomic_inc(&amp;key-&gt;<span class="keyword">private</span>.mm-&gt;mm_count);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We hash on the keys returned from get_futex_key (see below).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct futex_hash_bucket *<span class="title">hash_futex</span><span class="params">(<span class="keyword">union</span> futex_key *key)</span>                                                                                                                                                  </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    u32 hash = jhash2((u32*)&amp;key-&gt;both.word,</span><br><span class="line">              (<span class="keyword">sizeof</span>(key-&gt;both.word)+<span class="keyword">sizeof</span>(key-&gt;both.ptr))/<span class="number">4</span>,</span><br><span class="line">              key-&gt;both.offset);</span><br><span class="line">    <span class="keyword">return</span> &amp;futex_queues[hash &amp; ((<span class="number">1</span> &lt;&lt; FUTEX_HASHBITS)<span class="number">-1</span>)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * futex_wait_queue_me() - queue_me() and wait for wakeup, timeout, or signal</span></span><br><span class="line"><span class="comment"> * @hb:     the futex hash bucket, must be locked by the caller</span></span><br><span class="line"><span class="comment"> * @q:      the futex_q to queue up on</span></span><br><span class="line"><span class="comment"> * @timeout:    the prepared hrtimer_sleeper, or null for no timeout</span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">futex_wait_queue_me</span><span class="params">(struct futex_hash_bucket *hb, struct futex_q *q,</span></span></span><br><span class="line"><span class="function"><span class="params">                struct hrtimer_sleeper *timeout)</span></span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * The task state is guaranteed to be set before another task can</span></span><br><span class="line"><span class="comment">     * wake it. set_current_state() is implemented using set_mb() and</span></span><br><span class="line"><span class="comment">     * queue_me() calls spin_unlock() upon completion, both serializing</span></span><br><span class="line"><span class="comment">     * access to the hash list and forcing another memory barrier.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    set_current_state(TASK_INTERRUPTIBLE);</span><br><span class="line">    <span class="comment">// 将current 挂载到hb中</span></span><br><span class="line">    queue_me(q, hb);</span><br><span class="line">     </span><br><span class="line">    <span class="comment">/* Arm the timer */</span></span><br><span class="line">    <span class="keyword">if</span> (timeout) &#123;</span><br><span class="line">        hrtimer_start_expires(&amp;timeout-&gt;timer, HRTIMER_MODE_ABS);</span><br><span class="line">        <span class="keyword">if</span> (!hrtimer_active(&amp;timeout-&gt;timer))</span><br><span class="line">            timeout-&gt;task = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;  </span><br><span class="line">     </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If we have been removed from the hash list, then another task</span></span><br><span class="line"><span class="comment">     * has tried to wake us, and we can skip the call to schedule().</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (likely(!plist_node_empty(&amp;q-&gt;<span class="built_in">list</span>))) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * If the timer has already expired, current will already be</span></span><br><span class="line"><span class="comment">         * flagged for rescheduling. Only call schedule if there</span></span><br><span class="line"><span class="comment">         * is no timeout, or if it has yet to expire.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (!timeout || timeout-&gt;task)</span><br><span class="line">            schedule();</span><br><span class="line">    &#125;</span><br><span class="line">    __set_current_state(TASK_RUNNING);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将current 挂载到hb中</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">queue_me</span><span class="params">(struct futex_q *q, struct futex_hash_bucket *hb)</span></span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">int</span> prio;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * The priority used to register this element is</span></span><br><span class="line"><span class="comment">     * - either the real thread-priority for the real-time threads</span></span><br><span class="line"><span class="comment">     * (i.e. threads with a priority lower than MAX_RT_PRIO)</span></span><br><span class="line"><span class="comment">     * - or MAX_RT_PRIO for non-RT threads.</span></span><br><span class="line"><span class="comment">     * Thus, all RT-threads are woken first in priority order, and</span></span><br><span class="line"><span class="comment">     * the others are woken last, in FIFO order.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    prio = min(current-&gt;normal_prio, MAX_RT_PRIO);</span><br><span class="line">   </span><br><span class="line">    plist_node_init(&amp;q-&gt;<span class="built_in">list</span>, prio);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_PI_LIST</span></span><br><span class="line">    q-&gt;<span class="built_in">list</span>.plist.spinlock = &amp;hb-&gt;lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    plist_add(&amp;q-&gt;<span class="built_in">list</span>, &amp;hb-&gt;chain);</span><br><span class="line">    q-&gt;task = current;</span><br><span class="line">    spin_unlock(&amp;hb-&gt;lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">unqueue_me</span><span class="params">(struct futex_q *q)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="keyword">spinlock_t</span> *lock_ptr;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* In the common case we don't take the spinlock, which is nice. */</span></span><br><span class="line">retry:</span><br><span class="line">    lock_ptr = q-&gt;lock_ptr;</span><br><span class="line">    barrier();</span><br><span class="line">    <span class="keyword">if</span> (lock_ptr != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        spin_lock(lock_ptr);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * q-&gt;lock_ptr can change between reading it and</span></span><br><span class="line"><span class="comment">         * spin_lock(), causing us to take the wrong lock.  This</span></span><br><span class="line"><span class="comment">         * corrects the race condition.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Reasoning goes like this: if we have the wrong lock,</span></span><br><span class="line"><span class="comment">         * q-&gt;lock_ptr must have changed (maybe several times)</span></span><br><span class="line"><span class="comment">         * between reading it and the spin_lock().  It can</span></span><br><span class="line"><span class="comment">         * change again after the spin_lock() but only if it was</span></span><br><span class="line"><span class="comment">         * already changed before the spin_lock().  It cannot,</span></span><br><span class="line"><span class="comment">         * however, change back to the original value.  Therefore                                                                                                                                                  </span></span><br><span class="line"><span class="comment">         * we can detect whether we acquired the correct lock.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (unlikely(lock_ptr != q-&gt;lock_ptr)) &#123;</span><br><span class="line">            spin_unlock(lock_ptr);</span><br><span class="line">            <span class="keyword">goto</span> retry;</span><br><span class="line">        &#125;</span><br><span class="line">        WARN_ON(plist_node_empty(&amp;q-&gt;<span class="built_in">list</span>));</span><br><span class="line">        plist_del(&amp;q-&gt;<span class="built_in">list</span>, &amp;q-&gt;<span class="built_in">list</span>.plist);</span><br><span class="line">    </span><br><span class="line">        BUG_ON(q-&gt;pi_state);</span><br><span class="line">    </span><br><span class="line">        spin_unlock(lock_ptr);</span><br><span class="line">        ret = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    drop_futex_key_refs(&amp;q-&gt;key);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/linux/pthread/pthread_mutex/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/linux/pthread/pthread_mutex/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="pthread-mutex源码分析"><a href="#pthread-mutex源码分析" class="headerlink" title="pthread mutex源码分析"></a>pthread mutex源码分析</h1><h2 id="pthread-mutex-t数据结构"><a href="#pthread-mutex-t数据结构" class="headerlink" title="pthread_mutex_t数据结构"></a>pthread_mutex_t数据结构</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">union</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">pthread_mutex_s</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="comment">// 用户态futex</span></span><br><span class="line">    <span class="keyword">int</span> __lock;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> __count;</span><br><span class="line">    <span class="comment">// 锁拥有者</span></span><br><span class="line">    <span class="keyword">int</span> __owner;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __x86_64__</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> __nusers;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* KIND must stay at this position in the structure to maintain</span></span><br><span class="line"><span class="comment">       binary compatibility.  */</span></span><br><span class="line">    <span class="keyword">int</span> __kind;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __x86_64__</span></span><br><span class="line">    <span class="keyword">short</span> __spins;</span><br><span class="line">    <span class="keyword">short</span> __elision;</span><br><span class="line">    <span class="keyword">__pthread_list_t</span> __list;</span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> __PTHREAD_MUTEX_HAVE_PREV	1</span></span><br><span class="line"><span class="comment">/* Mutex __spins initializer used by PTHREAD_MUTEX_INITIALIZER.  */</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> __PTHREAD_SPINS             0, 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> __nusers;</span><br><span class="line">    __extension__ <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">      &#123;</span></span><br><span class="line">	<span class="keyword">short</span> __espins;</span><br><span class="line">	<span class="keyword">short</span> __elision;</span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> __spins __elision_data.__espins</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> __elision __elision_data.__elision</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> __PTHREAD_SPINS         &#123; 0, 0 &#125;</span></span><br><span class="line">      &#125; __elision_data;</span><br><span class="line">      <span class="keyword">__pthread_slist_t</span> __list;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  &#125; __data;</span><br><span class="line">  <span class="keyword">char</span> __size[__SIZEOF_PTHREAD_MUTEX_T];</span><br><span class="line">  <span class="keyword">long</span> <span class="keyword">int</span> __align;</span><br><span class="line">&#125; <span class="keyword">pthread_mutex_t</span>;</span><br></pre></td></tr></table></figure>

<p>核心数据结构：</p>
<h2 id="pthread-mutex-lock"><a href="#pthread-mutex-lock" class="headerlink" title="pthread_mutex_lock"></a>pthread_mutex_lock</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">__pthread_mutex_lock (<span class="keyword">pthread_mutex_t</span> *mutex)</span><br><span class="line">&#123;</span><br><span class="line">  assert (<span class="keyword">sizeof</span> (mutex-&gt;__size) &gt;= <span class="keyword">sizeof</span> (mutex-&gt;__data));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> type = PTHREAD_MUTEX_TYPE_ELISION (mutex);</span><br><span class="line"></span><br><span class="line">  LIBC_PROBE (mutex_entry, <span class="number">1</span>, mutex);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (type &amp; ~(PTHREAD_MUTEX_KIND_MASK_NP</span><br><span class="line">				 | PTHREAD_MUTEX_ELISION_FLAGS_NP), <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> __pthread_mutex_lock_full (mutex);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__glibc_likely (type == PTHREAD_MUTEX_TIMED_NP))</span><br><span class="line">    &#123;</span><br><span class="line">      FORCE_ELISION (mutex, <span class="keyword">goto</span> elision);</span><br><span class="line">    simple:</span><br><span class="line">      <span class="comment">/* Normal mutex.  */</span></span><br><span class="line">      LLL_MUTEX_LOCK (mutex);</span><br><span class="line">      assert (mutex-&gt;__data.__owner == <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_ELISION</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (__glibc_likely (type == PTHREAD_MUTEX_TIMED_ELISION_NP))</span><br><span class="line">    &#123;</span><br><span class="line">  elision: __attribute__((unused))</span><br><span class="line">      <span class="comment">/* This case can never happen on a system without elision,</span></span><br><span class="line"><span class="comment">         as the mutex type initialization functions will not</span></span><br><span class="line"><span class="comment">	 allow to set the elision flags.  */</span></span><br><span class="line">      <span class="comment">/* Don't record owner or users for elision case.  This is a</span></span><br><span class="line"><span class="comment">         tail call.  */</span></span><br><span class="line">      <span class="keyword">return</span> LLL_MUTEX_LOCK_ELISION (mutex);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (__builtin_expect (PTHREAD_MUTEX_TYPE (mutex)</span><br><span class="line">			     == PTHREAD_MUTEX_RECURSIVE_NP, <span class="number">1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Recursive mutex.  */</span></span><br><span class="line">      <span class="keyword">pid_t</span> id = THREAD_GETMEM (THREAD_SELF, tid);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Check whether we already hold the mutex.  */</span></span><br><span class="line">      <span class="keyword">if</span> (mutex-&gt;__data.__owner == id)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="comment">/* Just bump the counter.  */</span></span><br><span class="line">	  <span class="keyword">if</span> (__glibc_unlikely (mutex-&gt;__data.__count + <span class="number">1</span> == <span class="number">0</span>))</span><br><span class="line">	    <span class="comment">/* Overflow of the counter.  */</span></span><br><span class="line">	    <span class="keyword">return</span> EAGAIN;</span><br><span class="line"></span><br><span class="line">	  ++mutex-&gt;__data.__count;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* We have to get the mutex.  */</span></span><br><span class="line">      LLL_MUTEX_LOCK (mutex);</span><br><span class="line"></span><br><span class="line">      assert (mutex-&gt;__data.__owner == <span class="number">0</span>);</span><br><span class="line">      mutex-&gt;__data.__count = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (__builtin_expect (PTHREAD_MUTEX_TYPE (mutex)</span><br><span class="line">			  == PTHREAD_MUTEX_ADAPTIVE_NP, <span class="number">1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (! __is_smp)</span><br><span class="line">	<span class="keyword">goto</span> simple;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (LLL_MUTEX_TRYLOCK (mutex) != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">	  <span class="keyword">int</span> max_cnt = MIN (MAX_ADAPTIVE_COUNT,</span><br><span class="line">			     mutex-&gt;__data.__spins * <span class="number">2</span> + <span class="number">10</span>);</span><br><span class="line">	  <span class="keyword">do</span></span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="keyword">if</span> (cnt++ &gt;= max_cnt)</span><br><span class="line">		&#123;</span><br><span class="line">		  LLL_MUTEX_LOCK (mutex);</span><br><span class="line">		  <span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	      atomic_spin_nop ();</span><br><span class="line">	    &#125;</span><br><span class="line">	  <span class="keyword">while</span> (LLL_MUTEX_TRYLOCK (mutex) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	  mutex-&gt;__data.__spins += (cnt - mutex-&gt;__data.__spins) / <span class="number">8</span>;</span><br><span class="line">	&#125;</span><br><span class="line">      assert (mutex-&gt;__data.__owner == <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">pid_t</span> id = THREAD_GETMEM (THREAD_SELF, tid);</span><br><span class="line">      assert (PTHREAD_MUTEX_TYPE (mutex) == PTHREAD_MUTEX_ERRORCHECK_NP);</span><br><span class="line">      <span class="comment">/* Check whether we already hold the mutex.  */</span></span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (mutex-&gt;__data.__owner == id))</span><br><span class="line">	<span class="keyword">return</span> EDEADLK;</span><br><span class="line">      <span class="keyword">goto</span> simple;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">pid_t</span> id = THREAD_GETMEM (THREAD_SELF, tid);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> lll_lock(futex, private) \</span></span><br><span class="line">  (<span class="keyword">void</span>)                                      \</span><br><span class="line">    (&#123; <span class="keyword">int</span> ignore1, ignore2, ignore3;                         \</span><br><span class="line">       <span class="keyword">if</span> (__builtin_constant_p (<span class="keyword">private</span>) &amp;&amp; (<span class="keyword">private</span>) == LLL_PRIVATE)        \</span><br><span class="line">     __asm __volatile (__lll_lock_asm_start                   \</span><br><span class="line">               <span class="string">".subsection 1\n\t"</span>                    \</span><br><span class="line">               <span class="string">".type _L_lock_%=, @function\n"</span>            \</span><br><span class="line">               <span class="string">"_L_lock_%=:\n"</span>                    \</span><br><span class="line">               <span class="string">"1:\tlea %2, %%"</span> RDI_LP <span class="string">"\n"</span>               \</span><br><span class="line">               <span class="string">"2:\tsub $128, %%"</span> RSP_LP <span class="string">"\n"</span>             \</span><br><span class="line">               <span class="string">"3:\tcallq __lll_lock_wait_private\n"</span>          \</span><br><span class="line">               <span class="string">"4:\tadd $128, %%"</span> RSP_LP <span class="string">"\n"</span>             \</span><br><span class="line">               <span class="string">"5:\tjmp 24f\n"</span>                    \</span><br><span class="line">               <span class="string">"6:\t.size _L_lock_%=, 6b-1b\n\t"</span>              \</span><br><span class="line">               <span class="string">".previous\n"</span>                      \</span><br><span class="line">               LLL_STUB_UNWIND_INFO_5                 \</span><br><span class="line">               <span class="string">"24:"</span>                          \</span><br><span class="line">               : <span class="string">"=S"</span> (ignore1), <span class="string">"=&amp;D"</span> (ignore2), <span class="string">"=m"</span> (futex),   \</span><br><span class="line">                 <span class="string">"=a"</span> (ignore3)                   \</span><br><span class="line">               : <span class="string">"0"</span> (<span class="number">1</span>), <span class="string">"m"</span> (futex), <span class="string">"3"</span> (<span class="number">0</span>)            \</span><br><span class="line">               : <span class="string">"cx"</span>, <span class="string">"r11"</span>, <span class="string">"cc"</span>, <span class="string">"memory"</span>);            \</span><br><span class="line">       <span class="keyword">else</span>                                   \</span><br><span class="line">     __asm __volatile (__lll_lock_asm_start                   \</span><br><span class="line">               <span class="string">".subsection 1\n\t"</span>                    \</span><br><span class="line">               <span class="string">".type _L_lock_%=, @function\n"</span>            \</span><br><span class="line">               <span class="string">"_L_lock_%=:\n"</span>                    \</span><br><span class="line">               <span class="string">"1:\tlea %2, %%"</span> RDI_LP <span class="string">"\n"</span>               \</span><br><span class="line">               <span class="string">"2:\tsub $128, %%"</span> RSP_LP <span class="string">"\n"</span>             \</span><br><span class="line">               <span class="string">"3:\tcallq __lll_lock_wait\n"</span>              \</span><br><span class="line">               <span class="string">"4:\tadd $128, %%"</span> RSP_LP <span class="string">"\n"</span>             \</span><br><span class="line">               <span class="string">"5:\tjmp 24f\n"</span>                    \</span><br><span class="line">               <span class="string">"6:\t.size _L_lock_%=, 6b-1b\n\t"</span>              \</span><br><span class="line">               <span class="string">".previous\n"</span>                      \</span><br><span class="line">               LLL_STUB_UNWIND_INFO_5                 \</span><br><span class="line">               <span class="string">"24:"</span>                          \</span><br><span class="line">               : <span class="string">"=S"</span> (ignore1), <span class="string">"=D"</span> (ignore2), <span class="string">"=m"</span> (futex),    \</span><br><span class="line">                 <span class="string">"=a"</span> (ignore3)                   \</span><br><span class="line">               : <span class="string">"1"</span> (<span class="number">1</span>), <span class="string">"m"</span> (futex), <span class="string">"3"</span> (<span class="number">0</span>), <span class="string">"0"</span> (<span class="keyword">private</span>)     \</span><br><span class="line">               : <span class="string">"cx"</span>, <span class="string">"r11"</span>, <span class="string">"cc"</span>, <span class="string">"memory"</span>);            \</span><br><span class="line">    &#125;)</span><br><span class="line">  <span class="comment">/* Record the ownership.  */</span></span><br><span class="line">  mutex-&gt;__data.__owner = id;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> NO_INCR</span></span><br><span class="line">  ++mutex-&gt;__data.__nusers;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  LIBC_PROBE (mutex_acquired, <span class="number">1</span>, mutex);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">#define lll_lock(futex, private) \</span><br><span class="line">  (void)                                      \</span><br><span class="line">    (&#123; int ignore1, ignore2, ignore3;                         \</span><br><span class="line">       if (__builtin_constant_p (private) &amp;&amp; (private) == LLL_PRIVATE)        \</span><br><span class="line">     __asm __volatile (__lll_lock_asm_start                   \</span><br><span class="line">               &quot;.subsection 1\n\t&quot;                    \</span><br><span class="line">               &quot;.type _L_lock_%=, @function\n&quot;            \</span><br><span class="line">               &quot;_L_lock_%=:\n&quot;                    \</span><br><span class="line">               &quot;1:\tlea %2, %%&quot; RDI_LP &quot;\n&quot;               \</span><br><span class="line">               &quot;2:\tsub $128, %%&quot; RSP_LP &quot;\n&quot;             \</span><br><span class="line">               &quot;3:\tcallq __lll_lock_wait_private\n&quot;          \</span><br><span class="line">               &quot;4:\tadd $128, %%&quot; RSP_LP &quot;\n&quot;             \</span><br><span class="line">               &quot;5:\tjmp 24f\n&quot;                    \</span><br><span class="line">               &quot;6:\t.size _L_lock_%=, 6b-1b\n\t&quot;              \</span><br><span class="line">               &quot;.previous\n&quot;                      \</span><br><span class="line">               LLL_STUB_UNWIND_INFO_5                 \</span><br><span class="line">               &quot;24:&quot;                          \</span><br><span class="line">               : &quot;=S&quot; (ignore1), &quot;=&amp;D&quot; (ignore2), &quot;=m&quot; (futex),   \</span><br><span class="line">                 &quot;=a&quot; (ignore3)                   \</span><br><span class="line">               : &quot;0&quot; (1), &quot;m&quot; (futex), &quot;3&quot; (0)            \</span><br><span class="line">               : &quot;cx&quot;, &quot;r11&quot;, &quot;cc&quot;, &quot;memory&quot;);            \</span><br><span class="line">       else                                   \</span><br><span class="line">     __asm __volatile (__lll_lock_asm_start                   \</span><br><span class="line">               &quot;.subsection 1\n\t&quot;                    \</span><br><span class="line">               &quot;.type _L_lock_%=, @function\n&quot;            \</span><br><span class="line">               &quot;_L_lock_%=:\n&quot;                    \</span><br><span class="line">               &quot;1:\tlea %2, %%&quot; RDI_LP &quot;\n&quot;               \</span><br><span class="line">               &quot;2:\tsub $128, %%&quot; RSP_LP &quot;\n&quot;             \</span><br><span class="line">               &quot;3:\tcallq __lll_lock_wait\n&quot;              \</span><br><span class="line">               &quot;4:\tadd $128, %%&quot; RSP_LP &quot;\n&quot;             \</span><br><span class="line">               &quot;5:\tjmp 24f\n&quot;                    \</span><br><span class="line">               &quot;6:\t.size _L_lock_%=, 6b-1b\n\t&quot;              \</span><br><span class="line">               &quot;.previous\n&quot;                      \</span><br><span class="line">               LLL_STUB_UNWIND_INFO_5                 \</span><br><span class="line">               &quot;24:&quot;                          \</span><br><span class="line">               : &quot;=S&quot; (ignore1), &quot;=D&quot; (ignore2), &quot;=m&quot; (futex),    \</span><br><span class="line">                 &quot;=a&quot; (ignore3)                   \</span><br><span class="line">               : &quot;1&quot; (1), &quot;m&quot; (futex), &quot;3&quot; (0), &quot;0&quot; (private)     \</span><br><span class="line">               : &quot;cx&quot;, &quot;r11&quot;, &quot;cc&quot;, &quot;memory&quot;);            \</span><br><span class="line">    &#125;)</span><br><span class="line">```s</span><br><span class="line">__lll_lock_wait:</span><br><span class="line">    cfi_startproc</span><br><span class="line">    pushq   %r10</span><br><span class="line">    cfi_adjust_cfa_offset(8)</span><br><span class="line">    pushq   %rdx</span><br><span class="line">    cfi_adjust_cfa_offset(8)</span><br><span class="line">    cfi_offset(%r10, -16)</span><br><span class="line">    cfi_offset(%rdx, -24)</span><br><span class="line">    xorq    %r10, %r10  /* No timeout.  */</span><br><span class="line">    movl    $2, %edx</span><br><span class="line">    LOAD_FUTEX_WAIT (%esi)</span><br><span class="line">             </span><br><span class="line">    cmpl    %edx, %eax  /* NB:   %edx == 2 */</span><br><span class="line">    jne 2f                                                                                                                                                                                                         </span><br><span class="line">             </span><br><span class="line">1:  LIBC_PROBE (lll_lock_wait, 2, %rdi, %rsi)</span><br><span class="line">    movl    $SYS_futex, %eax</span><br><span class="line">    syscall</span><br><span class="line">             </span><br><span class="line">2:  movl    %edx, %eax</span><br><span class="line">    xchgl   %eax, (%rdi)    /* NB:   lock is implied */</span><br><span class="line">             </span><br><span class="line">    testl   %eax, %eax</span><br><span class="line">    jnz 1b</span><br><span class="line">             </span><br><span class="line">    popq    %rdx</span><br><span class="line">    cfi_adjust_cfa_offset(-8)</span><br><span class="line">    cfi_restore(%rdx)</span><br><span class="line">    popq    %r10</span><br><span class="line">    cfi_adjust_cfa_offset(-8)</span><br><span class="line">    cfi_restore(%r10)</span><br><span class="line">    retq  </span><br><span class="line">    cfi_endproc</span><br><span class="line">    .size   __lll_lock_wait,.-__lll_lock_wait</span><br><span class="line">             </span><br><span class="line">    /*      %rdi: futex</span><br><span class="line">        %rsi: flags</span><br><span class="line">        %rdx: timeout</span><br><span class="line">        %eax: futex value</span><br><span class="line">    */       </span><br><span class="line">    .globl  __lll_timedlock_wait</span><br><span class="line">    .type   __lll_timedlock_wait,@function</span><br><span class="line">    .hidden __lll_timedlock_wait</span><br><span class="line">    .align  16</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/linux/pthread/pthread 初始化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/linux/pthread/pthread 初始化/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="pthread-mutex"><a href="#pthread-mutex" class="headerlink" title="pthread_mutex"></a>pthread_mutex</h1><p>pthread_mutex_lock 在非多线程环境中默认直接返回0</p>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FORWARD2(name, rettype, decl, params, defaction) \</span></span><br><span class="line">rettype                                       \        </span><br><span class="line">name decl                                     \        </span><br><span class="line">&#123;                                         \            </span><br><span class="line">  <span class="keyword">if</span> (!__libc_pthread_functions_init)                         \</span><br><span class="line">    defaction;                                    \    </span><br><span class="line">                                          \            </span><br><span class="line">  <span class="keyword">return</span> PTHFCT_CALL (ptr_##name, params);                    \</span><br><span class="line">&#125;                                                      </span><br><span class="line">                                                       </span><br><span class="line"><span class="comment">/* Same as FORWARD2, only without return.  */</span>          </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FORWARD_NORETURN(name, rettype, decl, params, defaction) \</span></span><br><span class="line">rettype                                       \        </span><br><span class="line">name decl                                     \        </span><br><span class="line">&#123;                                         \            </span><br><span class="line">  <span class="keyword">if</span> (!__libc_pthread_functions_init)                         \</span><br><span class="line">    defaction;                                    \    </span><br><span class="line">                                          \            </span><br><span class="line">  PTHFCT_CALL (ptr_##name, params);                       \</span><br><span class="line">&#125;                                                      </span><br><span class="line">                                                       </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FORWARD(name, decl, params, defretval) \       </span></span><br><span class="line">  FORWARD2 (name, <span class="keyword">int</span>, decl, params, <span class="keyword">return</span> defretval)</span><br><span class="line"></span><br><span class="line">FORWARD (pthread_attr_setscope, (<span class="keyword">pthread_attr_t</span> *attr, <span class="keyword">int</span> scope),</span><br><span class="line">     (attr, scope), <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>其中__libc_pthread_functions_init 在libpthread加载时赋值初始化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">void __libc_pthread_init (unsigned long int *ptr, void (*reclaim) (void),</span><br><span class="line">             const struct pthread_functions *functions)                                                                                                                                                            </span><br><span class="line">&#123;       </span><br><span class="line">  /* Remember the pointer to the generation counter in libpthread.  */</span><br><span class="line">  __fork_generation_pointer = ptr;</span><br><span class="line">        </span><br><span class="line">  /* Called by a child after fork.  */</span><br><span class="line">  __register_atfork (NULL, NULL, reclaim, NULL);</span><br><span class="line">        </span><br><span class="line">#ifdef SHARED</span><br><span class="line">  /* Copy the function pointers into an array in libc.  This enables</span><br><span class="line">     access with just one memory reference but moreso, it prevents</span><br><span class="line">     hijacking the function pointers with just one pointer change.  We</span><br><span class="line">     &quot;encrypt&quot; the function pointers since we cannot write-protect the</span><br><span class="line">     array easily enough.  */</span><br><span class="line">  union ptrhack</span><br><span class="line">  &#123;     </span><br><span class="line">    struct pthread_functions pf;</span><br><span class="line"># define NPTRS (sizeof (struct pthread_functions) / sizeof (void *))</span><br><span class="line">    void *parr[NPTRS];</span><br><span class="line">  &#125; __attribute__ ((may_alias)) const *src;</span><br><span class="line">  union ptrhack *dest;</span><br><span class="line">        </span><br><span class="line">  src = (const void *) functions;</span><br><span class="line">  dest = (void *) &amp;__libc_pthread_functions;</span><br><span class="line">        </span><br><span class="line">  for (size_t cnt = 0; cnt &lt; NPTRS; ++cnt)</span><br><span class="line">    &#123;   </span><br><span class="line">      void *p = src-&gt;parr[cnt];</span><br><span class="line">      PTR_MANGLE (p);</span><br><span class="line">      dest-&gt;parr[cnt] = p;</span><br><span class="line">    &#125;   </span><br><span class="line">  __libc_pthread_functions_init = 1;</span><br><span class="line">#endif  </span><br><span class="line">        </span><br><span class="line">#ifndef TLS_MULTIPLE_THREADS_IN_TCB</span><br><span class="line">  return &amp;__libc_multiple_threads;</span><br><span class="line">#endif  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在段初始化时调用 __libc_pthread_init</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// ../sysdeps/x86_64/crti.S</span><br><span class="line">_init:         </span><br><span class="line">    /* Maintain 16-byte stack alignment for called functions.  */</span><br><span class="line">    subq $8, %rsp</span><br><span class="line">#if PREINIT_FUNCTION_WEAK</span><br><span class="line">    movq PREINIT_FUNCTION@GOTPCREL(%rip), %rax</span><br><span class="line">    testq %rax, %rax</span><br><span class="line">    je .Lno_weak_fn                                                                                                                                                                                                </span><br><span class="line">    call PREINIT_FUNCTION@PLT</span><br></pre></td></tr></table></figure>

<p>其中PREINIT_FUNCTION定义为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PREINIT_FUNCTION __pthread_initialize_minimal_internal</span></span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">John Doe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">80</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
