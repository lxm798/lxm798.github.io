<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="lxm798">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="lxm798">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="lxm798">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/4/">





  <title>lxm798</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">lxm798</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/04/nginx/ds/request/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/04/nginx/ds/request/" itemprop="url">.request</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-04T11:11:16+08:00">
                2019-10-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_module_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            ctx_index;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            index;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>                 *name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            spare0;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            spare1;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            version;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>           *signature;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>                 *ctx;</span><br><span class="line">    <span class="keyword">ngx_command_t</span>        *commands;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>            type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_int_t</span>           (*init_master)(<span class="keyword">ngx_log_t</span> *<span class="built_in">log</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_int_t</span>           (*init_module)(<span class="keyword">ngx_cycle_t</span> *cycle);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_int_t</span>           (*init_process)(<span class="keyword">ngx_cycle_t</span> *cycle);</span><br><span class="line">    <span class="keyword">ngx_int_t</span>           (*init_thread)(<span class="keyword">ngx_cycle_t</span> *cycle);</span><br><span class="line">    <span class="keyword">void</span>                (*exit_thread)(<span class="keyword">ngx_cycle_t</span> *cycle);</span><br><span class="line">    <span class="keyword">void</span>                (*exit_process)(<span class="keyword">ngx_cycle_t</span> *cycle);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>                (*exit_master)(<span class="keyword">ngx_cycle_t</span> *cycle);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook0;</span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook1;</span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook2;</span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook3;</span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook4;</span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook5;</span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook6;</span><br><span class="line">    <span class="keyword">uintptr_t</span>             spare_hook7;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_http_request_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span>                          signature;         <span class="comment">/* "HTTP" */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_connection_t</span>                 *connection;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>                            **ctx;</span><br><span class="line">    <span class="keyword">void</span>                            **main_conf;</span><br><span class="line">    <span class="keyword">void</span>                            **srv_conf;</span><br><span class="line">    <span class="keyword">void</span>                            **loc_conf;</span><br><span class="line"></span><br><span class="line">    ngx_http_event_handler_pt         read_event_handler;</span><br><span class="line">    ngx_http_event_handler_pt         write_event_handler;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_CACHE)</span></span><br><span class="line">    <span class="keyword">ngx_http_cache_t</span>                 *cache;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_http_upstream_t</span>              *upstream;</span><br><span class="line">    <span class="keyword">ngx_array_t</span>                      *upstream_states;</span><br><span class="line">                                         <span class="comment">/* of ngx_http_upstream_state_t */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_pool_t</span>                       *pool;</span><br><span class="line">    <span class="keyword">ngx_buf_t</span>                        *header_in;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_http_headers_in_t</span>             headers_in;</span><br><span class="line">    <span class="keyword">ngx_http_headers_out_t</span>            headers_out;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_http_request_body_t</span>          *request_body;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">time_t</span>                            lingering_time;</span><br><span class="line">    <span class="keyword">time_t</span>                            start_sec;</span><br><span class="line">    <span class="keyword">ngx_msec_t</span>                        start_msec;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                        method;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                        http_version;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                         request_line;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                         uri;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                         args;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                         exten;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                         unparsed_uri;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                         method_name;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                         http_protocol;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                         schema;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_chain_t</span>                      *out;</span><br><span class="line">    <span class="keyword">ngx_http_request_t</span>               *main;</span><br><span class="line">    <span class="keyword">ngx_http_request_t</span>               *parent;</span><br><span class="line">    <span class="keyword">ngx_http_postponed_request_t</span>     *postponed;</span><br><span class="line">    <span class="keyword">ngx_http_post_subrequest_t</span>       *post_subrequest;</span><br><span class="line">    <span class="keyword">ngx_http_posted_request_t</span>        *posted_requests;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_int_t</span>                         phase_handler;</span><br><span class="line">    ngx_http_handler_pt               content_handler;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                        access_code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_http_variable_value_t</span>        *variables;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                        ncaptures;</span><br><span class="line">    <span class="keyword">int</span>                              *captures;</span><br><span class="line">    u_char                           *captures_data;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span>                            limit_rate;</span><br><span class="line">    <span class="keyword">size_t</span>                            limit_rate_after;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* used to learn the Apache compatible response length without a header */</span></span><br><span class="line">    <span class="keyword">size_t</span>                            header_size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">off_t</span>                             request_length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                        err_status;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_http_connection_t</span>            *http_connection;</span><br><span class="line">    <span class="keyword">ngx_http_v2_stream_t</span>             *stream;</span><br><span class="line"></span><br><span class="line">    ngx_http_log_handler_pt           log_handler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_http_cleanup_t</span>               *cleanup;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                          count:<span class="number">16</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          subrequests:<span class="number">8</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          blocked:<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                          aio:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                          http_state:<span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* URI with "/." and on Win32 with "//" */</span></span><br><span class="line">    <span class="keyword">unsigned</span>                          complex_uri:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* URI with "%" */</span></span><br><span class="line">    <span class="keyword">unsigned</span>                          quoted_uri:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* URI with "+" */</span></span><br><span class="line">    <span class="keyword">unsigned</span>                          plus_in_uri:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* URI with " " */</span></span><br><span class="line">    <span class="keyword">unsigned</span>                          space_in_uri:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                          invalid_header:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                          add_uri_to_alias:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          valid_location:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          valid_unparsed_uri:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          uri_changed:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          uri_changes:<span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                          request_body_in_single_buf:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          request_body_in_file_only:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          request_body_in_persistent_file:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          request_body_in_clean_file:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          request_body_file_group_access:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          request_body_file_log_level:<span class="number">3</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          request_body_no_buffering:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                          subrequest_in_memory:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          waited:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_CACHE)</span></span><br><span class="line">    <span class="keyword">unsigned</span>                          cached:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HTTP_GZIP)</span></span><br><span class="line">    <span class="keyword">unsigned</span>                          gzip_tested:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          gzip_ok:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          gzip_vary:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">    <span class="keyword">unsigned</span>                          realloc_captures:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                          proxy:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          bypass_cache:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          no_cache:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * instead of using the request context data in</span></span><br><span class="line"><span class="comment">     * ngx_http_limit_conn_module and ngx_http_limit_req_module</span></span><br><span class="line"><span class="comment">     * we use the single bits in the request structure</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">unsigned</span>                          limit_conn_set:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          limit_req_set:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    <span class="keyword">unsigned</span>                          cacheable:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                          pipeline:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          chunked:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          header_only:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          expect_trailers:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          keepalive:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          lingering_close:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          discard_body:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          reading_body:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          internal:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          error_page:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          filter_finalize:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          post_action:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          request_complete:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          request_output:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          header_sent:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          expect_tested:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          root_tested:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          done:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          logged:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                          buffered:<span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                          main_filter_need_in_memory:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          filter_need_in_memory:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          filter_need_temporary:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          preserve_body:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          allow_ranges:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          subrequest_ranges:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          single_range:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          disable_not_modified:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          stat_reading:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          stat_writing:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          stat_processing:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                          background:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          health_check:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* used to parse HTTP headers */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                        state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                        header_hash;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                        lowcase_index;</span><br><span class="line">    u_char                            lowcase_header[NGX_HTTP_LC_HEADER_LEN];</span><br><span class="line"></span><br><span class="line">    u_char                           *header_name_start;</span><br><span class="line">    u_char                           *header_name_end;</span><br><span class="line">    u_char                           *header_start;</span><br><span class="line">    u_char                           *header_end;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * a memory that can be reused after parsing a request line</span></span><br><span class="line"><span class="comment">     * via ngx_http_ephemeral_t</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    u_char                           *uri_start;</span><br><span class="line">    u_char                           *uri_end;</span><br><span class="line">    u_char                           *uri_ext;</span><br><span class="line">    u_char                           *args_start;</span><br><span class="line">    u_char                           *request_start;</span><br><span class="line">    u_char                           *request_end;</span><br><span class="line">    u_char                           *method_end;</span><br><span class="line">    u_char                           *schema_start;</span><br><span class="line">    u_char                           *schema_end;</span><br><span class="line">    u_char                           *host_start;</span><br><span class="line">    u_char                           *host_end;</span><br><span class="line">    u_char                           *port_start;</span><br><span class="line">    u_char                           *port_end;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>                          http_minor:<span class="number">16</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>                          http_major:<span class="number">16</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_cycle_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span>                  ****conf_ctx;</span><br><span class="line">    <span class="keyword">ngx_pool_t</span>               *pool;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_log_t</span>                *<span class="built_in">log</span>;</span><br><span class="line">    <span class="keyword">ngx_log_t</span>                 new_log;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                log_use_stderr;  <span class="comment">/* unsigned  log_use_stderr:1; */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_connection_t</span>        **files;</span><br><span class="line">    <span class="keyword">ngx_connection_t</span>         *free_connections;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                free_connection_n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_module_t</span>            **modules;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                modules_n;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                modules_used;    <span class="comment">/* unsigned  modules_used:1; */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_queue_t</span>               reusable_connections_queue;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                reusable_connections_n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_array_t</span>               listening;</span><br><span class="line">    <span class="keyword">ngx_array_t</span>               paths;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_array_t</span>               config_dump;</span><br><span class="line">    <span class="keyword">ngx_rbtree_t</span>              config_dump_rbtree;</span><br><span class="line">    <span class="keyword">ngx_rbtree_node_t</span>         config_dump_sentinel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_list_t</span>                open_files;</span><br><span class="line">    <span class="keyword">ngx_list_t</span>                shared_memory;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                connection_n;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                files_n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_connection_t</span>         *connections;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>              *read_events;</span><br><span class="line">    <span class="keyword">ngx_event_t</span>              *write_events;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_cycle_t</span>              *old_cycle;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_str_t</span>                 conf_file;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                 conf_param;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                 conf_prefix;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                 prefix;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                 lock_file;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>                 hostname;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">/* array of the ngx_http_server_name_t, "server_name" directive */</span></span><br><span class="line">    <span class="keyword">ngx_array_t</span>                 server_names;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* server ctx */</span></span><br><span class="line">    <span class="keyword">ngx_http_conf_ctx_t</span>        *ctx;</span><br><span class="line"> </span><br><span class="line">    u_char                     *file_name;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                  line;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">ngx_str_t</span>                   server_name;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">size_t</span>                      connection_pool_size;</span><br><span class="line">    <span class="keyword">size_t</span>                      request_pool_size;</span><br><span class="line">    <span class="keyword">size_t</span>                      client_header_buffer_size;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">ngx_bufs_t</span>                  large_client_header_buffers;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">ngx_msec_t</span>                  client_header_timeout;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">ngx_flag_t</span>                  ignore_invalid_headers;</span><br><span class="line">    <span class="keyword">ngx_flag_t</span>                  merge_slashes;</span><br><span class="line">    <span class="keyword">ngx_flag_t</span>                  underscores_in_headers;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">unsigned</span>                    listen:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">    <span class="keyword">unsigned</span>                    captures:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span>  **named_locations;</span><br><span class="line">&#125; <span class="keyword">ngx_http_core_srv_conf_t</span>;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/04/network/tcp_sendmsg/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/04/network/tcp_sendmsg/" itemprop="url">.tcp_sendmsg</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-04T11:11:16+08:00">
                2019-10-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="tcp-"><a href="#tcp-" class="headerlink" title="tcp "></a>tcp </h2><h3 id="tcp-sendmsg"><a href="#tcp-sendmsg" class="headerlink" title="tcp_sendmsg"></a>tcp_sendmsg</h3><p>copysk_buffer</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tcp_sendmsg</span><span class="params">(struct kiocb *iocb, struct sock *sk, struct msghdr *msg,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> *<span class="title">iov</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcp_sock</span> *<span class="title">tp</span> = <span class="title">tcp_sk</span>(<span class="title">sk</span>);</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">	<span class="keyword">int</span> iovlen, flags;</span><br><span class="line">	<span class="keyword">int</span> mss_now, size_goal;</span><br><span class="line">	<span class="keyword">int</span> sg, err, copied;</span><br><span class="line">	<span class="keyword">long</span> timeo;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">//sock</span></span><br><span class="line">	lock_sock(sk);</span><br><span class="line">	TCP_CHECK_TIMER(sk);</span><br><span class="line"> </span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	flags = msg-&gt;msg_flags;</span><br><span class="line">	timeo = sock_sndtimeo(sk, flags &amp; MSG_DONTWAIT);</span><br><span class="line"> </span><br><span class="line">	<span class="comment">//ESTABLISHEDCLOSE_WAIT</span></span><br><span class="line">	<span class="keyword">if</span> ((<span class="number">1</span> &lt;&lt; sk-&gt;sk_state) &amp; ~(TCPF_ESTABLISHED | TCPF_CLOSE_WAIT))</span><br><span class="line">		<span class="keyword">if</span> ((err = sk_stream_wait_connect(sk, &amp;timeo)) != <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line"> </span><br><span class="line">	clear_bit(SOCK_ASYNC_NOSPACE, &amp;sk-&gt;sk_socket-&gt;flags);</span><br><span class="line"> </span><br><span class="line">	<span class="comment">//MSS</span></span><br><span class="line">	mss_now = tcp_send_mss(sk, &amp;size_goal, flags);</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/*ioviovlen*/</span></span><br><span class="line"> <span class="comment">/*struct msghdrstruct iovec*/</span></span><br><span class="line">	iovlen = msg-&gt;msg_iovlen;</span><br><span class="line">	iov = msg-&gt;msg_iov;<span class="comment">//iovec</span></span><br><span class="line">	copied = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">	err = -EPIPE;</span><br><span class="line">	<span class="keyword">if</span> (sk-&gt;sk_err || (sk-&gt;sk_shutdown &amp; SEND_SHUTDOWN))</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"> </span><br><span class="line">	sg = sk-&gt;sk_route_caps &amp; NETIF_F_SG;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/*iovTCP*/</span></span><br><span class="line">	<span class="comment">/*SKBMSSSKB*/</span></span><br><span class="line">	<span class="keyword">while</span> (--iovlen &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">size_t</span> seglen = iov-&gt;iov_len;					<span class="comment">//</span></span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">char</span> __user *from = iov-&gt;iov_base;&lt;span style=<span class="string">"white-space:pre"</span>&gt;			&lt;/span&gt;<span class="comment">//</span></span><br><span class="line"> </span><br><span class="line">		iov++;</span><br><span class="line"> </span><br><span class="line">		<span class="keyword">while</span> (seglen &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">int</span> copy = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">int</span> max = size_goal;</span><br><span class="line"> </span><br><span class="line">			<span class="comment">//skb</span></span><br><span class="line">			skb = tcp_write_queue_tail(sk);				</span><br><span class="line">			<span class="keyword">if</span> (tcp_send_head(sk)) &#123;				<span class="comment">//sk_send_head</span></span><br><span class="line">				<span class="keyword">if</span> (skb-&gt;ip_summed == CHECKSUM_NONE)</span><br><span class="line">					max = mss_now;</span><br><span class="line">				copy = max - skb-&gt;len;</span><br><span class="line">			&#125;</span><br><span class="line"> </span><br><span class="line">			<span class="comment">//sk_send_headSKBSKB</span></span><br><span class="line">			<span class="keyword">if</span> (copy &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">new_segment:</span><br><span class="line">				<span class="comment">//sk-&gt;sk_wmem_queued &lt; sk-&gt;sk_sndbuf</span></span><br><span class="line">				<span class="keyword">if</span> (!sk_stream_memory_free(sk))</span><br><span class="line">					<span class="keyword">goto</span> wait_for_sndbuf;		<span class="comment">//SOCK_NOSPACE</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">				<span class="comment">//SKB,select_sizeskb2.6.380skbfrags</span></span><br><span class="line">				skb = sk_stream_alloc_skb(sk,select_size(sk, sg),sk-&gt;sk_allocation);</span><br><span class="line">				<span class="keyword">if</span> (!skb)</span><br><span class="line">					<span class="keyword">goto</span> wait_for_memory;</span><br><span class="line"> </span><br><span class="line">				<span class="keyword">if</span> (sk-&gt;sk_route_caps &amp; NETIF_F_ALL_CSUM)</span><br><span class="line">					skb-&gt;ip_summed = CHECKSUM_PARTIAL;</span><br><span class="line"> </span><br><span class="line">				skb_entail(sk, skb);					<span class="comment">//SKB</span></span><br><span class="line">				copy = size_goal;</span><br><span class="line">				max = size_goal;</span><br><span class="line">			&#125;</span><br><span class="line"> </span><br><span class="line">			<span class="keyword">if</span> (copy &gt; seglen)</span><br><span class="line">				copy = seglen;</span><br><span class="line"> </span><br><span class="line">			<span class="keyword">if</span> (skb_tailroom(skb) &gt; <span class="number">0</span>) &#123;				<span class="comment">//skb</span></span><br><span class="line">				<span class="keyword">if</span> (copy &gt; skb_tailroom(skb))&lt;span style=<span class="string">"white-space:pre"</span>&gt;			&lt;/span&gt;<span class="comment">//</span></span><br><span class="line">					copy = skb_tailroom(skb);</span><br><span class="line">				<span class="keyword">if</span> ((err = skb_add_data(skb, from, copy)) != <span class="number">0</span>)</span><br><span class="line">					<span class="keyword">goto</span> do_fault;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">//skbskb_shared_infofrags</span></span><br><span class="line">				<span class="keyword">int</span> merge = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">int</span> i = skb_shinfo(skb)-&gt;nr_frags;</span><br><span class="line">				<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> = <span class="title">TCP_PAGE</span>(<span class="title">sk</span>);</span><span class="comment">//skpagefragpage</span></span><br><span class="line">				<span class="keyword">int</span> off = TCP_OFF(sk);</span><br><span class="line"> </span><br><span class="line">				<span class="keyword">if</span> (skb_can_coalesce(skb, i, page, off) &amp;&amp;</span><br><span class="line">					off != PAGE_SIZE) &#123;</span><br><span class="line">					 <span class="comment">/* We can extend the last page</span></span><br><span class="line"><span class="comment">					  * fragment. */</span></span><br><span class="line">					 merge = <span class="number">1</span>;</span><br><span class="line">				 &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i == MAX_SKB_FRAGS || !sg) &#123;</span><br><span class="line">					 <span class="comment">/* Need to add new fragment and cannot</span></span><br><span class="line"><span class="comment">					  * do this because interface is non-SG,</span></span><br><span class="line"><span class="comment">					  * or because all the page slots are</span></span><br><span class="line"><span class="comment">					  * busy. */</span></span><br><span class="line">					 tcp_mark_push(tp, skb);</span><br><span class="line">					 <span class="keyword">goto</span> new_segment;</span><br><span class="line">				 &#125; <span class="keyword">else</span> <span class="keyword">if</span> (page) &#123;</span><br><span class="line">					 <span class="keyword">if</span> (off == PAGE_SIZE) &#123; <span class="comment">//PAGE</span></span><br><span class="line">					 put_page(page);</span><br><span class="line">					 TCP_PAGE(sk) = page = <span class="literal">NULL</span>;</span><br><span class="line">					 off = <span class="number">0</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					 off = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">					 <span class="keyword">if</span> (copy &gt; PAGE_SIZE - off) <span class="comment">//</span></span><br><span class="line">					 copy = PAGE_SIZE - off;</span><br><span class="line"> </span><br><span class="line">					 <span class="keyword">if</span> (!sk_wmem_schedule(sk, copy))</span><br><span class="line">					 <span class="keyword">goto</span> wait_for_memory;</span><br><span class="line"> </span><br><span class="line">					 <span class="keyword">if</span> (!page) &#123;</span><br><span class="line">					 <span class="comment">/* Allocate new cache page. */</span></span><br><span class="line">					 <span class="keyword">if</span> (!(page = sk_stream_alloc_page(sk)))</span><br><span class="line">					 <span class="keyword">goto</span> wait_for_memory;</span><br><span class="line">				 &#125;</span><br><span class="line"> </span><br><span class="line">				 <span class="comment">//</span></span><br><span class="line">				 err = skb_copy_to_page(sk, from, skb, page,</span><br><span class="line">						off, copy);</span><br><span class="line">				 <span class="keyword">if</span> (err) &#123;</span><br><span class="line">					 <span class="comment">/* If this page was new, give it to the</span></span><br><span class="line"><span class="comment">					  * socket so it does not get leaked.</span></span><br><span class="line"><span class="comment">					  */</span></span><br><span class="line">					 <span class="keyword">if</span> (!TCP_PAGE(sk)) &#123;</span><br><span class="line">					 TCP_PAGE(sk) = page;</span><br><span class="line">					 TCP_OFF(sk) = <span class="number">0</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">goto</span> do_error;</span><br><span class="line">				 &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">				 <span class="comment">/* Update the skb. */</span></span><br><span class="line">				 <span class="keyword">if</span> (merge) &#123;</span><br><span class="line">					 skb_shinfo(skb)-&gt;frags[i - <span class="number">1</span>].size +=</span><br><span class="line">					 copy;</span><br><span class="line">				 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					 skb_fill_page_desc(skb, i, page, off, copy);</span><br><span class="line">					 <span class="keyword">if</span> (TCP_PAGE(sk)) &#123;</span><br><span class="line">					 get_page(page);</span><br><span class="line">					 &#125; <span class="keyword">else</span> <span class="keyword">if</span> (off + copy &lt; PAGE_SIZE) &#123;</span><br><span class="line">					 get_page(page);</span><br><span class="line">					 TCP_PAGE(sk) = page;</span><br><span class="line">					 &#125;</span><br><span class="line">				&#125;</span><br><span class="line">				TCP_OFF(sk) = off + copy;</span><br><span class="line">			&#125;	</span><br><span class="line">			<span class="comment">//PUSH__tcp_push_pending_framessk_send_head</span></span><br><span class="line">			<span class="keyword">if</span> (forced_push(tp)) &#123;</span><br><span class="line">				tcp_mark_push(tp, skb);</span><br><span class="line">				__tcp_push_pending_frames(sk, mss_now, TCP_NAGLE_PUSH);</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (skb == tcp_send_head(sk))	<span class="comment">//SKB,tcp_push_onesk_send_head,SKB</span></span><br><span class="line">				tcp_push_one(sk, mss_now);</span><br><span class="line">				</span><br><span class="line">			<span class="comment">//tcp_write_xmitsocksk_send_head</span></span><br><span class="line">			<span class="comment">//SKBSKB.tcp_write_xmitMTU</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"> </span><br><span class="line">wait_for_sndbuf:</span><br><span class="line">			set_bit(SOCK_NOSPACE, &amp;sk-&gt;sk_socket-&gt;flags);</span><br><span class="line">wait_for_memory:</span><br><span class="line">			<span class="keyword">if</span> (copied)</span><br><span class="line">				tcp_push(sk, flags &amp; ~MSG_MORE, mss_now, TCP_NAGLE_PUSH);</span><br><span class="line"> </span><br><span class="line">			<span class="keyword">if</span> ((err = sk_stream_wait_memory(sk, &amp;timeo)) != <span class="number">0</span>)	<span class="comment">//</span></span><br><span class="line">				<span class="keyword">goto</span> do_error;</span><br><span class="line"> </span><br><span class="line">			mss_now = tcp_send_mss(sk, &amp;size_goal, flags);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">if</span> (copied)</span><br><span class="line">		tcp_push(sk, flags, mss_now, tp-&gt;nonagle);</span><br><span class="line">	TCP_CHECK_TIMER(sk);</span><br><span class="line">	release_sock(sk);</span><br><span class="line">	<span class="keyword">return</span> copied;</span><br><span class="line"> </span><br><span class="line">do_fault:</span><br><span class="line">	<span class="keyword">if</span> (!skb-&gt;len) &#123;</span><br><span class="line">		tcp_unlink_write_queue(skb, sk);</span><br><span class="line"> </span><br><span class="line">		tcp_check_send_head(sk, skb);</span><br><span class="line">		sk_wmem_free_skb(sk, skb);</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">do_error:</span><br><span class="line">	<span class="keyword">if</span> (copied)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">out_err:</span><br><span class="line">	err = sk_stream_error(sk, flags, err);</span><br><span class="line">	TCP_CHECK_TIMER(sk);</span><br><span class="line">	release_sock(sk);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="tcp-push"><a href="#tcp-push" class="headerlink" title="tcp_push"></a>tcp_push</h2><p>tcp_sendmsg()sock</p>
<p>tcp_push()</p>
<p>tcp_push()</p>
<ol>
<li><p></p>
</li>
<li><p>PSH</p>
</li>
<li><p></p>
</li>
<li><p></p>
</li>
<li><p>skb</p>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">tcp_push</span><span class="params">(struct sock *sk, <span class="keyword">int</span> flags, <span class="keyword">int</span> mss_now, <span class="keyword">int</span> nonagle, <span class="keyword">int</span> size_goal)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcp_sock</span> *<span class="title">tp</span> = <span class="title">tcp_sk</span>(<span class="title">sk</span>);</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">    <span class="keyword">if</span> (! tcp_send_head(sk))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* skb */</span></span><br><span class="line">    skb = tcp_write_queue_tail(sk);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* PUSH</span></span><br><span class="line"><span class="comment">     * PSH</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (! (flags &amp; MSG_MORE) || forced_push(tp))</span><br><span class="line">        tcp_mark_push(tp, skb);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* MSG_OOB */</span></span><br><span class="line">    tcp_mark_urg(tp, flags);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">    <span class="keyword">if</span> (tcp_should_autocork(sk, skb, size_goal)) &#123;</span><br><span class="line">        <span class="comment">/* avoid atomic op if TSQ_THROTTED bit is already set,  */</span></span><br><span class="line">        <span class="keyword">if</span> (! test_bit(TSQ_THROTTLED, &amp;tp-&gt;tsq_flags)) &#123;</span><br><span class="line">            NET_INC_STATS(sock_net(sk), LINUX_MIB_TCPAUTOCORKING);</span><br><span class="line">            set_bit(TSQ_THROTTLED, &amp;tp-&gt;tsq_flags);</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">        <span class="comment">/* It is possible TX completion already happened before we set TSQ_THROTTED.</span></span><br><span class="line"><span class="comment">         * IPsk_wmem_alloc</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (atomic_read(&amp;sk-&gt;sk_wmem_alloc) &gt; skb-&gt;truesize)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* TCP CORK */</span></span><br><span class="line">    <span class="keyword">if</span> (flags &amp; MSG_MORE)</span><br><span class="line">        nonagle = TCP_NAGLE_CORK;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* skb</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    __tcp_push_pending_frames(sk, mss_now, nonagle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>tcp_push_pending_frames()__tcp_push_pending_frames()tcp_write_xmit()</p>
<p>tcp_write_xmit()TCP </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Push out any pending frames which were held back due to TCP_CORK</span></span><br><span class="line"><span class="comment"> * or attempt at coalescing tiny packets.</span></span><br><span class="line"><span class="comment"> * The socket must be locked by the caller.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> __tcp_push_pending_frames(struct sock *sk, <span class="keyword">unsigned</span> <span class="keyword">int</span> cur_mss, <span class="keyword">int</span> nonagle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* If we are closed, the bytes will have to remain here.</span></span><br><span class="line"><span class="comment">     * In time closedown will finish, we empty the write queue and</span></span><br><span class="line"><span class="comment">     * all will be happy.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (unlikely(sk-&gt;sk_state == TCP_CLOSE))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">    <span class="keyword">if</span> (tcp_write_xmit(sk, cur_mss, nonagle, <span class="number">0</span>, sk_gfp_atomic(sk, GFP_ATOMIC)))</span><br><span class="line">        tcp_check_probe_timer(sk); <span class="comment">/* 0*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="tcp-write-xmit"><a href="#tcp-write-xmit" class="headerlink" title="tcp_write_xmit"></a>tcp_write_xmit</h2><p><a href="https://blog.csdn.net/ctthuangcheng/article/details/42202477" target="_blank" rel="noopener">https://blog.csdn.net/ctthuangcheng/article/details/42202477</a><br>tcp_write_xmit()SBK0<br>1<br>2<br>3nagle<br>4SKB<br>5SKB</p>
<p>nagle/sk_buffer</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tcp_write_xmit</span><span class="params">(struct sock *sk, <span class="keyword">unsigned</span> <span class="keyword">int</span> mss_now, <span class="keyword">int</span> nonagle,</span></span></span><br><span class="line"><span class="function"><span class="params">             <span class="keyword">int</span> push_one, <span class="keyword">gfp_t</span> gfp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcp_sock</span> *<span class="title">tp</span> = <span class="title">tcp_sk</span>(<span class="title">sk</span>);</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> tso_segs, sent_pkts;</span><br><span class="line">    <span class="keyword">int</span> cwnd_quota;</span><br><span class="line">    <span class="keyword">int</span> result;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*sent_pkts*/</span></span><br><span class="line">    sent_pkts = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (!push_one) &#123;</span><br><span class="line">        <span class="comment">/* Do MTU probing. */</span></span><br><span class="line">        result = tcp_mtu_probe(sk);</span><br><span class="line">        <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            sent_pkts = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*13~210MTU1*/</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**/</span></span><br><span class="line">    <span class="keyword">while</span> ((skb = tcp_send_head(sk))) &#123;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> limit;</span><br><span class="line"> </span><br><span class="line">      <span class="comment">/*TSOGSOGSOTSO</span></span><br><span class="line"><span class="comment">        TSOTSOTSO*/</span></span><br><span class="line">        tso_segs = tcp_init_tso_segs(sk, skb, mss_now);</span><br><span class="line">        BUG_ON(!tso_segs);</span><br><span class="line"> </span><br><span class="line">      <span class="comment">/*0</span></span><br><span class="line"><span class="comment">        </span></span><br><span class="line"><span class="comment">        </span></span><br><span class="line"><span class="comment">        tcp_cwnd_test()*/</span></span><br><span class="line">        cwnd_quota = tcp_cwnd_test(tp, skb);</span><br><span class="line">        <span class="keyword">if</span> (!cwnd_quota)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">       </span><br><span class="line">        <span class="comment">/**/</span></span><br><span class="line">        <span class="keyword">if</span> (unlikely(!tcp_snd_wnd_test(tp, skb, mss_now)))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/*tso_segs=1tso*/</span></span><br><span class="line">        <span class="keyword">if</span> (tso_segs == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">/*nagle*/</span></span><br><span class="line">            <span class="keyword">if</span> (unlikely(!tcp_nagle_test(tp, skb, mss_now,</span><br><span class="line">                         (tcp_skb_is_last(sk, skb) ?</span><br><span class="line">                         nonagle : TCP_NAGLE_PUSH))))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">/*TSOtcp_tso_should_defer()GSO</span></span><br><span class="line"><span class="comment">            FINopenTSO264KMSS</span></span><br><span class="line"><span class="comment">            GSO*/</span></span><br><span class="line">            <span class="keyword">if</span> (!push_one &amp;&amp; tcp_tso_should_defer(sk, skb))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/*limitMSS*/</span></span><br><span class="line">        limit = mss_now; </span><br><span class="line">      <span class="comment">/*TSO1URGmss_nowlimit</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (tso_segs &gt; <span class="number">1</span> &amp;&amp; !tcp_urg_mode(tp))</span><br><span class="line">            limit = tcp_mss_split_point(sk, skb, mss_now,</span><br><span class="line">                         cwnd_quota);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/*SKBtso_fragment()*/</span></span><br><span class="line">        <span class="keyword">if</span> (skb-&gt;len &gt; limit &amp;&amp;</span><br><span class="line">         unlikely(tso_fragment(sk, skb, limit, mss_now, gfp)))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">      <span class="comment">/*line61~71SKBMSSTSO</span></span><br><span class="line"><span class="comment">        tcp_sendmsg()SKBMSS</span></span><br><span class="line"><span class="comment">        MSSTSO*/</span></span><br><span class="line"> </span><br><span class="line">      <span class="comment">/*TCP</span></span><br><span class="line"><span class="comment">        #define tcp_time_stamp	 ((__u32)(jiffies))*/</span></span><br><span class="line">        TCP_SKB_CB(skb)-&gt;when = tcp_time_stamp;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/*tcp_transmit_skb()TCP1*/</span></span><br><span class="line">        <span class="keyword">if</span> (unlikely(tcp_transmit_skb(sk, skb, <span class="number">1</span>, gfp)))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/* Advance the send_head. This one is sent out.</span></span><br><span class="line"><span class="comment">         * This call will increment packets_out.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">      <span class="comment">/*tcp_event_new_data_sent()--&gt;tcp_advance_send_head()sk_send_headSKB</span></span><br><span class="line"><span class="comment">        snd_nxtTCP</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        tcp_event_new_data_sent(sk, skb);</span><br><span class="line"> </span><br><span class="line">      <span class="comment">/*struct tcp_socksnd_smlsnd_sml(MSS)</span></span><br><span class="line"><span class="comment">        MSSnagle*/</span></span><br><span class="line">        tcp_minshall_update(tp, mss_now, skb);</span><br><span class="line">        sent_pkts++;<span class="comment">//</span></span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (push_one)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*TCP*/</span></span><br><span class="line">    <span class="keyword">if</span> (likely(sent_pkts)) &#123;</span><br><span class="line">        tcp_cwnd_validate(sk);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*packets_outsk_send_headpackets_outsk_send_head*/</span></span><br><span class="line">    <span class="keyword">return</span> !tp-&gt;packets_out &amp;&amp; tcp_send_head(sk);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="tcp-init-tso-segs-"><a href="#tcp-init-tso-segs-" class="headerlink" title="tcp_init_tso_segs()"></a>tcp_init_tso_segs()</h3><p>mssstruct skb_shared_infoGSO</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tcp_init_tso_segs</span><span class="params">(struct sock *sk, struct sk_buff *skb,</span></span></span><br><span class="line"><span class="function"><span class="params">             <span class="keyword">unsigned</span> <span class="keyword">int</span> mss_now)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> tso_segs = tcp_skb_pcount(skb);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (!tso_segs || (tso_segs &gt; <span class="number">1</span> &amp;&amp; tcp_skb_mss(skb) != mss_now)) &#123;</span><br><span class="line">        tcp_set_skb_tso_segs(sk, skb, mss_now);</span><br><span class="line">        tso_segs = tcp_skb_pcount(skb);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tso_segs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">tcp_cwnd_test</span><span class="params">(struct tcp_sock *tp,</span></span></span><br><span class="line"><span class="function"><span class="params">                     struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    u32 in_flight, cwnd;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* Don't be strict about the congestion window for the final FIN. */</span></span><br><span class="line">    <span class="comment">/*FIN*/</span></span><br><span class="line">    <span class="keyword">if</span> ((TCP_SKB_CB(skb)-&gt;flags &amp; TCPHDR_FIN) &amp;&amp; tcp_skb_pcount(skb) == <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**/</span></span><br><span class="line">    in_flight = tcp_packets_in_flight(tp);</span><br><span class="line">    <span class="comment">/*snd_cwnd*/</span></span><br><span class="line">    cwnd = tp-&gt;snd_cwnd;</span><br><span class="line">    <span class="keyword">if</span> (in_flight &lt; cwnd)</span><br><span class="line">        <span class="keyword">return</span> (cwnd - in_flight);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="tcp-transmit-skb"><a href="#tcp-transmit-skb" class="headerlink" title="tcp_transmit_skb"></a>tcp_transmit_skb</h2><p><a href="https://blog.csdn.net/ctthuangcheng/article/details/42202927" target="_blank" rel="noopener">https://blog.csdn.net/ctthuangcheng/article/details/42202927</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tcp_transmit_skb</span><span class="params">(struct sock *sk, struct sk_buff *skb, <span class="keyword">int</span> clone_it,</span></span></span><br><span class="line"><span class="function"><span class="params">             <span class="keyword">gfp_t</span> gfp_mask)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">inet_connection_sock</span> *<span class="title">icsk</span> = <span class="title">inet_csk</span>(<span class="title">sk</span>);</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inet_sock</span> *<span class="title">inet</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcp_sock</span> *<span class="title">tp</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcp_skb_cb</span> *<span class="title">tcb</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcp_out_options</span> <span class="title">opts</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> tcp_options_size, tcp_header_size;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcp_md5sig_key</span> *<span class="title">md5</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> *<span class="title">th</span>;</span></span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line"> </span><br><span class="line">    BUG_ON(!skb || !tcp_skb_pcount(skb));</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* If congestion control is doing timestamping, we must</span></span><br><span class="line"><span class="comment">     * take such a timestamp before we potentially clone/copy.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    linux</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (icsk-&gt;icsk_ca_ops-&gt;flags &amp; TCP_CONG_RTT_STAMP)</span><br><span class="line">        __net_timestamp(skb);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*clone_it*/</span></span><br><span class="line">    <span class="keyword">if</span> (likely(clone_it)) &#123;</span><br><span class="line">        <span class="comment">/*skbcloneskbskb*/</span></span><br><span class="line">        <span class="keyword">if</span> (unlikely(skb_cloned(skb)))</span><br><span class="line">            skb = pskb_copy(skb, gfp_mask);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        <span class="comment">/*cloneskb*/</span></span><br><span class="line">            skb = skb_clone(skb, gfp_mask);</span><br><span class="line">        <span class="keyword">if</span> (unlikely(!skb))</span><br><span class="line">            <span class="keyword">return</span> -ENOBUFS;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*INETTCPskbTCP*/</span></span><br><span class="line">    inet = inet_sk(sk);</span><br><span class="line">    tp = tcp_sk(sk);</span><br><span class="line">    tcb = TCP_SKB_CB(skb);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;opts, <span class="number">0</span>, <span class="keyword">sizeof</span>(opts));</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*TCPTCP*/</span></span><br><span class="line">    <span class="comment">/*TCPSYNSYN*/</span></span><br><span class="line">    <span class="keyword">if</span> (unlikely(tcb-&gt;flags &amp; TCPHDR_SYN))</span><br><span class="line">        tcp_options_size = tcp_syn_options(sk, skb, &amp;opts, &amp;md5);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        tcp_options_size = tcp_established_options(sk, skb, &amp;opts, &amp;md5);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*tcpstruct tcphdr*/</span></span><br><span class="line">    tcp_header_size = tcp_options_size + <span class="keyword">sizeof</span>(struct tcphdr);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*RTT*/</span></span><br><span class="line">    <span class="keyword">if</span> (tcp_packets_in_flight(tp) == <span class="number">0</span>)</span><br><span class="line">        tcp_ca_event(sk, CA_EVENT_TX_START);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*skb_push()TCPtcp_header_sizedata*/</span></span><br><span class="line">    skb_push(skb, tcp_header_size);</span><br><span class="line">    skb_reset_transport_header(skb);</span><br><span class="line">    <span class="comment">/*SKBSKBskb_set_owner_wSKB*/</span></span><br><span class="line">    skb_set_owner_w(skb, sk);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* Build TCP header and checksum it. */</span></span><br><span class="line">    <span class="comment">/*TCPsourcedestTCPseqack_seq*/</span></span><br><span class="line">    th = tcp_hdr(skb);</span><br><span class="line">    th-&gt;source        = inet-&gt;inet_sport;</span><br><span class="line">    th-&gt;dest        = inet-&gt;inet_dport;</span><br><span class="line">    th-&gt;seq            = htonl(tcb-&gt;seq);</span><br><span class="line">    th-&gt;ack_seq        = htonl(tp-&gt;rcv_nxt);</span><br><span class="line">    *(((__be16 *)th) + <span class="number">6</span>)    = htons(((tcp_header_size &gt;&gt; <span class="number">2</span>) &lt;&lt; <span class="number">12</span>) |</span><br><span class="line">                    tcb-&gt;flags);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*TCP*/</span></span><br><span class="line">    <span class="keyword">if</span> (unlikely(tcb-&gt;flags &amp; TCPHDR_SYN)) &#123;</span><br><span class="line">        <span class="comment">/* RFC1323: The window in SYN &amp; SYN/ACK segments</span></span><br><span class="line"><span class="comment">         * is never scaled.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">/*SYNrcv_wnd*/</span></span><br><span class="line">        th-&gt;window    = htons(min(tp-&gt;rcv_wnd, <span class="number">65535U</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/*tcp_select_window()*/</span></span><br><span class="line">        th-&gt;window    = htons(tcp_select_window(sk));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*TCPTCP*/</span></span><br><span class="line">    th-&gt;check        = <span class="number">0</span>;</span><br><span class="line">    th-&gt;urg_ptr        = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* The urg_mode check is necessary during a below snd_una win probe */</span></span><br><span class="line">    <span class="keyword">if</span> (unlikely(tcp_urg_mode(tp) &amp;&amp; before(tcb-&gt;seq, tp-&gt;snd_up))) &#123;</span><br><span class="line">        <span class="keyword">if</span> (before(tp-&gt;snd_up, tcb-&gt;seq + <span class="number">0x10000</span>)) &#123;</span><br><span class="line">            th-&gt;urg_ptr = htons(tp-&gt;snd_up - tcb-&gt;seq);</span><br><span class="line">            th-&gt;urg = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (after(tcb-&gt;seq + <span class="number">0xFFFF</span>, tp-&gt;snd_nxt)) &#123;</span><br><span class="line">            th-&gt;urg_ptr = htons(<span class="number">0xFFFF</span>);</span><br><span class="line">            th-&gt;urg = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    tcp_options_write((__be32 *)(th + <span class="number">1</span>), tp, &amp;opts);</span><br><span class="line">    <span class="keyword">if</span> (likely((tcb-&gt;flags &amp; TCPHDR_SYN) == <span class="number">0</span>))</span><br><span class="line">        TCP_ECN_send(sk, skb, tcp_header_size);</span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TCP_MD5SIG</span></span><br><span class="line">    <span class="comment">/* Calculate the MD5 hash, as we have all we need now */</span></span><br><span class="line">    <span class="keyword">if</span> (md5) &#123;</span><br><span class="line">        sk_nocaps_add(sk, NETIF_F_GSO_MASK);</span><br><span class="line">        tp-&gt;af_specific-&gt;calc_md5_hash(opts.hash_location,</span><br><span class="line">                     md5, sk, <span class="literal">NULL</span>, skb);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"> </span><br><span class="line">    icsk-&gt;icsk_af_ops-&gt;send_check(sk, skb);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (likely(tcb-&gt;flags &amp; TCPHDR_ACK))</span><br><span class="line">        tcp_event_ack_sent(sk, tcp_skb_pcount(skb));</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (skb-&gt;len != tcp_header_size)</span><br><span class="line">        tcp_event_data_sent(tp, skb, sk);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (after(tcb-&gt;end_seq, tp-&gt;snd_nxt) || tcb-&gt;seq == tcb-&gt;end_seq)</span><br><span class="line">        TCP_ADD_STATS(sock_net(sk), TCP_MIB_OUTSEGS,</span><br><span class="line">             tcp_skb_pcount(skb));</span><br><span class="line">    <span class="comment">/*queue_xmitipTCPip_queue_xmit()*/</span></span><br><span class="line">    err = icsk-&gt;icsk_af_ops-&gt;queue_xmit(skb);</span><br><span class="line">    <span class="keyword">if</span> (likely(err &lt;= <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line"> </span><br><span class="line">    tcp_enter_cwr(sk, <span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> net_xmit_eval(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="http://www.linuxtcpipstack.com/634.html" target="_blank" rel="noopener">http://www.linuxtcpipstack.com/634.html</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tcp_transmit_skb</span><span class="params">(struct sock *sk, struct sk_buff *skb, <span class="keyword">int</span> clone_it,</span></span></span><br><span class="line"><span class="function"><span class="params">			    <span class="keyword">gfp_t</span> gfp_mask)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">inet_connection_sock</span> *<span class="title">icsk</span> = <span class="title">inet_csk</span>(<span class="title">sk</span>);</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inet_sock</span> *<span class="title">inet</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcp_sock</span> *<span class="title">tp</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcp_skb_cb</span> *<span class="title">tcb</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcp_out_options</span> <span class="title">opts</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> tcp_options_size, tcp_header_size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcp_md5sig_key</span> *<span class="title">md5</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> *<span class="title">th</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	BUG_ON(!skb || !tcp_skb_pcount(skb));</span><br><span class="line">	tp = tcp_sk(sk);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">	<span class="keyword">if</span> (clone_it) &#123;</span><br><span class="line">		skb_mstamp_get(&amp;skb-&gt;skb_mstamp);</span><br><span class="line">		TCP_SKB_CB(skb)-&gt;tx.in_flight = TCP_SKB_CB(skb)-&gt;end_seq</span><br><span class="line">			- tp-&gt;snd_una;</span><br><span class="line">		tcp_rate_skb_sent(sk, skb);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* skb */</span></span><br><span class="line">		<span class="keyword">if</span> (unlikely(skb_cloned(skb)))</span><br><span class="line">			skb = pskb_copy(skb, gfp_mask);</span><br><span class="line">        <span class="comment">/*  */</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			skb = skb_clone(skb, gfp_mask);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*  */</span></span><br><span class="line">		<span class="keyword">if</span> (unlikely(!skb))</span><br><span class="line">			<span class="keyword">return</span> -ENOBUFS;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	inet = inet_sk(sk);</span><br><span class="line">	tcb = TCP_SKB_CB(skb);</span><br><span class="line">	<span class="built_in">memset</span>(&amp;opts, <span class="number">0</span>, <span class="keyword">sizeof</span>(opts));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* syntcp */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(tcb-&gt;tcp_flags &amp; TCPHDR_SYN))</span><br><span class="line">		tcp_options_size = tcp_syn_options(sk, skb, &amp;opts, &amp;md5);</span><br><span class="line">    <span class="comment">/* tcp */</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		tcp_options_size = tcp_established_options(sk, skb, &amp;opts,</span><br><span class="line">							   &amp;md5);</span><br><span class="line">    <span class="comment">/* tcp */</span></span><br><span class="line">	tcp_header_size = tcp_options_size + <span class="keyword">sizeof</span>(struct tcphdr);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* if no packet is in qdisc/device queue, then allow XPS to select</span></span><br><span class="line"><span class="comment">	 * another queue. We can be called from tcp_tsq_handler()</span></span><br><span class="line"><span class="comment">	 * which holds one reference to sk_wmem_alloc.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">TODO:</span> Ideally, in-flight pure ACK packets should not matter here.</span></span><br><span class="line"><span class="comment">	 * One way to get this would be to set skb-&gt;truesize = 2 on them.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	skb-&gt;ooo_okay = sk_wmem_alloc_get(sk) &lt; SKB_TRUESIZE(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* If we had to use memory reserve to allocate this skb,</span></span><br><span class="line"><span class="comment">	 * this might cause drops if packet is looped back :</span></span><br><span class="line"><span class="comment">	 * Other socket might not have SOCK_MEMALLOC.</span></span><br><span class="line"><span class="comment">	 * Packets not looped back do not care about pfmemalloc.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	skb-&gt;pfmemalloc = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* tcp */</span></span><br><span class="line">	skb_push(skb, tcp_header_size);</span><br><span class="line">	skb_reset_transport_header(skb);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">	skb_orphan(skb);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">	skb-&gt;sk = sk;</span><br><span class="line">	skb-&gt;destructor = skb_is_tcp_pure_ack(skb) ? __sock_wfree : tcp_wfree;</span><br><span class="line">	skb_set_hash_from_sk(skb, sk);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">	atomic_add(skb-&gt;truesize, &amp;sk-&gt;sk_wmem_alloc);</span><br><span class="line"></span><br><span class="line">	skb_set_dst_pending_confirm(skb, sk-&gt;sk_dst_pending_confirm);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Build TCP header and checksum it. */</span></span><br><span class="line">    <span class="comment">/* tcp */</span></span><br><span class="line">	th = (struct tcphdr *)skb-&gt;data;</span><br><span class="line">	th-&gt;source		= inet-&gt;inet_sport;</span><br><span class="line">	th-&gt;dest		= inet-&gt;inet_dport;</span><br><span class="line">	th-&gt;seq			= htonl(tcb-&gt;seq);</span><br><span class="line">	th-&gt;ack_seq		= htonl(tp-&gt;rcv_nxt);</span><br><span class="line">	*(((__be16 *)th) + <span class="number">6</span>)	= htons(((tcp_header_size &gt;&gt; <span class="number">2</span>) &lt;&lt; <span class="number">12</span>) |</span><br><span class="line">					tcb-&gt;tcp_flags);</span><br><span class="line"></span><br><span class="line">	th-&gt;check		= <span class="number">0</span>;</span><br><span class="line">	th-&gt;urg_ptr		= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* The urg_mode check is necessary during a below snd_una win probe */</span></span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(tcp_urg_mode(tp) &amp;&amp; before(tcb-&gt;seq, tp-&gt;snd_up))) &#123;</span><br><span class="line">		<span class="keyword">if</span> (before(tp-&gt;snd_up, tcb-&gt;seq + <span class="number">0x10000</span>)) &#123;</span><br><span class="line">			th-&gt;urg_ptr = htons(tp-&gt;snd_up - tcb-&gt;seq);</span><br><span class="line">			th-&gt;urg = <span class="number">1</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (after(tcb-&gt;seq + <span class="number">0xFFFF</span>, tp-&gt;snd_nxt)) &#123;</span><br><span class="line">			th-&gt;urg_ptr = htons(<span class="number">0xFFFF</span>);</span><br><span class="line">			th-&gt;urg = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* tcp */</span></span><br><span class="line">	tcp_options_write((__be32 *)(th + <span class="number">1</span>), tp, &amp;opts);</span><br><span class="line">	skb_shinfo(skb)-&gt;gso_type = sk-&gt;sk_gso_type;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* syn */</span></span><br><span class="line">	<span class="keyword">if</span> (likely(!(tcb-&gt;tcp_flags &amp; TCPHDR_SYN))) &#123;</span><br><span class="line">		th-&gt;window      = htons(tcp_select_window(sk));</span><br><span class="line">		tcp_ecn_send(sk, skb, th, tcp_header_size);</span><br><span class="line">	&#125; </span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/* RFC1323: The window in SYN &amp; SYN/ACK segments</span></span><br><span class="line"><span class="comment">		 * is never scaled.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		th-&gt;window	= htons(min(tp-&gt;rcv_wnd, <span class="number">65535U</span>));</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TCP_MD5SIG</span></span><br><span class="line">	<span class="comment">/* Calculate the MD5 hash, as we have all we need now */</span></span><br><span class="line">	<span class="keyword">if</span> (md5) &#123;</span><br><span class="line">		sk_nocaps_add(sk, NETIF_F_GSO_MASK);</span><br><span class="line">		tp-&gt;af_specific-&gt;calc_md5_hash(opts.hash_location,</span><br><span class="line">					       md5, sk, skb);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">	icsk-&gt;icsk_af_ops-&gt;send_check(sk, skb);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ack- */</span></span><br><span class="line">	<span class="keyword">if</span> (likely(tcb-&gt;tcp_flags &amp; TCPHDR_ACK))</span><br><span class="line">		tcp_event_ack_sent(sk, tcp_skb_pcount(skb));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">	<span class="keyword">if</span> (skb-&gt;len != tcp_header_size) &#123;</span><br><span class="line">		tcp_event_data_sent(tp, sk);</span><br><span class="line">		tp-&gt;data_segs_out += tcp_skb_pcount(skb);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">	<span class="keyword">if</span> (after(tcb-&gt;end_seq, tp-&gt;snd_nxt) || tcb-&gt;seq == tcb-&gt;end_seq)</span><br><span class="line">		TCP_ADD_STATS(sock_net(sk), TCP_MIB_OUTSEGS,</span><br><span class="line">			      tcp_skb_pcount(skb));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">	tp-&gt;segs_out += tcp_skb_pcount(skb);</span><br><span class="line">    </span><br><span class="line">	<span class="comment">/* OK, its time to fill skb_shinfo(skb)-&gt;gso_&#123;segs|size&#125; */</span></span><br><span class="line">    <span class="comment">/* skb */</span></span><br><span class="line">	skb_shinfo(skb)-&gt;gso_segs = tcp_skb_pcount(skb);</span><br><span class="line">	skb_shinfo(skb)-&gt;gso_size = tcp_skb_mss(skb);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Our usage of tstamp should remain private */</span></span><br><span class="line">	skb-&gt;tstamp = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Cleanup our debris for IP stacks */</span></span><br><span class="line">    <span class="comment">/* tcbip */</span></span><br><span class="line">	<span class="built_in">memset</span>(skb-&gt;cb, <span class="number">0</span>, max(<span class="keyword">sizeof</span>(struct inet_skb_parm),</span><br><span class="line">			       <span class="keyword">sizeof</span>(struct inet6_skb_parm)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* skb */</span></span><br><span class="line">	err = icsk-&gt;icsk_af_ops-&gt;queue_xmit(sk, skb, &amp;inet-&gt;cork.fl);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">	<span class="keyword">if</span> (likely(err &lt;= <span class="number">0</span>))</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* cwr */</span></span><br><span class="line">	tcp_enter_cwr(sk);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* err */</span></span><br><span class="line">	<span class="keyword">return</span> net_xmit_eval(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ip"><a href="#ip" class="headerlink" title="ip"></a>ip</h2><h3 id="ip-queue-xmit"><a href="#ip-queue-xmit" class="headerlink" title="ip_queue_xmit"></a>ip_queue_xmit</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Note: skb-&gt;sk can be different from sk, in case of tunnels */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ip_queue_xmit</span><span class="params">(struct sock *sk, struct sk_buff *skb, struct flowi *fl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inet_sock</span> *<span class="title">inet</span> = <span class="title">inet_sk</span>(<span class="title">sk</span>);</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> = <span class="title">sock_net</span>(<span class="title">sk</span>);</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ip_options_rcu</span> *<span class="title">inet_opt</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">flowi4</span> *<span class="title">fl4</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rtable</span> *<span class="title">rt</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iph</span>;</span></span><br><span class="line">	<span class="keyword">int</span> res;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Skip all of this if the packet is already routed,</span></span><br><span class="line"><span class="comment">	 * f.e. by something like SCTP.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	rcu_read_lock();</span><br><span class="line">	inet_opt = rcu_dereference(inet-&gt;inet_opt);</span><br><span class="line">	fl4 = &amp;fl-&gt;u.ip4;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* skb */</span></span><br><span class="line">	rt = skb_rtable(skb);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* skb */</span></span><br><span class="line">	<span class="keyword">if</span> (rt)</span><br><span class="line">		<span class="keyword">goto</span> packet_routed;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Make sure we can route this packet. */</span></span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">	rt = (struct rtable *)__sk_dst_check(sk, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">	<span class="keyword">if</span> (!rt) &#123;</span><br><span class="line">		__be32 daddr;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Use correct destination address if we have options. */</span></span><br><span class="line">        <span class="comment">/*  */</span></span><br><span class="line">		daddr = inet-&gt;inet_daddr;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*  */</span></span><br><span class="line">		<span class="keyword">if</span> (inet_opt &amp;&amp; inet_opt-&gt;opt.srr)</span><br><span class="line">			daddr = inet_opt-&gt;opt.faddr;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* If this fails, retransmit mechanism of transport layer will</span></span><br><span class="line"><span class="comment">		 * keep trying until route appears or the connection times</span></span><br><span class="line"><span class="comment">		 * itself out.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="comment">/*  */</span></span><br><span class="line">		rt = ip_route_output_ports(net, fl4, sk,</span><br><span class="line">					   daddr, inet-&gt;inet_saddr,</span><br><span class="line">					   inet-&gt;inet_dport,</span><br><span class="line">					   inet-&gt;inet_sport,</span><br><span class="line">					   sk-&gt;sk_protocol,</span><br><span class="line">					   RT_CONN_FLAGS(sk),</span><br><span class="line">					   sk-&gt;sk_bound_dev_if);</span><br><span class="line">        <span class="comment">/*  */</span></span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(rt))</span><br><span class="line">			<span class="keyword">goto</span> no_route;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*  */</span></span><br><span class="line">		sk_setup_caps(sk, &amp;rt-&gt;dst);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* skb */</span></span><br><span class="line">	skb_dst_set_noref(skb, &amp;rt-&gt;dst);</span><br><span class="line"></span><br><span class="line">packet_routed:</span><br><span class="line">    <span class="comment">/*     &amp;&amp; */</span></span><br><span class="line">	<span class="keyword">if</span> (inet_opt &amp;&amp; inet_opt-&gt;opt.is_strictroute &amp;&amp; rt-&gt;rt_uses_gateway)</span><br><span class="line">		<span class="keyword">goto</span> no_route;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* OK, we know where to send it, allocate and build IP header. */</span></span><br><span class="line">    <span class="comment">/* ip */</span></span><br><span class="line">	skb_push(skb, <span class="keyword">sizeof</span>(struct iphdr) + (inet_opt ? inet_opt-&gt;opt.optlen : <span class="number">0</span>));</span><br><span class="line">	skb_reset_network_header(skb);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ip */</span></span><br><span class="line">    iph = ip_hdr(skb);</span><br><span class="line">	*((__be16 *)iph) = htons((<span class="number">4</span> &lt;&lt; <span class="number">12</span>) | (<span class="number">5</span> &lt;&lt; <span class="number">8</span>) | (inet-&gt;tos &amp; <span class="number">0xff</span>));</span><br><span class="line">	<span class="keyword">if</span> (ip_dont_fragment(sk, &amp;rt-&gt;dst) &amp;&amp; !skb-&gt;ignore_df)</span><br><span class="line">		iph-&gt;frag_off = htons(IP_DF);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		iph-&gt;frag_off = <span class="number">0</span>;</span><br><span class="line">	iph-&gt;ttl      = ip_select_ttl(inet, &amp;rt-&gt;dst);</span><br><span class="line">	iph-&gt;protocol = sk-&gt;sk_protocol;</span><br><span class="line">	ip_copy_addrs(iph, fl4);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Transport layer set skb-&gt;h.foo itself. */</span></span><br><span class="line">    <span class="comment">/* ip */</span></span><br><span class="line">	<span class="keyword">if</span> (inet_opt &amp;&amp; inet_opt-&gt;opt.optlen) &#123;</span><br><span class="line">		iph-&gt;ihl += inet_opt-&gt;opt.optlen &gt;&gt; <span class="number">2</span>;</span><br><span class="line">		ip_options_build(skb, &amp;inet_opt-&gt;opt, inet-&gt;inet_daddr, rt, <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* id */</span></span><br><span class="line">	ip_select_ident_segs(net, skb, sk,</span><br><span class="line">			     skb_shinfo(skb)-&gt;gso_segs ?: <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO : should we use skb-&gt;sk here instead of sk ? */</span></span><br><span class="line">    <span class="comment">/* QOS */</span></span><br><span class="line">	skb-&gt;priority = sk-&gt;sk_priority;</span><br><span class="line">	skb-&gt;mark = sk-&gt;sk_mark;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">	res = ip_local_out(net, sk, skb);</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line"></span><br><span class="line">no_route:</span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">	rcu_read_unlock();</span><br><span class="line">	IP_INC_STATS(net, IPSTATS_MIB_OUTNOROUTES);</span><br><span class="line">	kfree_skb(skb);</span><br><span class="line">	<span class="keyword">return</span> -EHOSTUNREACH;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ip_build_and_send_pkt</span><span class="params">(struct sk_buff *skb, <span class="keyword">const</span> struct sock *sk,</span></span></span><br><span class="line"><span class="function"><span class="params">			  __be32 saddr, __be32 daddr, struct ip_options_rcu *opt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inet_sock</span> *<span class="title">inet</span> = <span class="title">inet_sk</span>(<span class="title">sk</span>);</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rtable</span> *<span class="title">rt</span> = <span class="title">skb_rtable</span>(<span class="title">skb</span>);</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> = <span class="title">sock_net</span>(<span class="title">sk</span>);</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iph</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Build the IP header. */</span></span><br><span class="line">    <span class="comment">/* ip */</span></span><br><span class="line">	skb_push(skb, <span class="keyword">sizeof</span>(struct iphdr) + (opt ? opt-&gt;opt.optlen : <span class="number">0</span>));</span><br><span class="line">	skb_reset_network_header(skb);</span><br><span class="line">	iph = ip_hdr(skb);</span><br><span class="line">	iph-&gt;version  = <span class="number">4</span>;</span><br><span class="line">	iph-&gt;ihl      = <span class="number">5</span>;</span><br><span class="line">	iph-&gt;tos      = inet-&gt;tos;</span><br><span class="line">	iph-&gt;ttl      = ip_select_ttl(inet, &amp;rt-&gt;dst);</span><br><span class="line">	iph-&gt;daddr    = (opt &amp;&amp; opt-&gt;opt.srr ? opt-&gt;opt.faddr : daddr);</span><br><span class="line">	iph-&gt;saddr    = saddr;</span><br><span class="line">	iph-&gt;protocol = sk-&gt;sk_protocol;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">	<span class="keyword">if</span> (ip_dont_fragment(sk, &amp;rt-&gt;dst)) &#123;</span><br><span class="line">		iph-&gt;frag_off = htons(IP_DF);</span><br><span class="line">		iph-&gt;id = <span class="number">0</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		iph-&gt;frag_off = <span class="number">0</span>;</span><br><span class="line">		__ip_select_ident(net, iph, <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">	<span class="keyword">if</span> (opt &amp;&amp; opt-&gt;opt.optlen) &#123;</span><br><span class="line">		iph-&gt;ihl += opt-&gt;opt.optlen&gt;&gt;<span class="number">2</span>;</span><br><span class="line">		ip_options_build(skb, &amp;opt-&gt;opt, daddr, rt, <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* QOS */</span></span><br><span class="line">	skb-&gt;priority = sk-&gt;sk_priority;</span><br><span class="line">	skb-&gt;mark = sk-&gt;sk_mark;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Send it out. */</span></span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">	<span class="keyword">return</span> ip_local_out(net, skb-&gt;sk, skb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ip_send_unicast_reply</span><span class="params">(struct sock *sk, struct sk_buff *skb,</span></span></span><br><span class="line"><span class="function"><span class="params">			   <span class="keyword">const</span> struct ip_options *sopt,</span></span></span><br><span class="line"><span class="function"><span class="params">			   __be32 daddr, __be32 saddr,</span></span></span><br><span class="line"><span class="function"><span class="params">			   <span class="keyword">const</span> struct ip_reply_arg *arg,</span></span></span><br><span class="line"><span class="function"><span class="params">			   <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ip_options_data</span> <span class="title">replyopts</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ipcm_cookie</span> <span class="title">ipc</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">flowi4</span> <span class="title">fl4</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rtable</span> *<span class="title">rt</span> = <span class="title">skb_rtable</span>(<span class="title">skb</span>);</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> = <span class="title">sock_net</span>(<span class="title">sk</span>);</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">nskb</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">	<span class="keyword">int</span> oif;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ip */</span></span><br><span class="line">	<span class="keyword">if</span> (__ip_options_echo(&amp;replyopts.opt.opt, skb, sopt))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	ipc.addr = daddr;</span><br><span class="line">	ipc.opt = <span class="literal">NULL</span>;</span><br><span class="line">	ipc.tx_flags = <span class="number">0</span>;</span><br><span class="line">	ipc.ttl = <span class="number">0</span>;</span><br><span class="line">	ipc.tos = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">	<span class="keyword">if</span> (replyopts.opt.opt.optlen) &#123;</span><br><span class="line">		ipc.opt = &amp;replyopts.opt;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* ip */</span></span><br><span class="line">		<span class="keyword">if</span> (replyopts.opt.opt.srr)</span><br><span class="line">			daddr = replyopts.opt.opt.faddr;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">	oif = arg-&gt;bound_dev_if;</span><br><span class="line">	<span class="keyword">if</span> (!oif &amp;&amp; netif_index_is_l3_master(net, skb-&gt;skb_iif))</span><br><span class="line">		oif = skb-&gt;skb_iif;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">	flowi4_init_output(&amp;fl4, oif,</span><br><span class="line">			   IP4_REPLY_MARK(net, skb-&gt;mark),</span><br><span class="line">			   RT_TOS(arg-&gt;tos),</span><br><span class="line">			   RT_SCOPE_UNIVERSE, ip_hdr(skb)-&gt;protocol,</span><br><span class="line">			   ip_reply_arg_flowi_flags(arg),</span><br><span class="line">			   daddr, saddr,</span><br><span class="line">			   tcp_hdr(skb)-&gt;source, tcp_hdr(skb)-&gt;dest,</span><br><span class="line">			   arg-&gt;uid);</span><br><span class="line">	security_skb_classify_flow(skb, flowi4_to_flowi(&amp;fl4));</span><br><span class="line">	rt = ip_route_output_key(net, &amp;fl4);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(rt))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* skbsk */</span></span><br><span class="line">	inet_sk(sk)-&gt;tos = arg-&gt;tos;</span><br><span class="line"></span><br><span class="line">	sk-&gt;sk_priority = skb-&gt;priority;</span><br><span class="line">	sk-&gt;sk_protocol = ip_hdr(skb)-&gt;protocol;</span><br><span class="line">	sk-&gt;sk_bound_dev_if = arg-&gt;bound_dev_if;</span><br><span class="line">	sk-&gt;sk_sndbuf = sysctl_wmem_default;</span><br><span class="line">	sk-&gt;sk_mark = fl4.flowi4_mark;</span><br><span class="line">    <span class="comment">/* skbskb */</span></span><br><span class="line">	err = ip_append_data(sk, &amp;fl4, ip_reply_glue_bits, arg-&gt;iov-&gt;iov_base,</span><br><span class="line">			     len, <span class="number">0</span>, &amp;ipc, &amp;rt, MSG_DONTWAIT);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(err)) &#123;</span><br><span class="line">		ip_flush_pending_frames(sk);</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* skb */</span></span><br><span class="line">	nskb = skb_peek(&amp;sk-&gt;sk_write_queue);</span><br><span class="line">	<span class="keyword">if</span> (nskb) &#123;</span><br><span class="line">		<span class="keyword">if</span> (arg-&gt;csumoffset &gt;= <span class="number">0</span>)</span><br><span class="line">			*((__sum16 *)skb_transport_header(nskb) +</span><br><span class="line">			  arg-&gt;csumoffset) = csum_fold(csum_add(nskb-&gt;csum,</span><br><span class="line">								arg-&gt;csum));</span><br><span class="line">		nskb-&gt;ip_summed = CHECKSUM_NONE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*  */</span></span><br><span class="line">		ip_push_pending_frames(sk, &amp;fl4);</span><br><span class="line">	&#125;</span><br><span class="line">out:</span><br><span class="line">	ip_rt_put(rt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ip-push-pending-frames"><a href="#ip-push-pending-frames" class="headerlink" title="ip_push_pending_frames"></a>ip_push_pending_frames</h3><p>icmp_push_replyip_send_replyraw_sendmsgudp_push_pending_framessocketpendingIPIP</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ip_push_pending_frames</span><span class="params">(struct sock *sk)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>, *<span class="title">tmp_skb</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> **<span class="title">tail_skb</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inet_sock</span> *<span class="title">inet</span> = <span class="title">inet_sk</span>(<span class="title">sk</span>);</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> = <span class="title">sock_net</span>(<span class="title">sk</span>);</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ip_options</span> *<span class="title">opt</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtable</span> *<span class="title">rt</span> = (<span class="title">struct</span> <span class="title">rtable</span> *)<span class="title">inet</span>-&gt;<span class="title">cork</span>.<span class="title">dst</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iph</span>;</span></span><br><span class="line">    __be16 df = <span class="number">0</span>;</span><br><span class="line">    __u8 ttl;</span><br><span class="line">    <span class="keyword">int</span> err = <span class="number">0</span>;</span><br><span class="line">     <span class="comment">/*  */</span></span><br><span class="line">    <span class="keyword">if</span> ((skb = __skb_dequeue(&amp;sk-&gt;sk_write_queue)) == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">    tail_skb = &amp;(skb_shinfo(skb)-&gt;frag_list);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* move skb-&gt;data to ip header from ext header */</span></span><br><span class="line">    <span class="comment">/* data */</span></span><br><span class="line">    <span class="keyword">if</span> (skb-&gt;data skb_network_header(skb))</span><br><span class="line">        __skb_pull(skb, skb_network_offset(skb));</span><br><span class="line">     <span class="comment">/* sk_buffdatask_buff */</span></span><br><span class="line">    <span class="keyword">while</span> ((tmp_skb = __skb_dequeue(&amp;sk-&gt;sk_write_queue)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        __skb_pull(tmp_skb, skb_network_header_len(skb));</span><br><span class="line">        *tail_skb = tmp_skb;</span><br><span class="line">        tail_skb = &amp;(tmp_skb-&gt;next);</span><br><span class="line">        skb-&gt;len = tmp_skb-&gt;len;</span><br><span class="line">        skb-&gt;data_len = tmp_skb-&gt;len;</span><br><span class="line">        skb-&gt;truesize = tmp_skb-&gt;truesize;</span><br><span class="line">        tmp_skb-&gt;destructor = <span class="literal">NULL</span>;</span><br><span class="line">        tmp_skb-&gt;sk = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Unless user demanded real pmtu discovery (IP_PMTUDISC_DO), we allow</span></span><br><span class="line"><span class="comment">     * to fragment the frame generated here. No matter, what transforms</span></span><br><span class="line"><span class="comment">     * how transforms change size of the packet, it will come out.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">    <span class="keyword">if</span> (inet-&gt;pmtudisc IP_PMTUDISC_DO)</span><br><span class="line">        skb-&gt;local_df = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* DF bit is set when we want to see DF on outgoing frames.</span></span><br><span class="line"><span class="comment">     * If local_df is set too, we still allow to fragment this frame</span></span><br><span class="line"><span class="comment">     * locally. */</span></span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">    <span class="keyword">if</span> (inet-&gt;pmtudisc &gt;= IP_PMTUDISC_DO ||</span><br><span class="line">     (skb-&gt;len = dst_mtu(&amp;rt-&gt;dst) &amp;&amp;</span><br><span class="line">     ip_dont_fragment(sk, &amp;rt-&gt;dst)))</span><br><span class="line">        df = htons(IP_DF);</span><br><span class="line">      <span class="comment">/* ip option cork corkoption */</span></span><br><span class="line">    <span class="keyword">if</span> (inet-&gt;cork.flags &amp; IPCORK_OPT)</span><br><span class="line">        opt = inet-&gt;cork.opt;</span><br><span class="line">      <span class="comment">/* TTL */</span></span><br><span class="line">    <span class="keyword">if</span> (rt-&gt;rt_type == RTN_MULTICAST)</span><br><span class="line">        ttl = inet-&gt;mc_ttl;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        ttl = ip_select_ttl(inet, &amp;rt-&gt;dst);</span><br><span class="line">     <span class="comment">/* IP */</span> </span><br><span class="line">    iph = (struct iphdr *)skb-&gt;data;</span><br><span class="line">    <span class="comment">/* IP */</span></span><br><span class="line">    iph-&gt;version = <span class="number">4</span>;</span><br><span class="line">    iph-&gt;ihl = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">if</span> (opt) &#123;</span><br><span class="line">        <span class="comment">/* </span></span><br><span class="line"><span class="comment">        IP option</span></span><br><span class="line"><span class="comment">        optcork</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        iph-&gt;ihl = opt-&gt;optlen&gt;&gt;<span class="number">2</span>;</span><br><span class="line">        ip_options_build(skb, opt, inet-&gt;cork.addr, rt, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    iph-&gt;tos = inet-&gt;tos;</span><br><span class="line">    iph-&gt;frag_off = df;</span><br><span class="line">    ip_select_ident(iph, &amp;rt-&gt;dst, sk);</span><br><span class="line">    iph-&gt;ttl = ttl;</span><br><span class="line">    iph-&gt;protocol = sk-&gt;sk_protocol;</span><br><span class="line">    iph-&gt;saddr = rt-&gt;rt_src;</span><br><span class="line">    iph-&gt;daddr = rt-&gt;rt_dst;</span><br><span class="line"></span><br><span class="line">    skb-&gt;priority = sk-&gt;sk_priority;</span><br><span class="line">    skb-&gt;mark = sk-&gt;sk_mark;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Steal rt from cork.dst to avoid a pair of atomic_inc/atomic_dec</span></span><br><span class="line"><span class="comment">     * on dst refcount</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    inet-&gt;cork.dst = <span class="literal">NULL</span>;</span><br><span class="line">    skb_dst_set(skb, &amp;rt-&gt;dst);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (iph-&gt;protocol == IPPROTO_ICMP)</span><br><span class="line">        icmp_out_count(net, ((struct icmphdr *)</span><br><span class="line">            skb_transport_header(skb))-&gt;type);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Netfilter gets whole the not fragmented skb. */</span></span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">    err = ip_local_out(skb);</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">if</span> (err &gt; <span class="number">0</span>)</span><br><span class="line">            err = net_xmit_errno(err);</span><br><span class="line">        <span class="keyword">if</span> (err)</span><br><span class="line">            <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">    ip_cork_release(inet);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">error:</span><br><span class="line">    IP_INC_STATS(net, IPSTATS_MIB_OUTDISCARDS);</span><br><span class="line">    <span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ip-output"><a href="#ip-output" class="headerlink" title="ip_output"></a>ip_output</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ip_output</span><span class="params">(struct sock *sk, struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">dev</span> = <span class="title">skb_dst</span>(<span class="title">skb</span>)-&gt;<span class="title">dev</span>;</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    IP_UPD_PO_STATS(dev_net(dev), IPSTATS_MIB_OUT, skb-&gt;len);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    skb-&gt;dev = dev;</span><br><span class="line">    skb-&gt;protocol = htons(ETH_P_IP);   <span class="comment">//IPV4</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> NF_HOOK_COND(NFPROTO_IPV4, NF_INET_POST_ROUTING, sk, skb,</span><br><span class="line">         <span class="literal">NULL</span>, dev,</span><br><span class="line">         ip_finish_output,   <span class="comment">//netfilterip_finish_output</span></span><br><span class="line">        !(IPCB(skb)-&gt;flags &amp; IPSKB_REROUTED));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">ip_finish_output2</span><span class="params">(struct sock *sk, struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dst_entry</span> *<span class="title">dst</span> = <span class="title">skb_dst</span>(<span class="title">skb</span>);</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rtable</span> *<span class="title">rt</span> = (<span class="title">struct</span> <span class="title">rtable</span> *)<span class="title">dst</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">dev</span> = <span class="title">dst</span>-&gt;<span class="title">dev</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> hh_len = LL_RESERVED_SPACE(dev);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">neighbour</span> *<span class="title">neigh</span>;</span></span><br><span class="line">	u32 nexthop;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">if</span> (rt-&gt;rt_type == RTN_MULTICAST) &#123;</span><br><span class="line">		IP_UPD_PO_STATS(dev_net(dev), IPSTATS_MIB_OUTMCAST, skb-&gt;len);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (rt-&gt;rt_type == RTN_BROADCAST)</span><br><span class="line">		IP_UPD_PO_STATS(dev_net(dev), IPSTATS_MIB_OUTBCAST, skb-&gt;len);</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/* Be paranoid, rather than too clever. */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(skb_headroom(skb) &lt; hh_len &amp;&amp; dev-&gt;header_ops)) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb2</span>;</span></span><br><span class="line"> </span><br><span class="line">		skb2 = skb_realloc_headroom(skb, LL_RESERVED_SPACE(dev));</span><br><span class="line">		<span class="keyword">if</span> (!skb2) &#123;</span><br><span class="line">			kfree_skb(skb);</span><br><span class="line">			<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (skb-&gt;sk)</span><br><span class="line">			skb_set_owner_w(skb2, skb-&gt;sk);</span><br><span class="line">		consume_skb(skb);</span><br><span class="line">		skb = skb2;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	rcu_read_lock_bh();</span><br><span class="line">	nexthop = (__force u32) rt_nexthop(rt, ip_hdr(skb)-&gt;daddr);</span><br><span class="line">	neigh = __ipv4_neigh_lookup_noref(dev, nexthop);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!neigh))</span><br><span class="line">		neigh = __neigh_create(&amp;arp_tbl, &amp;nexthop, dev, <span class="literal">false</span>);</span><br><span class="line">	<span class="keyword">if</span> (!IS_ERR(neigh)) &#123;</span><br><span class="line">		<span class="keyword">int</span> res = dst_neigh_output(dst, neigh, skb);	<span class="comment">//MAC</span></span><br><span class="line"> </span><br><span class="line">		rcu_read_unlock_bh();</span><br><span class="line">		<span class="keyword">return</span> res;</span><br><span class="line">	&#125;</span><br><span class="line">	rcu_read_unlock_bh();</span><br><span class="line"> </span><br><span class="line">	net_dbg_ratelimited(<span class="string">"%s: No header cache and no neighbour!\n"</span>,</span><br><span class="line">			    __func__);</span><br><span class="line">	kfree_skb(skb);</span><br><span class="line">	<span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>##</p>
<h3 id="dev-queue-xmit"><a href="#dev-queue-xmit" class="headerlink" title="dev_queue_xmit"></a>dev_queue_xmit</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __dev_queue_xmit(struct sk_buff *skb, <span class="keyword">void</span> *accel_priv)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">dev</span> = <span class="title">skb</span>-&gt;<span class="title">dev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">netdev_queue</span> *<span class="title">txq</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Qdisc</span> *<span class="title">q</span>;</span></span><br><span class="line">	<span class="keyword">int</span> rc = -ENOMEM;</span><br><span class="line"> </span><br><span class="line">	skb_reset_mac_header(skb);</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">if</span> (unlikely(skb_shinfo(skb)-&gt;tx_flags &amp; SKBTX_SCHED_TSTAMP))</span><br><span class="line">		__skb_tstamp_tx(skb, <span class="literal">NULL</span>, skb-&gt;sk, SCM_TSTAMP_SCHED);</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/* Disable soft irqs for various locks below. Also</span></span><br><span class="line"><span class="comment">	 * stops preemption for RCU.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	rcu_read_lock_bh();</span><br><span class="line"> </span><br><span class="line">	skb_update_prio(skb);</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/* If device/qdisc don't need skb-&gt;dst, release it right now while</span></span><br><span class="line"><span class="comment">	 * its hot in this cpu cache.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="comment">/*netdevcieflagskb DSTflag</span></span><br><span class="line"><span class="comment">	 *alloc_netdev_mqs...</span></span><br><span class="line"><span class="comment">	 *dev-&gt;priv_flags = IFF_XMIT_DST_RELEASE | IFF_XMIT_DST_RELEASE_PERM;</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (dev-&gt;priv_flags &amp; IFF_XMIT_DST_RELEASE)</span><br><span class="line">		skb_dst_drop(skb);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		skb_dst_force(skb);</span><br><span class="line">		</span><br><span class="line">        <span class="comment">/*netdevicetxqtxqQdisc,Qdisc</span></span><br><span class="line"><span class="comment">         *driverBusyQdisc*/</span></span><br><span class="line">	txq = netdev_pick_tx(dev, skb, accel_priv);</span><br><span class="line">	q = rcu_dereference_bh(txq-&gt;qdisc);</span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NET_CLS_ACT</span></span><br><span class="line">	skb-&gt;tc_verd = SET_TC_AT(skb-&gt;tc_verd, AT_EGRESS);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	trace_net_dev_queue(skb);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*Qdiscenqueue__dev_xmit_skbFlow</span></span><br><span class="line"><span class="comment">	 *FlowenqueueBusyQdiscenqueue/dequeue</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (q-&gt;enqueue) &#123;</span><br><span class="line">		rc = __dev_xmit_skb(skb, q, dev, txq);</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/* The device has no queue. Common case for software devices:</span></span><br><span class="line"><span class="comment">	   loopback, all the sorts of tunnels...</span></span><br><span class="line"><span class="comment">	   Really, it is unlikely that netif_tx_lock protection is necessary</span></span><br><span class="line"><span class="comment">	   here.  (f.e. loopback and IP tunnels are clean ignoring statistics</span></span><br><span class="line"><span class="comment">	   counters.)</span></span><br><span class="line"><span class="comment">	   However, it is possible, that they rely on protection</span></span><br><span class="line"><span class="comment">	   made by us here.</span></span><br><span class="line"><span class="comment">	   Check this and shot the lock. It is not prone from deadlocks.</span></span><br><span class="line"><span class="comment">	   Either shot noqueue qdisc, it is even simpler 8)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	 </span><br><span class="line">	<span class="comment">/*Qdiscenqueue/dequeue</span></span><br><span class="line"><span class="comment">	 *loopback/tunnel interfaceUP*/</span></span><br><span class="line">	<span class="keyword">if</span> (dev-&gt;flags &amp; IFF_UP) &#123;</span><br><span class="line">		<span class="keyword">int</span> cpu = smp_processor_id(); <span class="comment">/* ok because BHs are off */</span></span><br><span class="line"> </span><br><span class="line">		<span class="keyword">if</span> (txq-&gt;xmit_lock_owner != cpu) &#123;</span><br><span class="line"> </span><br><span class="line">			<span class="keyword">if</span> (__this_cpu_read(xmit_recursion) &gt; RECURSION_LIMIT)</span><br><span class="line">				<span class="keyword">goto</span> recursion_alert;</span><br><span class="line">			skb = validate_xmit_skb(skb, dev);</span><br><span class="line">			<span class="keyword">if</span> (!skb)</span><br><span class="line">				<span class="keyword">goto</span> drop;</span><br><span class="line"> </span><br><span class="line">			HARD_TX_LOCK(dev, txq, cpu);</span><br><span class="line">                       <span class="comment">/*txqstopdev_hard_start_xmit*/</span></span><br><span class="line">			<span class="keyword">if</span> (!netif_xmit_stopped(txq)) &#123;</span><br><span class="line">				__this_cpu_inc(xmit_recursion);</span><br><span class="line">				skb = dev_hard_start_xmit(skb, dev, txq, &amp;rc);</span><br><span class="line">				__this_cpu_dec(xmit_recursion);</span><br><span class="line">				<span class="keyword">if</span> (dev_xmit_complete(rc)) &#123;</span><br><span class="line">					HARD_TX_UNLOCK(dev, txq);</span><br><span class="line">					<span class="keyword">goto</span> out;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			HARD_TX_UNLOCK(dev, txq);</span><br><span class="line">			net_crit_ratelimited(<span class="string">"Virtual device %s asks to queue packet!\n"</span>,</span><br><span class="line">					     dev-&gt;name);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">/* Recursion is detected! It is possible,</span></span><br><span class="line"><span class="comment">			 * unfortunately</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">recursion_alert:</span><br><span class="line">			net_crit_ratelimited(<span class="string">"Dead loop on virtual device %s, fix it urgently!\n"</span>,</span><br><span class="line">					     dev-&gt;name);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	rc = -ENETDOWN;</span><br><span class="line">drop:</span><br><span class="line">	rcu_read_unlock_bh();</span><br><span class="line"> </span><br><span class="line">	atomic_long_inc(&amp;dev-&gt;tx_dropped);</span><br><span class="line">	kfree_skb_list(skb);</span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">out:</span><br><span class="line">	rcu_read_unlock_bh();</span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="dev-xmit-skb"><a href="#dev-xmit-skb" class="headerlink" title="__dev_xmit_skb"></a>__dev_xmit_skb</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> __dev_xmit_skb(struct sk_buff *skb, struct Qdisc *q,</span><br><span class="line">				 struct net_device *dev,</span><br><span class="line">				 struct netdev_queue *txq)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">spinlock_t</span> *root_lock = qdisc_lock(q);</span><br><span class="line">	<span class="keyword">bool</span> contended;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line"> </span><br><span class="line">	qdisc_pkt_len_init(skb);</span><br><span class="line">	qdisc_calculate_pkt_len(skb, q);</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Heuristic to force contended enqueues to serialize on a</span></span><br><span class="line"><span class="comment">	 * separate lock before trying to get qdisc main lock.</span></span><br><span class="line"><span class="comment">	 * This permits __QDISC___STATE_RUNNING owner to get the lock more</span></span><br><span class="line"><span class="comment">	 * often and dequeue packets faster.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	contended = qdisc_is_running(q);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(contended))</span><br><span class="line">		spin_lock(&amp;q-&gt;busylock);</span><br><span class="line"> </span><br><span class="line">	spin_lock(root_lock);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*Qdiscstate: __QDISC_STATE_DEACTIVATED,DROPNET_XMIT_DROP</span></span><br><span class="line"><span class="comment">	 *Qdiscinterfacecloseflag */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(test_bit(__QDISC_STATE_DEACTIVATED, &amp;q-&gt;state))) &#123;</span><br><span class="line">		kfree_skb(skb);</span><br><span class="line">		rc = NET_XMIT_DROP;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((q-&gt;flags &amp; TCQ_F_CAN_BYPASS) &amp;&amp; !qdisc_qlen(q) &amp;&amp;</span><br><span class="line">		   qdisc_run_begin(q)) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * This is a work-conserving queue; there are no old skbs</span></span><br><span class="line"><span class="comment">		 * waiting to be sent out; and the qdisc is not running -</span></span><br><span class="line"><span class="comment">		 * xmit the skb directly.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">                <span class="comment">/* code3</span></span><br><span class="line"><span class="comment">                 * 1.flagTCQ_F_CAN_BYPASSBy PASS Qdisc</span></span><br><span class="line"><span class="comment">                 * 2.qlen0Qdisc</span></span><br><span class="line"><span class="comment">                 * 3.Qdisc runningRunning</span></span><br><span class="line"><span class="comment">                 * 3sch_direct_xmit</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">		qdisc_bstats_update(q, skb);</span><br><span class="line"> </span><br><span class="line">                <span class="comment">/**/</span></span><br><span class="line">		<span class="keyword">if</span> (sch_direct_xmit(skb, q, dev, txq, root_lock, <span class="literal">true</span>)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (unlikely(contended)) &#123;</span><br><span class="line">				spin_unlock(&amp;q-&gt;busylock);</span><br><span class="line">				contended = <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			__qdisc_run(q);</span><br><span class="line">		&#125; <span class="keyword">else</span></span><br><span class="line">			qdisc_run_end(q);</span><br><span class="line"> </span><br><span class="line">		rc = NET_XMIT_SUCCESS;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	</span><br><span class="line">	   <span class="comment">/*3enqueue</span></span><br><span class="line"><span class="comment">	    *q*/</span></span><br><span class="line">		rc = q-&gt;enqueue(skb, q) &amp; NET_XMIT_MASK;</span><br><span class="line">		<span class="keyword">if</span> (qdisc_run_begin(q)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (unlikely(contended)) &#123;</span><br><span class="line">				spin_unlock(&amp;q-&gt;busylock);</span><br><span class="line">				contended = <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			__qdisc_run(q);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	spin_unlock(root_lock);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(contended))</span><br><span class="line">		spin_unlock(&amp;q-&gt;busylock);</span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="dev-hard-start-xmit"><a href="#dev-hard-start-xmit" class="headerlink" title="dev_hard_start_xmit"></a>dev_hard_start_xmit</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct sk_buff *<span class="title">dev_hard_start_xmit</span><span class="params">(struct sk_buff *first, struct net_device *dev,</span></span></span><br><span class="line"><span class="function"><span class="params">				    struct netdev_queue *txq, <span class="keyword">int</span> *ret)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span> = <span class="title">first</span>;</span></span><br><span class="line">	<span class="keyword">int</span> rc = NETDEV_TX_OK;</span><br><span class="line">       <span class="comment">/*skb*/</span></span><br><span class="line">	<span class="keyword">while</span> (skb) &#123;</span><br><span class="line">	      <span class="comment">/*skb*/</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">next</span> = <span class="title">skb</span>-&gt;<span class="title">next</span>;</span></span><br><span class="line">              <span class="comment">/*next*/</span></span><br><span class="line">		skb-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">		</span><br><span class="line">	       <span class="comment">/*driver Txdequeuenetx*/</span></span><br><span class="line">		rc = xmit_one(skb, dev, txq, next != <span class="literal">NULL</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/*nextskb-&gt;next */</span></span><br><span class="line">		<span class="keyword">if</span> (unlikely(!dev_xmit_complete(rc))) &#123;</span><br><span class="line">			skb-&gt;next = next;</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line">                <span class="comment">/*nextskbnext */</span></span><br><span class="line">		skb = next;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/*txqstopskbTX Busy*/</span></span><br><span class="line">		<span class="keyword">if</span> (netif_xmit_stopped(txq) &amp;&amp; skb) &#123;</span><br><span class="line">			rc = NETDEV_TX_BUSY;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">out:</span><br><span class="line">	*ret = rc;</span><br><span class="line">	<span class="keyword">return</span> skb;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">xmit_one</span><span class="params">(struct sk_buff *skb, struct net_device *dev,</span></span></span><br><span class="line"><span class="function"><span class="params">		    struct netdev_queue *txq, <span class="keyword">bool</span> more)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> len;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*such as Tcpdump*/</span></span><br><span class="line">	<span class="keyword">if</span> (!list_empty(&amp;ptype_all))</span><br><span class="line">		dev_queue_xmit_nit(skb, dev);</span><br><span class="line"> </span><br><span class="line">	len = skb-&gt;len;</span><br><span class="line">	trace_net_dev_start_xmit(skb, dev);</span><br><span class="line">        <span class="comment">/*netdev_start_xmitdrivertx*/</span></span><br><span class="line">	rc = netdev_start_xmit(skb, dev, txq, more);</span><br><span class="line">	trace_net_dev_xmit(skb, rc, dev, len);</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> netdev_tx_t <span class="title">netdev_start_xmit</span><span class="params">(struct sk_buff *skb, struct net_device *dev,</span></span></span><br><span class="line"><span class="function"><span class="params">					    struct netdev_queue *txq, <span class="keyword">bool</span> more)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_device_ops</span> *<span class="title">ops</span> = <span class="title">dev</span>-&gt;<span class="title">netdev_ops</span>;</span></span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line">	<span class="comment">/*__netdev_start_xmit driver opsskbnetdevice</span></span><br><span class="line"><span class="comment">	 *driverdriver*/</span></span><br><span class="line">	rc = __netdev_start_xmit(ops, skb, dev, more);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*NETDEV_TX_OKTxqtranstxq-&gt;trans_start = jiffies;*/</span></span><br><span class="line">	<span class="keyword">if</span> (rc == NETDEV_TX_OK)</span><br><span class="line">		txq_trans_update(txq);</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">netdev_tx_t</span> __netdev_start_xmit(<span class="keyword">const</span> struct net_device_ops *ops,</span><br><span class="line">					      struct sk_buff *skb, struct net_device *dev,</span><br><span class="line">					      <span class="keyword">bool</span> more)</span><br><span class="line">&#123;</span><br><span class="line">	skb-&gt;xmit_more = more ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> ops-&gt;ndo_start_xmit(skb, dev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="http://blog.51cto.com/yaoyang/1359420" target="_blank" rel="noopener">http://blog.51cto.com/yaoyang/1359420</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/04/network/network/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/04/network/network/" itemprop="url">.network</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-04T11:11:16+08:00">
                2019-10-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>1.<br>2.<br>    time_wait:<br>    close_wait: close<br>3.<br>    a.<br>    b.</p>
<h1 id="network"><a href="#network" class="headerlink" title="network"></a>network</h1><h2 id="tcp"><a href="#tcp" class="headerlink" title="tcp"></a>tcp</h2><p></p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><ul>
<li></li>
</ul>
<ol>
<li>,sync(cid)</li>
<li> sync(sid),ack(cid+1)</li>
<li>ack(sid+1)</li>
</ol>
<ul>
<li></li>
</ul>
<ol>
<li>fin:fin(cid) c: estabished-&gt;Fin_wait1, s : estabished-&gt;CLOSE_WAIT</li>
<li>ack :ack(cid+1) c: Fin_wait1-&gt;Fin_wait2 s:nothing to change</li>
<li>fin: fin(sid) c:Fin_wait2-&gt;Time_wait, s: CLOSE_WAIT LAST_ACK</li>
<li>ack: ack(sid+1) c Time_wait s:Last_ack close</li>
</ol>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><ul>
<li>TCP</li>
<li>TCP ,,,</li>
<li>TCP TCP,,</li>
<li>TCP,</li>
<li>ip</li>
<li></li>
<li>,tcp</li>
</ul>
<p>mq</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>time_wait:<br>close_wait: close</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>vim /etc/security/limits.conf</p>
<ul>
<li>soft nofile 655350</li>
<li>hard nofile 655350</li>
</ul>
<p>#SYN CookiesSYNcookiesSYN0<br>net.ipv4.tcp_syncookies = 1</p>
<p>#TIME-WAIT socketsTCP0<br>net.ipv4.tcp_tw_reuse = 1</p>
<p>#TCPTIME-WAIT sockets0<br>net.ipv4.tcp_tw_recycle = 1</p>
<p>#FIN-WAIT-2<br>net.ipv4.tcp_fin_timeout=30</p>
<p>#TIME_WAIT<br>net.ipv4.tcp_max_tw_buckets = 20000</p>
<p>#<br>net.core.somaxconn = 65535</p>
<p>#<br>net.ipv4.tcp_max_syn_backlog = 262144</p>
<p>#<br>net.core.netdev_max_backlog = 30000</p>
<p>#TIME-WAITNAT0<br>net.ipv4.tcp_tw_recycle = 0</p>
<p>#<br>fs.file-max = 6815744</p>
<p>#<br>fs.nr_open</p>
<p>net.ipv4.tcp_tw_reuse = 1<br>net.ipv4.tcp_tw_recycle = 1</p>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><p>, , hashSIP,SPORT,DIP,DPORT,.<br>kernel2.6.21<br>Sum=MinqueueCPU corequeueSumSumqueue</p>
<p>queueNET_RX_SOFTIRQNET_RX_SOFTIRQNET_RX_SOFTIRQNAPICPU3.2netdev_queuenet_device</p>
<p>CPUIO<br><img src="./pic/multi_queue.gif" alt></p>
<h3 id="tcp-fast-open"><a href="#tcp-fast-open" class="headerlink" title="tcp fast open"></a>tcp fast open</h3><ul>
<li> 3.7.0</li>
<li>TCPcookieSYNTCPSYN</li>
</ul>
<ol>
<li><p>SYNcookie</p>
</li>
<li><p>cookieSYNACKACKSYNserverclientTCP(RFC5681)</p>
<p> SYNACKACKSYN</p>
</li>
<li><p>SYNACK</p>
</li>
<li><p>SYNACKSYNACK</p>
</li>
<li><p>TCP</p>
</li>
</ol>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>reuseaddr : time_wait<br>reuseport : </p>
<h2 id="udp"><a href="#udp" class="headerlink" title="udp"></a>udp</h2><p></p>
<p><a href="https://blog.csdn.net/turkeyzhou/article/details/7528182" target="_blank" rel="noopener">https://blog.csdn.net/turkeyzhou/article/details/7528182</a><br><a href="https://blog.csdn.net/for_tech/article/details/54237556" target="_blank" rel="noopener">https://blog.csdn.net/for_tech/article/details/54237556</a> </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/04/mysql//">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/04/mysql//" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-04T11:11:16+08:00">
                2019-10-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/04/mysql//">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/04/mysql//" itemprop="url">.</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-04T11:11:16+08:00">
                2019-10-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id=""><a href="#" class="headerlink" title=""></a></h1><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>S:<br>X:<br>IS:<br>IX:<br>: </p>
<h2 id="innodb"><a href="#innodb" class="headerlink" title="innodb"></a>innodb</h2><p>innodb<br>,,,,,<br>GAP LOCK: ,</p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>innodb wait for graph</p>
<h2 id="id"><a href="#id" class="headerlink" title="id"></a>id</h2><p> AutoIncrement-lock<br>auto_inc_lock_mode :</p>
<ul>
<li>0: </li>
<li>1: ,</li>
<li>2: <br>:<br><br><br>:</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/04/mysql//">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/04/mysql//" itemprop="url">.</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-04T11:11:16+08:00">
                2019-10-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id=""><a href="#" class="headerlink" title=""></a></h1><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>,<br>:slow_query_type</p>
<ul>
<li>0: slow_log</li>
<li>1:slow_log</li>
<li>2:slow_log</li>
<li>3:slow_log</li>
</ul>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>mysql<br>:</p>
<ul>
<li></li>
<li></li>
<li></li>
</ul>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>,</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>\\</p>
<p>age of checkpoint<br> <br></p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>frm</p>
<h2 id="-redolog-undolog"><a href="#-redolog-undolog" class="headerlink" title=",redolog, undolog"></a>,redolog, undolog</h2><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>ibdata</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/04/mysql//">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/04/mysql//" itemprop="url">.</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-04T11:11:16+08:00">
                2019-10-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id=""><a href="#" class="headerlink" title=""></a></h1><h2 id="B-"><a href="#B-" class="headerlink" title="B+"></a>B+</h2><p></p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>\\</p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p></p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>:,offset,,.<br>:.</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>4+offset 4</p>
<h3 id="Cardinality--"><a href="#Cardinality--" class="headerlink" title="Cardinality/ "></a>Cardinality/ </h3><p>:<br>:*/<br><br>/XX</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h4 id="ICP-index-push-down"><a href="#ICP-index-push-down" class="headerlink" title="ICP/index push down"></a>ICP/index push down</h4><p></p>
<h4 id="MRR-Multi-Range"><a href="#MRR-Multi-Range" class="headerlink" title="MRR/ Multi Range"></a>MRR/ Multi Range</h4><p></p>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><p>, server..<br>:<br><br>,</p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/04/mysql//">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/04/mysql//" itemprop="url">.</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-04T11:11:16+08:00">
                2019-10-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id=""><a href="#" class="headerlink" title=""></a></h1><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>ACID<br><br><br><br></p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id="redo-log"><a href="#redo-log" class="headerlink" title="redo log"></a>redo log</h3><p><br>redo logcommit?<br>double write<br>redo log??<br>?</p>
<h3 id="undo-log"><a href="#undo-log" class="headerlink" title="undo log"></a>undo log</h3><p> ,</p>
<h3 id="binlog"><a href="#binlog" class="headerlink" title="binlog"></a>binlog</h3><p>STATEMENTROW</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>READ UNCOMMIT<br>READ COMMMIT<br>READ REAPEAT<br>Serial</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>LOG Group Commit</p>
<h3 id="2PC"><a href="#2PC" class="headerlink" title="2PC"></a>2PC</h3><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>redolog :</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><p></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/04/mysql/mysql innodb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/04/mysql/mysql innodb/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-04T11:11:16+08:00">
                2019-10-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/04/mysql/innodb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/04/mysql/innodb/" itemprop="url">.innodb</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-04T11:11:16+08:00">
                2019-10-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#innodb</p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>,,:<br>.<br>.<br>,:</p>
<h2 id="checkpoint"><a href="#checkpoint" class="headerlink" title="checkpoint"></a>checkpoint</h2><p>,,ACIDD</p>
<p>checkpoint </p>
<ul>
<li></li>
<li>,</li>
<li>,<br>checkpoint<br>FLUSH_LRU_LIST Checkpint InnodbLRU 100.Page Cleaner</li>
</ul>
<p>Async/Sync FLush Checkpoint,</p>
<p>redo log buffer <br>redo log </p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id="-Insert-buffer"><a href="#-Insert-buffer" class="headerlink" title="/Insert buffer"></a>/Insert buffer</h3><p>Insert buffer. .<br>Insert buffer,.</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>mysql,,,.</p>
<h3 id="Hash-AHI"><a href="#Hash-AHI" class="headerlink" title="Hash/AHI"></a>Hash/AHI</h3><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>\</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">John Doe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">82</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
