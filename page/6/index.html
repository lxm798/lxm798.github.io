<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="lxm798">
<meta property="og:url" content="http://yoursite.com/page/6/index.html">
<meta property="og:site_name" content="lxm798">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="lxm798">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/6/">





  <title>lxm798</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">lxm798</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/java/tomcat/config/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/java/tomcat/config/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#<br>##</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (debug &gt; <span class="number">0</span>)</span><br><span class="line">        log(sm.getString(<span class="string">"contextConfig.start"</span>));</span><br><span class="line">    context.setConfigured(<span class="keyword">false</span>);</span><br><span class="line">    ok = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set properties based on DefaultContext</span></span><br><span class="line">    Container container = context.getParent();</span><br><span class="line">    <span class="keyword">if</span>( !context.getOverride() ) &#123;</span><br><span class="line">        <span class="keyword">if</span>( container <span class="keyword">instanceof</span> Host ) &#123;</span><br><span class="line">            ((Host)container).importDefaultContext(context);</span><br><span class="line">            container = container.getParent();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>( container <span class="keyword">instanceof</span> Engine ) &#123;</span><br><span class="line">            ((Engine)container).importDefaultContext(context);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Process the default and application web.xml files</span></span><br><span class="line">    defaultConfig();</span><br><span class="line">    applicationConfig();</span><br><span class="line">    <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">        validateSecurityRoles();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Scan tag library descriptor files for additional listener classes</span></span><br><span class="line">    <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            tldScan();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log(e.getMessage(), e);</span><br><span class="line">            ok = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Configure a certificates exposer valve, if required</span></span><br><span class="line">    <span class="keyword">if</span> (ok)</span><br><span class="line">        certificatesConfig();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Configure an authenticator if we need one</span></span><br><span class="line">    <span class="keyword">if</span> (ok)</span><br><span class="line">        authenticatorConfig();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Dump the contents of this pipeline if requested</span></span><br><span class="line">    <span class="keyword">if</span> ((debug &gt;= <span class="number">1</span>) &amp;&amp; (context <span class="keyword">instanceof</span> ContainerBase)) &#123;</span><br><span class="line">        log(<span class="string">"Pipline Configuration:"</span>);</span><br><span class="line">        Pipeline pipeline = ((ContainerBase) context).getPipeline();</span><br><span class="line">        Valve valves[] = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (pipeline != <span class="keyword">null</span>)</span><br><span class="line">            valves = pipeline.getValves();</span><br><span class="line">        <span class="keyword">if</span> (valves != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; valves.length; i++) &#123;</span><br><span class="line">                log(<span class="string">"  "</span> + valves[i].getInfo());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        log(<span class="string">"======================"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make our application available if no problems were encountered</span></span><br><span class="line">    <span class="keyword">if</span> (ok)</span><br><span class="line">        context.setConfigured(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        log(sm.getString(<span class="string">"contextConfig.unavailable"</span>));</span><br><span class="line">        context.setConfigured(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/java/tomcat/deploy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/java/tomcat/deploy/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#</p>
<h2 id="Depoyer"><a href="#Depoyer" class="headerlink" title="Depoyer"></a>Depoyer</h2><h3 id="HostConfig"><a href="#HostConfig" class="headerlink" title="HostConfig"></a>HostConfig</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">deployApps</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(host <span class="keyword">instanceof</span> Deployer))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (debug &gt;= <span class="number">1</span>)</span><br><span class="line">        log(sm.getString(<span class="string">"hostConfig.deploying"</span>));</span><br><span class="line"></span><br><span class="line">    File appBase = appBase();</span><br><span class="line">    <span class="keyword">if</span> (!appBase.exists() || !appBase.isDirectory())</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    String files[] = appBase.list();</span><br><span class="line"></span><br><span class="line">    deployDescriptors(appBase, files);</span><br><span class="line">    deployWARs(appBase, files);</span><br><span class="line">    deployDirectories(appBase, files);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">deployDescriptors</span><span class="params">(File appBase, String[] files)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!deployXML)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; files.length; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (files[i].equalsIgnoreCase(<span class="string">"META-INF"</span>))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (files[i].equalsIgnoreCase(<span class="string">"WEB-INF"</span>))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (deployed.contains(files[i]))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        File dir = <span class="keyword">new</span> File(appBase, files[i]);</span><br><span class="line">        <span class="keyword">if</span> (files[i].toLowerCase().endsWith(<span class="string">".xml"</span>)) &#123;</span><br><span class="line">            deployed.add(files[i]);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Calculate the context path and make sure it is unique</span></span><br><span class="line">            String file = files[i].substring(<span class="number">0</span>, files[i].length() - <span class="number">4</span>);</span><br><span class="line">            String contextPath = <span class="string">"/"</span> + file;</span><br><span class="line">            <span class="keyword">if</span> (file.equals(<span class="string">"ROOT"</span>)) &#123;</span><br><span class="line">                contextPath = <span class="string">""</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (host.findChild(contextPath) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Assume this is a configuration descriptor and deploy it</span></span><br><span class="line">            log(sm.getString(<span class="string">"hostConfig.deployDescriptor"</span>, files[i]));</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                URL config =</span><br><span class="line">                    <span class="keyword">new</span> URL(<span class="string">"file"</span>, <span class="keyword">null</span>, dir.getCanonicalPath());</span><br><span class="line">                ((Deployer) host).install(config, <span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                log(sm.getString(<span class="string">"hostConfig.deployDescriptor.error"</span>,</span><br><span class="line">                                    files[i]), t);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/java/tomcat/StandardContext/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/java/tomcat/StandardContext/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#<br>##</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">    <span class="comment">// 当前已经启动的情况下,又重新启动</span></span><br><span class="line">    <span class="keyword">if</span> (started)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException</span><br><span class="line">            (sm.getString(<span class="string">"containerBase.alreadyStarted"</span>, logName()));</span><br><span class="line">    <span class="comment">// 打印debug 日志</span></span><br><span class="line">    <span class="keyword">if</span> (debug &gt;= <span class="number">1</span>)</span><br><span class="line">        log(<span class="string">"Starting"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通知监听器</span></span><br><span class="line">    lifecycle.fireLifecycleEvent(BEFORE_START_EVENT, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (debug &gt;= <span class="number">1</span>)</span><br><span class="line">        log(<span class="string">"Processing start(), current available="</span> + getAvailable());</span><br><span class="line">    <span class="comment">// 设置available 和configured 为false</span></span><br><span class="line">    setAvailable(<span class="keyword">false</span>);</span><br><span class="line">    setConfigured(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">boolean</span> ok = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add missing components as necessary</span></span><br><span class="line">    <span class="keyword">if</span> (getResources() == <span class="keyword">null</span>) &#123;   <span class="comment">// (1) Required by Loader</span></span><br><span class="line">        <span class="keyword">if</span> (debug &gt;= <span class="number">1</span>)</span><br><span class="line">            log(<span class="string">"Configuring default Resources"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ((docBase != <span class="keyword">null</span>) &amp;&amp; (docBase.endsWith(<span class="string">".war"</span>)))</span><br><span class="line">                setResources(<span class="keyword">new</span> WARDirContext());</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                setResources(<span class="keyword">new</span> FileDirContext());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            log(<span class="string">"Error initializing resources: "</span> + e.getMessage());</span><br><span class="line">            ok = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ok &amp;&amp; (resources <span class="keyword">instanceof</span> ProxyDirContext)) &#123;</span><br><span class="line">        DirContext dirContext =</span><br><span class="line">            ((ProxyDirContext) resources).getDirContext();</span><br><span class="line">        <span class="keyword">if</span> ((dirContext != <span class="keyword">null</span>)</span><br><span class="line">            &amp;&amp; (dirContext <span class="keyword">instanceof</span> BaseDirContext)) &#123;</span><br><span class="line">            ((BaseDirContext) dirContext).setDocBase(getBasePath());</span><br><span class="line">            ((BaseDirContext) dirContext).allocate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (getLoader() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (getPrivileged()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (debug &gt;= <span class="number">1</span>)</span><br><span class="line">                log(<span class="string">"Configuring privileged default Loader"</span>);</span><br><span class="line">            setLoader(<span class="keyword">new</span> WebappLoader(<span class="keyword">this</span>.getClass().getClassLoader()));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (debug &gt;= <span class="number">1</span>)</span><br><span class="line">                log(<span class="string">"Configuring non-privileged default Loader"</span>);</span><br><span class="line">            <span class="comment">// 设置默认loader,loader 用于加载Servlet</span></span><br><span class="line">            setLoader(<span class="keyword">new</span> WebappLoader(getParentClassLoader()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (getManager() == <span class="keyword">null</span>) &#123;     <span class="comment">// (3) After prerequisites</span></span><br><span class="line">        <span class="keyword">if</span> (debug &gt;= <span class="number">1</span>)</span><br><span class="line">            log(<span class="string">"Configuring default Manager"</span>);</span><br><span class="line">        <span class="comment">// 设置默认StandarManager,管理session</span></span><br><span class="line">        setManager(<span class="keyword">new</span> StandardManager());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// org.apache.catalina.util.CharsetMapper  ??</span></span><br><span class="line">    getCharsetMapper();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造workDir 目录为 worl/engineName/hostName/temp    temp是当前Context的name</span></span><br><span class="line">    <span class="comment">// 创建catalina.base目录,设置javax.servlet.context.tempdir环境变量</span></span><br><span class="line">    <span class="comment">// Context提供的临时目录的路径，用于servlet的临时读/写。利用javax.servlet.context.tempdir属性，servlet可以访问该目录。如果没有指定，使用$CATALINA_HOME/work下一个合适的目录</span></span><br><span class="line">    postWorkDirectory();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果希望Catalina为该web应用使能一个JNDIInitialContext对象，设为true</span></span><br><span class="line">    String useNamingProperty = System.getProperty(<span class="string">"catalina.useNaming"</span>);</span><br><span class="line">    <span class="keyword">if</span> ((useNamingProperty != <span class="keyword">null</span>)</span><br><span class="line">        &amp;&amp; (useNamingProperty.equals(<span class="string">"false"</span>))) &#123;</span><br><span class="line">        useNaming = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ok &amp;&amp; isUseNaming()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (namingContextListener == <span class="keyword">null</span>) &#123;</span><br><span class="line">            namingContextListener = <span class="keyword">new</span> NamingContextListener();</span><br><span class="line">            namingContextListener.setDebug(getDebug());</span><br><span class="line">            namingContextListener.setName(getNamingContextName());</span><br><span class="line">            addLifecycleListener(namingContextListener);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Binding thread</span></span><br><span class="line">    ClassLoader oldCCL = bindThread();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Standard container startup</span></span><br><span class="line">    <span class="keyword">if</span> (debug &gt;= <span class="number">1</span>)</span><br><span class="line">        log(<span class="string">"Processing standard container startup"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ok) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// org.apache.catalina.core.StandardContextMapper</span></span><br><span class="line">            addDefaultMapper(<span class="keyword">this</span>.mapperClass);</span><br><span class="line">            started = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// webloader和logger初始化</span></span><br><span class="line">            <span class="keyword">if</span> ((loader != <span class="keyword">null</span>) &amp;&amp; (loader <span class="keyword">instanceof</span> Lifecycle))</span><br><span class="line">                ((Lifecycle) loader).start();</span><br><span class="line">            <span class="keyword">if</span> ((logger != <span class="keyword">null</span>) &amp;&amp; (logger <span class="keyword">instanceof</span> Lifecycle))</span><br><span class="line">                ((Lifecycle) logger).start();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ????</span></span><br><span class="line">            unbindThread(oldCCL);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ????</span></span><br><span class="line">            oldCCL = bindThread();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((cluster != <span class="keyword">null</span>) &amp;&amp; (cluster <span class="keyword">instanceof</span> Lifecycle))</span><br><span class="line">                ((Lifecycle) cluster).start();</span><br><span class="line">            <span class="keyword">if</span> ((realm != <span class="keyword">null</span>) &amp;&amp; (realm <span class="keyword">instanceof</span> Lifecycle))</span><br><span class="line">                ((Lifecycle) realm).start();</span><br><span class="line">            <span class="keyword">if</span> ((resources != <span class="keyword">null</span>) &amp;&amp; (resources <span class="keyword">instanceof</span> Lifecycle))</span><br><span class="line">                ((Lifecycle) resources).start();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 初始化所有Mapper</span></span><br><span class="line">            Mapper mappers[] = findMappers();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mappers.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mappers[i] <span class="keyword">instanceof</span> Lifecycle)</span><br><span class="line">                    ((Lifecycle) mappers[i]).start();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 初始化所有的子Container</span></span><br><span class="line">            Container children[] = findChildren();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (children[i] <span class="keyword">instanceof</span> Lifecycle)</span><br><span class="line">                    ((Lifecycle) children[i]).start();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 初始化Valve pipeline 和 basic Valve</span></span><br><span class="line">            <span class="keyword">if</span> (pipeline <span class="keyword">instanceof</span> Lifecycle)</span><br><span class="line">                ((Lifecycle) pipeline).start();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// START_EVENT</span></span><br><span class="line">            lifecycle.fireLifecycleEvent(START_EVENT, <span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">// session manager 初始化</span></span><br><span class="line">            <span class="keyword">if</span> ((manager != <span class="keyword">null</span>) &amp;&amp; (manager <span class="keyword">instanceof</span> Lifecycle))</span><br><span class="line">                ((Lifecycle) manager).start();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// Unbinding thread</span></span><br><span class="line">            unbindThread(oldCCL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果没有listener设置为configured, 不正常</span></span><br><span class="line">    <span class="keyword">if</span> (!getConfigured())</span><br><span class="line">        ok = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We put the resources into the servlet context</span></span><br><span class="line">    <span class="keyword">if</span> (ok)</span><br><span class="line">        getServletContext().setAttribute</span><br><span class="line">            (Globals.RESOURCES_ATTR, getResources());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Binding thread</span></span><br><span class="line">    oldCCL = bindThread();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create context attributes that will be required</span></span><br><span class="line">    <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">        <span class="keyword">if</span> (debug &gt;= <span class="number">1</span>)</span><br><span class="line">            log(<span class="string">"Posting standard context attributes"</span>);</span><br><span class="line">        <span class="comment">// 设置org.apache.catalina.WELCOME_FILES 属性</span></span><br><span class="line">        postWelcomeFiles();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ?????</span></span><br><span class="line">    <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!listenerStart())</span><br><span class="line">            ok = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">        <span class="comment">// 初始化所有的filter</span></span><br><span class="line">        <span class="keyword">if</span> (!filterStart())</span><br><span class="line">            ok = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 "load on startup"的类</span></span><br><span class="line">    <span class="keyword">if</span> (ok)</span><br><span class="line">        loadOnStartup(findChildren());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ?????</span></span><br><span class="line">    unbindThread(oldCCL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set available status depending upon startup success</span></span><br><span class="line">    <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">        <span class="keyword">if</span> (debug &gt;= <span class="number">1</span>)</span><br><span class="line">            log(<span class="string">"Starting completed"</span>);</span><br><span class="line">        <span class="comment">// Avaliable 是内部初始化完成,Configured是外部监听到的正常</span></span><br><span class="line">        setAvailable(<span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log(sm.getString(<span class="string">"standardContext.startFailed"</span>));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stop();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            log(sm.getString(<span class="string">"standardContext.startCleanup"</span>), t);</span><br><span class="line">        &#125;</span><br><span class="line">        setAvailable(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Notify our interested LifecycleListeners</span></span><br><span class="line">    lifecycle.fireLifecycleEvent(AFTER_START_EVENT, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ClassLoader <span class="title">bindThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ClassLoader oldContextClassLoader =</span><br><span class="line">        Thread.currentThread().getContextClassLoader();</span><br><span class="line">    <span class="comment">// ???</span></span><br><span class="line">    <span class="keyword">if</span> (getResources() == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> oldContextClassLoader;</span><br><span class="line">    <span class="comment">// 设置线程内部的classloader,部分代码会使用thread 内部的classloader</span></span><br><span class="line">    Thread.currentThread().setContextClassLoader</span><br><span class="line">        (getLoader().getClassLoader());</span><br><span class="line"></span><br><span class="line">    DirContextURLStreamHandler.bind(getResources());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isUseNaming()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ContextBindings.bindThread(<span class="keyword">this</span>, <span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">            <span class="comment">// Silent catch, as this is a normal case during the early</span></span><br><span class="line">            <span class="comment">// startup stages</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> oldContextClassLoader;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Container <span class="title">map</span><span class="params">(Request request, <span class="keyword">boolean</span> update)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> debug = context.getDebug();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Has this request already been mapped?</span></span><br><span class="line">    <span class="keyword">if</span> (update &amp;&amp; (request.getWrapper() != <span class="keyword">null</span>))</span><br><span class="line">        <span class="keyword">return</span> (request.getWrapper());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Identify the context-relative URI to be mapped</span></span><br><span class="line">    String contextPath =</span><br><span class="line">        ((HttpServletRequest) request.getRequest()).getContextPath();</span><br><span class="line">    String requestURI = ((HttpRequest) request).getDecodedRequestURI();</span><br><span class="line">    String relativeURI = requestURI.substring(contextPath.length());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (debug &gt;= <span class="number">1</span>)</span><br><span class="line">        context.log(<span class="string">"Mapping contextPath='"</span> + contextPath +</span><br><span class="line">                    <span class="string">"' with requestURI='"</span> + requestURI +</span><br><span class="line">                    <span class="string">"' and relativeURI='"</span> + relativeURI + <span class="string">"'"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Apply the standard request URI mapping rules from the specification</span></span><br><span class="line">    Wrapper wrapper = <span class="keyword">null</span>;</span><br><span class="line">    String servletPath = relativeURI;</span><br><span class="line">    String pathInfo = <span class="keyword">null</span>;</span><br><span class="line">    String name = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 找到和路径匹配的Wrapper</span></span><br><span class="line">    <span class="comment">// 如果满足条件返回Wrapper</span></span><br><span class="line">    <span class="comment">// Rule 1 -- Exact Match</span></span><br><span class="line">    <span class="keyword">if</span> (wrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (debug &gt;= <span class="number">2</span>)</span><br><span class="line">            context.log(<span class="string">"  Trying exact match"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!(relativeURI.equals(<span class="string">"/"</span>)))</span><br><span class="line">            name = context.findServletMapping(relativeURI);</span><br><span class="line">        <span class="keyword">if</span> (name != <span class="keyword">null</span>)</span><br><span class="line">            wrapper = (Wrapper) context.findChild(name);</span><br><span class="line">        <span class="keyword">if</span> (wrapper != <span class="keyword">null</span>) &#123;</span><br><span class="line">            servletPath = relativeURI;</span><br><span class="line">            pathInfo = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Rule 2 -- Prefix Match</span></span><br><span class="line">    <span class="keyword">if</span> (wrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (debug &gt;= <span class="number">2</span>)</span><br><span class="line">            context.log(<span class="string">"  Trying prefix match"</span>);</span><br><span class="line">        servletPath = relativeURI;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            name = context.findServletMapping(servletPath + <span class="string">"/*"</span>);</span><br><span class="line">            <span class="keyword">if</span> (name != <span class="keyword">null</span>)</span><br><span class="line">                wrapper = (Wrapper) context.findChild(name);</span><br><span class="line">            <span class="keyword">if</span> (wrapper != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pathInfo = relativeURI.substring(servletPath.length());</span><br><span class="line">                <span class="keyword">if</span> (pathInfo.length() == <span class="number">0</span>)</span><br><span class="line">                    pathInfo = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> slash = servletPath.lastIndexOf(<span class="string">'/'</span>);</span><br><span class="line">            <span class="keyword">if</span> (slash &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            servletPath = servletPath.substring(<span class="number">0</span>, slash);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// *.XX</span></span><br><span class="line">    <span class="keyword">if</span> (wrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (debug &gt;= <span class="number">2</span>)</span><br><span class="line">            context.log(<span class="string">"  Trying extension match"</span>);</span><br><span class="line">        <span class="keyword">int</span> slash = relativeURI.lastIndexOf(<span class="string">'/'</span>);</span><br><span class="line">        <span class="keyword">if</span> (slash &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            String last = relativeURI.substring(slash);</span><br><span class="line">            <span class="keyword">int</span> period = last.lastIndexOf(<span class="string">'.'</span>);</span><br><span class="line">            <span class="keyword">if</span> (period &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                String pattern = <span class="string">"*"</span> + last.substring(period);</span><br><span class="line">                name = context.findServletMapping(pattern);</span><br><span class="line">                <span class="keyword">if</span> (name != <span class="keyword">null</span>)</span><br><span class="line">                    wrapper = (Wrapper) context.findChild(name);</span><br><span class="line">                <span class="keyword">if</span> (wrapper != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    servletPath = relativeURI;</span><br><span class="line">                    pathInfo = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Rule 4 -- Default Match</span></span><br><span class="line">    <span class="keyword">if</span> (wrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (debug &gt;= <span class="number">2</span>)</span><br><span class="line">            context.log(<span class="string">"  Trying default match"</span>);</span><br><span class="line">        name = context.findServletMapping(<span class="string">"/"</span>);</span><br><span class="line">        <span class="keyword">if</span> (name != <span class="keyword">null</span>)</span><br><span class="line">            wrapper = (Wrapper) context.findChild(name);</span><br><span class="line">        <span class="keyword">if</span> (wrapper != <span class="keyword">null</span>) &#123;</span><br><span class="line">            servletPath = relativeURI;</span><br><span class="line">            pathInfo = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update the Request (if requested) and return this Wrapper</span></span><br><span class="line">    <span class="keyword">if</span> ((debug &gt;= <span class="number">1</span>) &amp;&amp; (wrapper != <span class="keyword">null</span>))</span><br><span class="line">        context.log(<span class="string">" Mapped to servlet '"</span> + wrapper.getName() +</span><br><span class="line">                    <span class="string">"' with servlet path '"</span> + servletPath +</span><br><span class="line">                    <span class="string">"' and path info '"</span> + pathInfo +</span><br><span class="line">                    <span class="string">"' and update="</span> + update);</span><br><span class="line">    <span class="keyword">if</span> (update) &#123;</span><br><span class="line">        request.setWrapper(wrapper);</span><br><span class="line">        ((HttpRequest) request).setServletPath(servletPath);</span><br><span class="line">        ((HttpRequest) request).setPathInfo(pathInfo);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (wrapper);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>匹配策略</p>
<ol>
<li>全匹配</li>
<li>前缀匹配</li>
<li>后缀匹配 *.jsp之类</li>
<li>默认 /</li>
</ol>
<h2 id="reload"><a href="#reload" class="headerlink" title="reload"></a>reload</h2><p>reload 交给WebLoader,WebLoader在初始化时setContainer中获取是否需要reload,如果需要开启reload线程定时check 文件时间戳</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/linux/cgroup/cgroup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/linux/cgroup/cgroup/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#</p>
<h2 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cgroup_fork</span><span class="params">(struct task_struct *child)</span></span></span><br><span class="line"><span class="function"></span>&#123;                     </span><br><span class="line">    <span class="comment">// 和父进程相同的cgroup,初始化cg_list          </span></span><br><span class="line">    child-&gt;cgroups = current-&gt;cgroups;</span><br><span class="line">    get_css_set(child-&gt;cgroups);</span><br><span class="line">    INIT_LIST_HEAD(&amp;child-&gt;cg_list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参数设置"><a href="#参数设置" class="headerlink" title="参数设置"></a>参数设置</h2><h3 id="cfs-period-us"><a href="#cfs-period-us" class="headerlink" title="cfs_period_us"></a>cfs_period_us</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">cpu_cfs_quota_write_s64</span><span class="params">(struct cgroup *cgrp, struct cftype *cftype,</span></span></span><br><span class="line"><span class="function"><span class="params">				s64 cfs_quota_us)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> tg_set_cfs_quota(cgroup_tg(cgrp), cfs_quota_us);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> u64 <span class="title">cpu_cfs_period_read_u64</span><span class="params">(struct cgroup *cgrp, struct cftype *cft)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> tg_get_cfs_period(cgroup_tg(cgrp));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tg_set_cfs_period</span><span class="params">(struct task_group *tg, <span class="keyword">long</span> cfs_period_us)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u64 quota, period;</span><br><span class="line"></span><br><span class="line">	period = (u64)cfs_period_us * NSEC_PER_USEC;</span><br><span class="line">	quota = tg-&gt;cfs_bandwidth.quota;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> tg_set_cfs_bandwidth(tg, period, quota);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">tg_get_cfs_period</span><span class="params">(struct task_group *tg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u64 cfs_period_us;</span><br><span class="line"></span><br><span class="line">	cfs_period_us = ktime_to_ns(tg-&gt;cfs_bandwidth.period);</span><br><span class="line">	do_div(cfs_period_us, NSEC_PER_USEC);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> cfs_period_us;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tg_set_cfs_bandwidth</span><span class="params">(struct task_group *tg, u64 period, u64 quota)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i, ret = <span class="number">0</span>, runtime_enabled, runtime_was_enabled;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cfs_bandwidth</span> *<span class="title">cfs_b</span> = &amp;<span class="title">tg</span>-&gt;<span class="title">cfs_bandwidth</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (tg == &amp;root_task_group)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Ensure we have at some amount of bandwidth every period.  This is</span></span><br><span class="line"><span class="comment">	 * to prevent reaching a state of large arrears when throttled via</span></span><br><span class="line"><span class="comment">	 * entity_tick() resulting in prolonged exit starvation.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (quota &lt; min_cfs_quota_period || period &lt; min_cfs_quota_period)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Likewise, bound things on the otherside by preventing insane quota</span></span><br><span class="line"><span class="comment">	 * periods.  This also allows us to normalize in computing quota</span></span><br><span class="line"><span class="comment">	 * feasibility.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (period &gt; max_cfs_quota_period)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	mutex_lock(&amp;cfs_constraints_mutex);</span><br><span class="line">	ret = __cfs_schedulable(tg, period, quota);</span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		<span class="keyword">goto</span> out_unlock;</span><br><span class="line"></span><br><span class="line">	runtime_enabled = quota != RUNTIME_INF;</span><br><span class="line">	runtime_was_enabled = cfs_b-&gt;quota != RUNTIME_INF;</span><br><span class="line">	account_cfs_bandwidth_used(runtime_enabled, runtime_was_enabled);</span><br><span class="line">	raw_spin_lock_irq(&amp;cfs_b-&gt;lock);</span><br><span class="line">	cfs_b-&gt;period = ns_to_ktime(period);</span><br><span class="line">	cfs_b-&gt;quota = quota;</span><br><span class="line"></span><br><span class="line">	__refill_cfs_bandwidth_runtime(cfs_b);</span><br><span class="line">	<span class="comment">/* restart the period timer (if active) to handle new period expiry */</span></span><br><span class="line">	<span class="keyword">if</span> (runtime_enabled &amp;&amp; cfs_b-&gt;timer_active) &#123;</span><br><span class="line">		<span class="comment">/* force a reprogram */</span></span><br><span class="line">		cfs_b-&gt;timer_active = <span class="number">0</span>;</span><br><span class="line">		__start_cfs_bandwidth(cfs_b);</span><br><span class="line">	&#125;</span><br><span class="line">	raw_spin_unlock_irq(&amp;cfs_b-&gt;lock);</span><br><span class="line"></span><br><span class="line">	for_each_possible_cpu(i) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">cfs_rq</span> *<span class="title">cfs_rq</span> = <span class="title">tg</span>-&gt;<span class="title">cfs_rq</span>[<span class="title">i</span>];</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rq</span> *<span class="title">rq</span> = <span class="title">cfs_rq</span>-&gt;<span class="title">rq</span>;</span></span><br><span class="line"></span><br><span class="line">		raw_spin_lock_irq(&amp;rq-&gt;lock);</span><br><span class="line">		cfs_rq-&gt;runtime_enabled = runtime_enabled;</span><br><span class="line">		cfs_rq-&gt;runtime_remaining = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (cfs_rq-&gt;throttled)</span><br><span class="line">			unthrottle_cfs_rq(cfs_rq);</span><br><span class="line">		raw_spin_unlock_irq(&amp;rq-&gt;lock);</span><br><span class="line">	&#125;</span><br><span class="line">out_unlock:</span><br><span class="line">	mutex_unlock(&amp;cfs_constraints_mutex);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="shares"><a href="#shares" class="headerlink" title="shares"></a>shares</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">cpu_shares_write_u64</span><span class="params">(struct cgroup *cgrp, struct cftype *cftype,</span></span></span><br><span class="line"><span class="function"><span class="params">				u64 shareval)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> sched_group_set_shares(cgroup_tg(cgrp), scale_load(shareval));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> u64 <span class="title">cpu_shares_read_u64</span><span class="params">(struct cgroup *cgrp, struct cftype *cft)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_group</span> *<span class="title">tg</span> = <span class="title">cgroup_tg</span>(<span class="title">cgrp</span>);</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> (u64) scale_load_down(tg-&gt;shares);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="sched-group-set-shares"><a href="#sched-group-set-shares" class="headerlink" title="sched_group_set_shares"></a>sched_group_set_shares</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sched_group_set_shares</span><span class="params">(struct task_group *tg, <span class="keyword">unsigned</span> <span class="keyword">long</span> shares)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We can't change the weight of the root cgroup.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (!tg-&gt;se[<span class="number">0</span>])</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	shares = clamp(shares, scale_load(MIN_SHARES), scale_load(MAX_SHARES));</span><br><span class="line"></span><br><span class="line">	mutex_lock(&amp;shares_mutex);</span><br><span class="line">	<span class="keyword">if</span> (tg-&gt;shares == shares)</span><br><span class="line">		<span class="keyword">goto</span> done;</span><br><span class="line"></span><br><span class="line">	tg-&gt;shares = shares;</span><br><span class="line">	for_each_possible_cpu(i) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rq</span> *<span class="title">rq</span> = <span class="title">cpu_rq</span>(<span class="title">i</span>);</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">sched_entity</span> *<span class="title">se</span>;</span></span><br><span class="line"></span><br><span class="line">		se = tg-&gt;se[i];</span><br><span class="line">		<span class="comment">/* Propagate contribution to hierarchy */</span></span><br><span class="line">		raw_spin_lock_irqsave(&amp;rq-&gt;lock, flags);</span><br><span class="line">		for_each_sched_entity(se)</span><br><span class="line">			update_cfs_shares(group_cfs_rq(se));</span><br><span class="line">		raw_spin_unlock_irqrestore(&amp;rq-&gt;lock, flags);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">done:</span><br><span class="line">	mutex_unlock(&amp;shares_mutex);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> for_each_sched_entity(se) \</span></span><br><span class="line">		<span class="keyword">for</span> (; se; se = se-&gt;parent)</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">update_cfs_shares</span><span class="params">(struct cfs_rq *cfs_rq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_group</span> *<span class="title">tg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sched_entity</span> *<span class="title">se</span>;</span></span><br><span class="line">	<span class="keyword">long</span> shares;</span><br><span class="line"></span><br><span class="line">	tg = cfs_rq-&gt;tg;</span><br><span class="line">	se = tg-&gt;se[cpu_of(rq_of(cfs_rq))];</span><br><span class="line">	<span class="keyword">if</span> (!se || throttled_hierarchy(cfs_rq))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_SMP</span></span><br><span class="line">	<span class="keyword">if</span> (likely(se-&gt;load.weight == tg-&gt;shares))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	shares = calc_cfs_shares(cfs_rq, tg);</span><br><span class="line"></span><br><span class="line">	reweight_entity(cfs_rq_of(se), se, shares);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">calc_cfs_shares</span><span class="params">(struct cfs_rq *cfs_rq, struct task_group *tg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">long</span> tg_weight, load, shares;</span><br><span class="line">    <span class="comment">// 当前task_group的shares</span></span><br><span class="line">	tg_weight = calc_tg_weight(tg, cfs_rq);</span><br><span class="line">	load = cfs_rq-&gt;load.weight;</span><br><span class="line"></span><br><span class="line">	shares = (tg-&gt;shares * load);</span><br><span class="line">	<span class="keyword">if</span> (tg_weight)</span><br><span class="line">		shares /= tg_weight;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (shares &lt; MIN_SHARES)</span><br><span class="line">		shares = MIN_SHARES;</span><br><span class="line">	<span class="keyword">if</span> (shares &gt; tg-&gt;shares)</span><br><span class="line">		shares = tg-&gt;shares;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> shares;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">long</span> <span class="title">calc_cfs_shares</span><span class="params">(struct cfs_rq *cfs_rq, struct task_group *tg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> tg-&gt;shares;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/linux/cgroup/cfs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/linux/cgroup/cfs/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://www.cnblogs.com/s-hk/p/3319455.html" target="_blank" rel="noopener">https://www.cnblogs.com/s-hk/p/3319455.html</a><br>##</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">sched_class</span> <span class="title">fair_sched_class</span> = &#123;</span></span><br><span class="line">    .next           = &amp;idle_sched_class,</span><br><span class="line">    .enqueue_task       = enqueue_task_fair,</span><br><span class="line">    .dequeue_task       = dequeue_task_fair,</span><br><span class="line">    .yield_task     = yield_task_fair,</span><br><span class="line">    .yield_to_task      = yield_to_task_fair,</span><br><span class="line">                           </span><br><span class="line">    .check_preempt_curr = check_preempt_wakeup,</span><br><span class="line">                           </span><br><span class="line">    .pick_next_task     = pick_next_task_fair,                                                                                                                                                                     </span><br><span class="line">    .put_prev_task      = put_prev_task_fair,</span><br><span class="line">                           </span><br><span class="line">#ifdef CONFIG_SMP          </span><br><span class="line">    .select_task_rq     = select_task_rq_fair,</span><br><span class="line">                           </span><br><span class="line">    .rq_online      = rq_online_fair,</span><br><span class="line">    .rq_offline     = rq_offline_fair,</span><br><span class="line">                           </span><br><span class="line">    .task_waking        = task_waking_fair,</span><br><span class="line">#endif                     </span><br><span class="line">                           </span><br><span class="line">    .set_curr_task          = set_curr_task_fair,</span><br><span class="line">    .task_tick      = task_tick_fair,</span><br><span class="line">    .task_fork      = task_fork_fair,</span><br><span class="line">                           </span><br><span class="line">    .prio_changed       = prio_changed_fair,</span><br><span class="line">    .switched_from      = switched_from_fair,</span><br><span class="line">    .switched_to        = switched_to_fair,</span><br><span class="line">                           </span><br><span class="line">    .get_rr_interval    = get_rr_interval_fair,</span><br><span class="line">                           </span><br><span class="line">#ifdef CONFIG_FAIR_GROUP_SCHED</span><br><span class="line">    .task_move_group    = task_move_group_fair,</span><br><span class="line">#endif                     </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">OTHER CFS CLASS API</span><br><span class="line"></span><br><span class="line">set_curr_task_fair(rq)：将cpu运行队列里的当前运行进程设置为cfs运行队列里当前运行的进程(set_curr_task_fair)，对于组调度则必须把它上级的se也设置为相应cfs_rq的当前运行进程。该接口主要用于修改某个进程的调度策略(__sched_setscheduler调度器类的运行队列信息也需要更新)或把一个进程从一个group迁移到另一个group的过程(__sched_move_task此时如果它是正在运行的，则需让它在新的group cfs_rq中也处于正在运行状态)，注意：这里并不需要resched_task当前进程</span><br><span class="line">switched_to_fair(rq, p, running)：把rq里的进程p的调度策略切换到CFS。如果p是正在运行的，那么直接resched_task它；否则判断p是否能够抢占当前运行的进程。显然该接口也用于调度策略改变时调用(check_class_changed)</span><br><span class="line">prio_changed_fair(rq, p, oldprio, running)：该函数在p的优先级被改变时调用(在调度框架的__sched_setscheduler-à check_class_changed被调用)。如果p是正在运行的进程，并且它的优先级降低了，那么直接resched_task它，否则调用check_preempt_curr检查当前运行的是否该被p抢占(check_class_changed)</span><br><span class="line">yield_task_fair(rq)：该接口用于系统调用sched_yield中，这本身的逻辑非常简单：把当前进程从buddies中删除，并且更新它的执行时间update_curr，最后把它设置为skip_buddy（上面的pick_next_task我们说过如果是skip的话，在选择的时候会被skip的），这里及sched_yield系统调用并没有把当前进程设置为TIF_NEED_RESCHED，这是因为在sched_yield里直接调用了schedule，而不再需要在系统调用返回时去检查</span><br><span class="line">yield_to_task_fair(rq, p, preempt)：该函数不仅让当前进程让出CPU，而且想让p进程优先运行set_next_buddy，该接口用于yield_to函数中</span><br><span class="line"></span><br><span class="line">CFS内部主要函数</span><br><span class="line"></span><br><span class="line">__pick_first_entity(cfs_rq)：获得cfs_rq红黑树队列里最左边的节点</span><br><span class="line">__pick_next_entity(se)：获得se所在红黑树的se的后一个节点</span><br><span class="line">entity_key(cfs_rq, se)：se在cfs_rq的红黑树中的key,se-&gt;vruntime - cfs_rq-&gt;min_vruntime,这里使用这个差值为key（标准化后的）,是因为vruntime本身为usigned <span class="keyword">long</span>而且是一个递增的值, vruntime溢出了,那么就会导致顺序混乱,所以key不能直接使用vruntime,而这个差值就是为了防止溢出</span><br><span class="line">update_min_vruntime(cfs_rq)：更新cfs_rq的min_vruntime,并且它保证每次将要更新的min_vruntime都大于等于当前的min_vruntime,即max(cfs_rq-&gt;min_vruntime,min(cfs_rq-&gt;curr-&gt;vruntime, cfs_rq-&gt;rb_leftmost-&gt;vruntime)),所以min_vruntime也是递增的</span><br><span class="line">calc_delta_mine(delta_exec,weight, lw)：该函数用于计算物理delta_exec时间的相对时间，这个时间用delta_exec为基数 乘以 第二个参数与最后一个参数比重，即delta_exec * weight / lw.于是就有以下几种情况： delta_exec为一个se实质运行的物理时间，第二个参数为NICE_0的权重，第三个参数为该se的本身权重：该函数计算出来的值就是该se它运行了delta_exec物理时间对应的虚拟时间,如calc_delta_fair； delta_exec为一个运行队列的运行周期(物理时间)，第二个参数为当前se的权重，第三个参数为运行队列本身的权重：该函数计算出来的值就是该se在当前运行队列中即将(理想)运行的物理时间,如sched_slice非组调度。</span><br><span class="line">calc_delta_fair(delta,se)：计算se执行的delta物理时间的相应的虚拟时间</span><br><span class="line">__sched_period(nr_running)：该函数用于计算当前运行队列所有se运行一遍所需要的时间周期,这是一个实质物理时间,当运行队列成员小于sched_nr_latency时，该时间为sysctl_sched_latency；否则等于sysctl_sched_min_granularity*运行队列的成员个数（这个函数也是计算所谓的延迟调度周期，即内核保证在这么长的时间内它的运行队列的成员都会被执行至少一次，sysctl_sched_latency、sysctl_sched_min_granularity可以在/proc/sys/kernel/上进行设置）</span><br><span class="line">sched_slice(cfs_rq,se)：对于非组调度它计算的就是当前se在运行队列里所能分配的物理执行时间，首先计算出该队列的调度周期（__sched_period），然后按照该se在队列中所占的比重计算出它自己的理想执行时间__sched_period*(se-&gt;load/se-&gt;cfs_rq-&gt;load)；对于组调度，它则算出该se对应的group root理想的物理执行时间。为什么要算到root？——假设我们有两个group并且它们的shares差一倍，但是它们下面的task load是一样的<span class="number">1024</span>，那么它们的执行时间显然跟它们所属的group有关。即它的se的上级group se是这样计算的：parent_slice=child_slice*(parent_load/parent_cfs_rq-&gt;load)。注：如果se不在运行列队（从另一个cpu迁移过来），那么计算队列的load时还应该加上该运行的se的load。</span><br><span class="line">__update_curr(cfs_rq,curr, delta_exec)：更新cfs_rq当前的运行se的累计物理执行时间sum_exec_runtime,vruntime(这里用到calc_delta_fair计算实质物理时间对应的虚拟时间)以及cfs_rq-&gt;min_vruntime(update_min_vruntime)</span><br><span class="line">sched_vslice(cfs_rq,se)：计算该se理想情况下运行的物理时间相对应的虚拟时间</span><br><span class="line">update_curr(cfs_rq)：该函数调用__update_curr更新vruntime，及更新一些统计信息</span><br><span class="line">wakeup_gran：用于计算被抢占进程的最小执行时间(物理时间sysctl_sched_wakeup_granularity <span class="number">1</span>ms)的虚拟时间(calc_delta_fair)</span><br><span class="line">wakeup_preempt_entity：该函数用于判断一个新的se是否应该抢占当前的curr，如果当前的虚拟执行时间小于等于(优先不抢占)新的vruntime，显然当前执行的时间更少，所以不应该被抢占(返回<span class="number">-1</span>)；否则，假设新的se可以抢占curr，那么它最少需要运行wakeup_gran虚拟时间(sysctl_sched_wakeup_granularity保证最少运行时间防止频繁切换)，如果这个时间比当前多运行的时间小的话，那么说明被抢占后新的se运行后的vruntime还会比当前的vruntime还小，这样新的se可以抢占当前curr(返回<span class="number">1</span>)；<span class="number">0</span>好像也表示不应该抢占</span><br><span class="line">place_entity(cfs_rq,se, initial)：确定se被wakeup(initial=<span class="number">0</span>)或者刚被fork的时新(initial=<span class="number">1</span>)的合适vruntime，对于wakeup则进行适当的补偿(补偿因子sysctl_sched_latency，如果睡眠时间太短se-&gt;vruntime依然很大（比vruntime大），那么进程虚拟时间不变，而得不到奖励)；对于刚被fork的进程，则把它的vruntime赋值为cfs_rq-&gt;min_vruntime，另外因为进程刚被创建，它的运行应当被放在运行周期之后，所以加上运行周期对应虚拟时间（sched_vslice）</span><br><span class="line">set_next_entity(cfs_rq,se)：将se置为当前cfs_rq上正在运行的进程，如果它是在运行队列里，则先出队，否则直接cfs_rq-&gt;curr = se</span><br><span class="line">set_last_buddy(se)：设置优先调度的last buddy</span><br><span class="line">set_next_buddy(se)：设置优先调度的next buddy，它的优先级比last buddy高</span><br><span class="line">set_skip_buddy(se)：设置不应该被调度的buddy，也就是它的优先级最最低</span><br><span class="line">update_cfs_shares(cfs_rq)：更新该cfs_rq自身所属的se weight.load值（se = tg-&gt;se[cpu_of(rq_of(cfs_rq))]），新的shares值计算公式为：(tg-&gt;shares*cfs_rq-&gt;load.weight)/(tg-&gt;load_weight-cfs_rq-&gt;load_contribution+cfs_rq-&gt;load.weight)，注意最后在更新时reweight_entity(cfs_rq_of(se), se, shares)，这时传给reweight_entity就是这个se所属的cfs_rq（上级的my_q），而不是它自己本身了，因为如果这个se已经在它的上级cfs_rq里，那么应该先减去它旧的shares值，然后再更新该se的shares值，然后再用新的se shares值加到这个上级cfs_rq里 </span><br><span class="line">account_entity_enqueue(cfs_rq,se)：入队列时相应更新，包括cfs_rq的load，nr_running；另外如果该se是root的话，则增加cfs_rq对应的rq的load，如果该se是task的话，则增加cfs_rq的task weight</span><br><span class="line">account_entity_dequeue(cfs_rq,se)：做account_entity_enqueue的相反操作</span><br><span class="line">reweight_entity(cfs_rq,se, weight)：重新计算se的load及相应的cfs_rq的load（如该se在cfs_rq里），即先把该se account_entity_dequeue，再更新se的load update_load_set，最后再重新计算cfs_rq的load account_entity_enqueue</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/linux/cgroup/core/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/linux/cgroup/core/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="调度core-c"><a href="#调度core-c" class="headerlink" title="调度core.c"></a>调度core.c</h1><h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>get_cpu/put_cpu 禁止/开启内核抢占</p>
<h2 id="进程创建"><a href="#进程创建" class="headerlink" title="进程创建"></a>进程创建</h2><ol>
<li>关闭内核抢占</li>
<li>初始化化sched_entity中计数,state和prio</li>
<li>重新计算静态优先级和动态优先级</li>
<li>根据task_struct设置调度器类型</li>
<li>初始化sched_entity,将sched_entity中的cfs指向对应的task_group的cfs_rq</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sched_fork</span><span class="params">(struct task_struct *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line">	<span class="keyword">int</span> cpu = get_cpu();</span><br><span class="line"></span><br><span class="line">	__sched_fork(p);</span><br><span class="line">	<span class="comment">// 设置为running状态</span></span><br><span class="line">	p-&gt;state = TASK_RUNNING;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 继承父进程prio</span></span><br><span class="line">	p-&gt;prio = current-&gt;normal_prio;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(p-&gt;sched_reset_on_fork)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (task_has_rt_policy(p)) &#123;</span><br><span class="line">			p-&gt;policy = SCHED_NORMAL;</span><br><span class="line">			p-&gt;static_prio = NICE_TO_PRIO(<span class="number">0</span>);</span><br><span class="line">			p-&gt;rt_priority = <span class="number">0</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (PRIO_TO_NICE(p-&gt;static_prio) &lt; <span class="number">0</span>)</span><br><span class="line">			p-&gt;static_prio = NICE_TO_PRIO(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		p-&gt;prio = p-&gt;normal_prio = __normal_prio(p);</span><br><span class="line">		set_load_weight(p);</span><br><span class="line"></span><br><span class="line">		p-&gt;sched_reset_on_fork = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 设置调度的类型是cfs还是实时</span></span><br><span class="line">	<span class="keyword">if</span> (!rt_prio(p-&gt;prio))</span><br><span class="line">		p-&gt;sched_class = &amp;fair_sched_class;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (p-&gt;sched_class-&gt;task_fork)</span><br><span class="line">		p-&gt;sched_class-&gt;task_fork(p);</span><br><span class="line"></span><br><span class="line">	raw_spin_lock_irqsave(&amp;p-&gt;pi_lock, flags);</span><br><span class="line">    <span class="comment">// 将进程添加到到指定的cpu队列</span></span><br><span class="line">	set_task_cpu(p, cpu);</span><br><span class="line">	raw_spin_unlock_irqrestore(&amp;p-&gt;pi_lock, flags); </span><br><span class="line">	put_cpu();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="sched-fork"><a href="#sched-fork" class="headerlink" title="__sched_fork"></a>__sched_fork</h3><p>初始化 sched_entity为空的数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __sched_fork(struct task_struct *p)</span><br><span class="line">&#123;</span><br><span class="line">	p-&gt;on_rq			= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	p-&gt;se.on_rq			= <span class="number">0</span>;</span><br><span class="line">	p-&gt;se.exec_start		= <span class="number">0</span>;</span><br><span class="line">	p-&gt;se.sum_exec_runtime		= <span class="number">0</span>;</span><br><span class="line">	p-&gt;se.prev_sum_exec_runtime	= <span class="number">0</span>;</span><br><span class="line">	p-&gt;se.nr_migrations		= <span class="number">0</span>;</span><br><span class="line">	p-&gt;se.vruntime			= <span class="number">0</span>;</span><br><span class="line">	INIT_LIST_HEAD(&amp;p-&gt;se.group_node);</span><br><span class="line"></span><br><span class="line">	INIT_LIST_HEAD(&amp;p-&gt;rt.run_list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="set-task-rq"><a href="#set-task-rq" class="headerlink" title="set_task_rq"></a>set_task_rq</h3><p>将进程的sched_entity的队列绑定到对应task_group的队列</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">set_task_rq</span><span class="params">(struct task_struct *p, <span class="keyword">unsigned</span> <span class="keyword">int</span> cpu)</span>                                                                                                                                            </span></span><br><span class="line"><span class="function"></span>&#123;                   </span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_FAIR_GROUP_SCHED) || defined(CONFIG_RT_GROUP_SCHED)</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_group</span> *<span class="title">tg</span> = <span class="title">task_group</span>(<span class="title">p</span>);</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>              </span></span><br><span class="line">                    </span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FAIR_GROUP_SCHED</span></span><br><span class="line">    p-&gt;se.cfs_rq = tg-&gt;cfs_rq[cpu];</span><br><span class="line">    p-&gt;se.parent = tg-&gt;se[cpu];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>              </span></span><br><span class="line">                    </span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_RT_GROUP_SCHED</span></span><br><span class="line">    p-&gt;rt.rt_rq  = tg-&gt;rt_rq[cpu];</span><br><span class="line">    p-&gt;rt.parent = tg-&gt;rt_se[cpu];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>              </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct task_group *<span class="title">task_group</span><span class="params">(struct task_struct *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;           </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_group</span> *<span class="title">tg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cgroup_subsys_state</span> *<span class="title">css</span>;</span></span><br><span class="line">            </span><br><span class="line">    css = task_subsys_state_check(p, cpu_cgroup_subsys_id,</span><br><span class="line">            lockdep_is_held(&amp;p-&gt;pi_lock) ||</span><br><span class="line">            lockdep_is_held(&amp;task_rq(p)-&gt;lock));</span><br><span class="line">    tg = container_of(css, struct task_group, css);</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">return</span> autogroup_task_group(p, tg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">task_group</span> *</span></span><br><span class="line"><span class="class"><span class="title">autogroup_task_group</span>(<span class="title">struct</span> <span class="title">task_struct</span> *<span class="title">p</span>, <span class="title">struct</span> <span class="title">task_group</span> *<span class="title">tg</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> enabled = ACCESS_ONCE(sysctl_sched_autogroup_enabled);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (enabled &amp;&amp; task_wants_autogroup(p, tg))</span><br><span class="line">        <span class="keyword">return</span> p-&gt;signal-&gt;autogroup-&gt;tg;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> tg; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">task_group</span> *</span></span><br><span class="line"><span class="class"><span class="title">autogroup_task_group</span>(<span class="title">struct</span> <span class="title">task_struct</span> *<span class="title">p</span>, <span class="title">struct</span> <span class="title">task_group</span> *<span class="title">tg</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">return</span> tg; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/语言/java/gc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/语言/java/gc/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Gc"><a href="#Gc" class="headerlink" title="Gc"></a>Gc</h1><h2 id="内存区域"><a href="#内存区域" class="headerlink" title="内存区域"></a>内存区域</h2><ul>
<li>程序计数器 :当前线程所执行的字节码的行号指示器</li>
<li>JAVA堆 : Eden, From Survivor, To Survivor, TLB</li>
<li>虚拟机栈:线程私有,生命周期和线程相同.</li>
<li>本地方法栈:</li>
<li>方法区</li>
<li>运行时常量池</li>
<li>直接内存/堆外内存:NIO Buffer</li>
</ul>
<h2 id="分代信息"><a href="#分代信息" class="headerlink" title="分代信息"></a>分代信息</h2><ul>
<li>Eden/young</li>
<li>old</li>
<li>survive</li>
<li>永久代</li>
<li>code</li>
</ul>
<h2 id="GC-算法"><a href="#GC-算法" class="headerlink" title="GC 算法"></a>GC 算法</h2><h3 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h3><h4 id="标记-清除"><a href="#标记-清除" class="headerlink" title="标记-清除"></a>标记-清除</h4><p>产生大量的不连续的内存碎片</p>
<h4 id="标记-整理"><a href="#标记-整理" class="headerlink" title="标记-整理"></a>标记-整理</h4><p>将清理的数据都向一端移动</p>
<h4 id="复制"><a href="#复制" class="headerlink" title="复制"></a>复制</h4><p>将内存划分为相等的两块, Eden-&gt;Survivor</p>
<h4 id="分代收集"><a href="#分代收集" class="headerlink" title="分代收集"></a>分代收集</h4><p>对前面的方案进行组合,新生代,有担保,复制,老年代,没有担保,标记-整理</p>
<p>GCROOT的枚举一定会发生STW, 使用OopMap记录GCROOT</p>
<h3 id="新生代"><a href="#新生代" class="headerlink" title="新生代"></a>新生代</h3><p>Serial : 单线程,复制,简单高效, 老年代标记整理<br>Parallel Scavenge: 复制算法,可控制的吞吐量<br>ParNew: Serial 的多线程版本, 唯一和CMS配合,新生代复制,老年代标记整理, -XX:ParallelGCThreads<br>G1:</p>
<h3 id="老年代"><a href="#老年代" class="headerlink" title="老年代"></a>老年代</h3><p>SerialOld: 标记-整理,搭配Parallel-Scavenge或者作为CMS的后备<br>Parallel old:Parallel Scavenge的老年代版本,标记整理,只能和Parallel Scavenge 搭配<br>Cms:</p>
<p>  最短停顿为目标,标记-清除,初始标记(STW,GCRoots能直接关联到的对象)-&gt;并发标记(GCROOT TRACING)-&gt;重新标记(STW,新增GCROOT)-&gt;并发清除</p>
<p>  碎片的问题可以有两种方案解决: full gc, 强制开启碎片整理</p>
<p>  浮动垃圾:在并发清理阶段产生的垃圾</p>
<p>  参数: -XXCMSInitiatingOccupancyFraction 老年代空间使用达到一定比例触发垃圾回收<br>G1:<br>  初始标记-&gt;并发标记-&gt;最终标记-&gt;筛选回收(优先回收价值对打的Region)</p>
<h2 id="内存分配策略"><a href="#内存分配策略" class="headerlink" title="内存分配策略"></a>内存分配策略</h2><ul>
<li>优先分配Eden</li>
<li>大对象直接进入老年代 -XX:PretenureSizeThreshold</li>
<li>长期存活的对象进入老年代 -XX:MaxTenuringThreshold</li>
<li>空间分配担保: 老年代最大可用的连续空间是否大于新生代所有对象总空间<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="如何处理循环引用"><a href="#如何处理循环引用" class="headerlink" title="如何处理循环引用"></a>如何处理循环引用</h3>通过扫描是否有当前被引用的GCROOT到达,如果没有则可以清除</li>
</ul>
<h3 id="shallow-heap-和-retained-heap"><a href="#shallow-heap-和-retained-heap" class="headerlink" title="shallow heap 和 retained heap"></a>shallow heap 和 retained heap</h3><p>shallow heap是自身的内存开销<br>retained heap 是对象被清除后能回收多少内存</p>
<h3 id="major-gc-amp-fullgc"><a href="#major-gc-amp-fullgc" class="headerlink" title="major gc &amp; fullgc"></a>major gc &amp; fullgc</h3><p>作者：RednaxelaFX<br>链接：<a href="https://www.zhihu.com/question/41922036/answer/93079526" target="_blank" rel="noopener">https://www.zhihu.com/question/41922036/answer/93079526</a><br>来源：知乎<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>
<p>针对HotSpot VM的实现，它里面的GC其实准确分类只有两大种：Partial GC：并不收集整个GC堆的模式Young GC：只收集young gen的GCOld GC：只收集old gen的GC。只有CMS的concurrent collection是这个模式Mixed GC：收集整个young gen以及部分old gen的GC。只有G1有这个模式Full GC：收集整个堆，包括young gen、old gen、perm gen（如果存在的话）等所有部分的模式。Major GC通常是跟full GC是等价的，收集整个GC堆。但因为HotSpot VM发展了这么多年，外界对各种名词的解读已经完全混乱了，当有人说“major GC”的时候一定要问清楚他想要指的是上面的full GC还是old GC。最简单的分代式GC策略，按HotSpot VM的serial GC的实现来看，触发条件是：young GC：当young gen中的eden区分配满的时候触发。注意young GC中有部分存活对象会晋升到old gen，所以young GC后old gen的占用量通常会有所升高。full GC：当准备要触发一次young GC时，如果发现统计数据说之前young GC的平均晋升大小比目前old gen剩余的空间大，则不会触发young GC而是转为触发full GC（因为HotSpot VM的GC里，除了CMS的concurrent collection之外，其它能收集old gen的GC都会同时收集整个GC堆，包括young gen，所以不需要事先触发一次单独的young GC）；或者，如果有perm gen的话，要在perm gen分配空间但已经没有足够空间时，也要触发一次full GC；或者System.gc()、heap dump带GC，默认也是触发full GC。HotSpot VM里其它非并发GC的触发条件复杂一些，不过大致的原理与上面说的其实一样。当然也总有例外。Parallel Scavenge（-XX:+UseParallelGC）框架下，默认是在要触发full GC前先执行一次young GC，并且两次GC之间能让应用程序稍微运行一小下，以期降低full GC的暂停时间（因为young GC会尽量清理了young gen的死对象，减少了full GC的工作量）。控制这个行为的VM参数是-XX:+ScavengeBeforeFullGC。这是HotSpot VM里的奇葩嗯。可跳传送门围观：JVM full GC的奇怪现象，求解惑？ - RednaxelaFX 的回答并发GC的触发条件就不太一样。以CMS GC为例，它主要是定时去检查old gen的使用量，当使用量超过了触发比例就会启动一次CMS GC，对old gen做并发收集。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/java/tomcat/Catalina & BootStrap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/java/tomcat/Catalina & BootStrap/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#</p>
<h2 id="Catalina"><a href="#Catalina" class="headerlink" title="Catalina"></a>Catalina</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">    <span class="comment">// catalina.home  -&gt; user.dir</span></span><br><span class="line">    setCatalinaHome();</span><br><span class="line">    <span class="comment">// catalina.base -&gt; catalina.home</span></span><br><span class="line">    setCatalinaBase();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 初始化参数解析</span></span><br><span class="line">        <span class="keyword">if</span> (arguments(args))</span><br><span class="line">            execute();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace(System.out);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// XML 解析对象</span></span><br><span class="line">    Digester digester = createStartDigester();</span><br><span class="line">    File file = configFile();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        InputSource is =</span><br><span class="line">            <span class="keyword">new</span> InputSource(<span class="string">"file://"</span> + file.getAbsolutePath());</span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">        is.setByteStream(fis);</span><br><span class="line">        digester.push(<span class="keyword">this</span>);</span><br><span class="line">        digester.parse(is);</span><br><span class="line">        fis.close();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        System.out.println(<span class="string">"Catalina.start: "</span> + e);</span><br><span class="line">        e.printStackTrace(System.out);</span><br><span class="line">        System.exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置环境变量</span></span><br><span class="line">    <span class="keyword">if</span> (!useNaming) &#123;</span><br><span class="line">        System.setProperty(<span class="string">"catalina.useNaming"</span>, <span class="string">"false"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        System.setProperty(<span class="string">"catalina.useNaming"</span>, <span class="string">"true"</span>);</span><br><span class="line">        String value = <span class="string">"org.apache.naming"</span>;</span><br><span class="line">        String oldValue =</span><br><span class="line">            System.getProperty(javax.naming.Context.URL_PKG_PREFIXES);</span><br><span class="line">        <span class="keyword">if</span> (oldValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">            value = value + <span class="string">":"</span> + oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">        System.setProperty(javax.naming.Context.URL_PKG_PREFIXES, value);</span><br><span class="line">        value = System.getProperty</span><br><span class="line">            (javax.naming.Context.INITIAL_CONTEXT_FACTORY);</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.setProperty</span><br><span class="line">                (javax.naming.Context.INITIAL_CONTEXT_FACTORY,</span><br><span class="line">                    <span class="string">"org.apache.naming.java.javaURLContextFactory"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If a SecurityManager is being used, set properties for</span></span><br><span class="line">    <span class="comment">// checkPackageAccess() and checkPackageDefinition</span></span><br><span class="line">    <span class="keyword">if</span>( System.getSecurityManager() != <span class="keyword">null</span> ) &#123;</span><br><span class="line">        String access = Security.getProperty(<span class="string">"package.access"</span>);</span><br><span class="line">        <span class="keyword">if</span>( access != <span class="keyword">null</span> &amp;&amp; access.length() &gt; <span class="number">0</span> )</span><br><span class="line">            access += <span class="string">","</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            access = <span class="string">"sun.,"</span>;</span><br><span class="line">        Security.setProperty(<span class="string">"package.access"</span>,</span><br><span class="line">            access + <span class="string">"org.apache.catalina.,org.apache.jasper."</span>);</span><br><span class="line">        String definition = Security.getProperty(<span class="string">"package.definition"</span>);</span><br><span class="line">        <span class="keyword">if</span>( definition != <span class="keyword">null</span> &amp;&amp; definition.length() &gt; <span class="number">0</span> )</span><br><span class="line">            definition += <span class="string">","</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            definition = <span class="string">"sun.,"</span>;</span><br><span class="line">        Security.setProperty(<span class="string">"package.definition"</span>,</span><br><span class="line">            <span class="comment">// FIX ME package "javax." was removed to prevent HotSpot</span></span><br><span class="line">            <span class="comment">// fatal internal errors</span></span><br><span class="line">            definition + <span class="string">"java.,org.apache.catalina.,org.apache.jasper."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重定向标准输出和标准错误</span></span><br><span class="line">    SystemLogHandler log = <span class="keyword">new</span> SystemLogHandler(System.out);</span><br><span class="line">    System.setOut(log);</span><br><span class="line">    System.setErr(log);</span><br><span class="line">    <span class="comment">// 设置ShutDownHook,进程退出时关闭Server</span></span><br><span class="line">    Thread shutdownHook = <span class="keyword">new</span> CatalinaShutdownHook();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动Server</span></span><br><span class="line">    <span class="keyword">if</span> (server <span class="keyword">instanceof</span> Lifecycle) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            server.initialize();</span><br><span class="line">            ((Lifecycle) server).start();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Register shutdown hook</span></span><br><span class="line">                Runtime.getRuntime().addShutdownHook(shutdownHook);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                <span class="comment">// This will fail on JDK 1.2. Ignoring, as Tomcat can run</span></span><br><span class="line">                <span class="comment">// fine without the shutdown hook.</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Wait for the server to be told to shut down</span></span><br><span class="line">            server.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Catalina.start: "</span> + e);</span><br><span class="line">            e.printStackTrace(System.out);</span><br><span class="line">            <span class="keyword">if</span> (e.getThrowable() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">"----- Root Cause -----"</span>);</span><br><span class="line">                e.getThrowable().printStackTrace(System.out);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 命令控制的退出就不需要通过hook关闭</span></span><br><span class="line">    <span class="keyword">if</span> (server <span class="keyword">instanceof</span> Lifecycle) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Remove the ShutdownHook first so that server.stop()</span></span><br><span class="line">                <span class="comment">// doesn't get invoked twice</span></span><br><span class="line">                Runtime.getRuntime().removeShutdownHook(shutdownHook);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                <span class="comment">// This will fail on JDK 1.2. Ignoring, as Tomcat can run</span></span><br><span class="line">                <span class="comment">// fine without the shutdown hook.</span></span><br><span class="line">            &#125;</span><br><span class="line">            ((Lifecycle) server).stop();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Catalina.stop: "</span> + e);</span><br><span class="line">            e.printStackTrace(System.out);</span><br><span class="line">            <span class="keyword">if</span> (e.getThrowable() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">"----- Root Cause -----"</span>);</span><br><span class="line">                e.getThrowable().printStackTrace(System.out);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="BootStrap"><a href="#BootStrap" class="headerlink" title="BootStrap"></a>BootStrap</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the debug flag appropriately</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++)  &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"-debug"</span>.equals(args[i]))</span><br><span class="line">            debug = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Configure catalina.base from catalina.home if not yet set</span></span><br><span class="line">    <span class="keyword">if</span> (System.getProperty(<span class="string">"catalina.base"</span>) == <span class="keyword">null</span>)</span><br><span class="line">        System.setProperty(<span class="string">"catalina.base"</span>, getCatalinaHome());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Construct the class loaders we will need</span></span><br><span class="line">    ClassLoader commonLoader = <span class="keyword">null</span>;</span><br><span class="line">    ClassLoader catalinaLoader = <span class="keyword">null</span>;</span><br><span class="line">    ClassLoader sharedLoader = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        File unpacked[] = <span class="keyword">new</span> File[<span class="number">1</span>];</span><br><span class="line">        File packed[] = <span class="keyword">new</span> File[<span class="number">1</span>];</span><br><span class="line">        File packed2[] = <span class="keyword">new</span> File[<span class="number">2</span>];</span><br><span class="line">        ClassLoaderFactory.setDebug(debug);</span><br><span class="line"></span><br><span class="line">        unpacked[<span class="number">0</span>] = <span class="keyword">new</span> File(getCatalinaHome(),</span><br><span class="line">                                <span class="string">"common"</span> + File.separator + <span class="string">"classes"</span>);</span><br><span class="line">        packed2[<span class="number">0</span>] = <span class="keyword">new</span> File(getCatalinaHome(),</span><br><span class="line">                                <span class="string">"common"</span> + File.separator + <span class="string">"endorsed"</span>);</span><br><span class="line">        packed2[<span class="number">1</span>] = <span class="keyword">new</span> File(getCatalinaHome(),</span><br><span class="line">                                <span class="string">"common"</span> + File.separator + <span class="string">"lib"</span>);</span><br><span class="line">        commonLoader =</span><br><span class="line">            ClassLoaderFactory.createClassLoader(unpacked, packed2, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        unpacked[<span class="number">0</span>] = <span class="keyword">new</span> File(getCatalinaHome(),</span><br><span class="line">                                <span class="string">"server"</span> + File.separator + <span class="string">"classes"</span>);</span><br><span class="line">        packed[<span class="number">0</span>] = <span class="keyword">new</span> File(getCatalinaHome(),</span><br><span class="line">                                <span class="string">"server"</span> + File.separator + <span class="string">"lib"</span>);</span><br><span class="line">        catalinaLoader =</span><br><span class="line">            ClassLoaderFactory.createClassLoader(unpacked, packed,</span><br><span class="line">                                                    commonLoader);</span><br><span class="line"></span><br><span class="line">        unpacked[<span class="number">0</span>] = <span class="keyword">new</span> File(getCatalinaBase(),</span><br><span class="line">                                <span class="string">"shared"</span> + File.separator + <span class="string">"classes"</span>);</span><br><span class="line">        packed[<span class="number">0</span>] = <span class="keyword">new</span> File(getCatalinaBase(),</span><br><span class="line">                                <span class="string">"shared"</span> + File.separator + <span class="string">"lib"</span>);</span><br><span class="line">        sharedLoader =</span><br><span class="line">            ClassLoaderFactory.createClassLoader(unpacked, packed,</span><br><span class="line">                                                    commonLoader);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line"></span><br><span class="line">        log(<span class="string">"Class loader creation threw exception"</span>, t);</span><br><span class="line">        System.exit(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Thread.currentThread().setContextClassLoader(catalinaLoader);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        SecurityClassLoad.securityClassLoad(catalinaLoader);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Instantiate a startup class instance</span></span><br><span class="line">        <span class="keyword">if</span> (debug &gt;= <span class="number">1</span>)</span><br><span class="line">            log(<span class="string">"Loading startup class"</span>);</span><br><span class="line">        Class startupClass =</span><br><span class="line">            catalinaLoader.loadClass</span><br><span class="line">            (<span class="string">"org.apache.catalina.startup.Catalina"</span>);</span><br><span class="line">        Object startupInstance = startupClass.newInstance();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化Catalina的parent classloader 为sharedLoader</span></span><br><span class="line">        <span class="keyword">if</span> (debug &gt;= <span class="number">1</span>)</span><br><span class="line">            log(<span class="string">"Setting startup class properties"</span>);</span><br><span class="line">        String methodName = <span class="string">"setParentClassLoader"</span>;</span><br><span class="line">        Class paramTypes[] = <span class="keyword">new</span> Class[<span class="number">1</span>];</span><br><span class="line">        paramTypes[<span class="number">0</span>] = Class.forName(<span class="string">"java.lang.ClassLoader"</span>);</span><br><span class="line">        Object paramValues[] = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br><span class="line">        paramValues[<span class="number">0</span>] = sharedLoader;</span><br><span class="line">        Method method =</span><br><span class="line">            startupInstance.getClass().getMethod(methodName, paramTypes);</span><br><span class="line">        method.invoke(startupInstance, paramValues);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用catalina的process接口</span></span><br><span class="line">        <span class="keyword">if</span> (debug &gt;= <span class="number">1</span>)</span><br><span class="line">            log(<span class="string">"Calling startup class process() method"</span>);</span><br><span class="line">        methodName = <span class="string">"process"</span>;</span><br><span class="line">        paramTypes = <span class="keyword">new</span> Class[<span class="number">1</span>];</span><br><span class="line">        paramTypes[<span class="number">0</span>] = args.getClass();</span><br><span class="line">        paramValues = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br><span class="line">        paramValues[<span class="number">0</span>] = args;</span><br><span class="line">        method =</span><br><span class="line">            startupInstance.getClass().getMethod(methodName, paramTypes);</span><br><span class="line">        method.invoke(startupInstance, paramValues);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        System.out.println(<span class="string">"Exception during startup processing"</span>);</span><br><span class="line">        e.printStackTrace(System.out);</span><br><span class="line">        System.exit(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/java/tomcat/Host & Engine/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/java/tomcat/Host & Engine/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id><a href="#" class="headerlink" title></a></h1><h2 id="StandardHostValve"><a href="#StandardHostValve" class="headerlink" title="StandardHostValve"></a>StandardHostValve</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response,</span></span></span><br><span class="line"><span class="function"><span class="params">                    ValveContext valveContext)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 只处理HttpServlet</span></span><br><span class="line">    <span class="keyword">if</span> (!(request.getRequest() <span class="keyword">instanceof</span> HttpServletRequest) ||</span><br><span class="line">        !(response.getResponse() <span class="keyword">instanceof</span> HttpServletResponse)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;     <span class="comment">// NOTE - Not much else we can do generically</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取匹配的Context</span></span><br><span class="line">    StandardHost host = (StandardHost) getContainer();</span><br><span class="line">    Context context = (Context) host.map(request, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</span><br><span class="line">        ((HttpServletResponse) response.getResponse()).sendError</span><br><span class="line">            (HttpServletResponse.SC_INTERNAL_SERVER_ERROR,</span><br><span class="line">                sm.getString(<span class="string">"standardHost.noContext"</span>));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ????</span></span><br><span class="line">    Thread.currentThread().setContextClassLoader</span><br><span class="line">        (context.getLoader().getClassLoader());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置session的访问记录</span></span><br><span class="line">    HttpServletRequest hreq = (HttpServletRequest) request.getRequest();</span><br><span class="line">    String sessionId = hreq.getRequestedSessionId();</span><br><span class="line">    <span class="keyword">if</span> (sessionId != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Manager manager = context.getManager();</span><br><span class="line">        <span class="keyword">if</span> (manager != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Session session = manager.findSession(sessionId);</span><br><span class="line">            <span class="keyword">if</span> ((session != <span class="keyword">null</span>) &amp;&amp; session.isValid())</span><br><span class="line">                session.access();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用子容器进行处理</span></span><br><span class="line">    context.invoke(request, response);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="StandardEngine"><a href="#StandardEngine" class="headerlink" title="StandardEngine"></a>StandardEngine</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response,</span></span></span><br><span class="line"><span class="function"><span class="params">                    ValveContext valveContext)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">    <span class="comment">// 验证请求的合法性</span></span><br><span class="line">    <span class="keyword">if</span> (!(request.getRequest() <span class="keyword">instanceof</span> HttpServletRequest) ||</span><br><span class="line">        !(response.getResponse() <span class="keyword">instanceof</span> HttpServletResponse)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;     <span class="comment">// NOTE - Not much else we can do generically</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证请求是HTTP1.1的,ServerName?</span></span><br><span class="line">    HttpServletRequest hrequest = (HttpServletRequest) request;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"HTTP/1.1"</span>.equals(hrequest.getProtocol()) &amp;&amp;</span><br><span class="line">        (hrequest.getServerName() == <span class="keyword">null</span>)) &#123;</span><br><span class="line">        ((HttpServletResponse) response.getResponse()).sendError</span><br><span class="line">            (HttpServletResponse.SC_BAD_REQUEST,</span><br><span class="line">                sm.getString(<span class="string">"standardEngine.noHostHeader"</span>,</span><br><span class="line">                            request.getRequest().getServerName()));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取Host</span></span><br><span class="line">    StandardEngine engine = (StandardEngine) getContainer();</span><br><span class="line">    Host host = (Host) engine.map(request, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (host == <span class="keyword">null</span>) &#123;</span><br><span class="line">        ((HttpServletResponse) response.getResponse()).sendError</span><br><span class="line">            (HttpServletResponse.SC_BAD_REQUEST,</span><br><span class="line">                sm.getString(<span class="string">"standardEngine.noHost"</span>,</span><br><span class="line">                            request.getRequest().getServerName()));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 交给Host处理</span></span><br><span class="line">    host.invoke(request, response);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/java/mybatis/objectfactory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/java/mybatis/objectfactory/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#<br>##</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultObjectFactory</span> <span class="keyword">implements</span> <span class="title">ObjectFactory</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">8855120656740914948L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> create(type, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(Class&lt;T&gt; type, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; classToCreate = resolveInterface(type);</span><br><span class="line">    <span class="comment">// we know types are assignable</span></span><br><span class="line">    <span class="keyword">return</span> (T) instantiateClass(classToCreate, constructorArgTypes, constructorArgs);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// no props for default</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>  &lt;T&gt; <span class="function">T <span class="title">instantiateClass</span><span class="params">(Class&lt;T&gt; type, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Constructor&lt;T&gt; constructor;</span><br><span class="line">      <span class="keyword">if</span> (constructorArgTypes == <span class="keyword">null</span> || constructorArgs == <span class="keyword">null</span>) &#123;</span><br><span class="line">        constructor = type.getDeclaredConstructor();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> constructor.newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">          <span class="keyword">if</span> (Reflector.canControlMemberAccessible()) &#123;</span><br><span class="line">            constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> constructor.newInstance();</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      constructor = type.getDeclaredConstructor(constructorArgTypes.toArray(<span class="keyword">new</span> Class[constructorArgTypes.size()]));</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> constructor.newInstance(constructorArgs.toArray(<span class="keyword">new</span> Object[constructorArgs.size()]));</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Reflector.canControlMemberAccessible()) &#123;</span><br><span class="line">          constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">          <span class="keyword">return</span> constructor.newInstance(constructorArgs.toArray(<span class="keyword">new</span> Object[constructorArgs.size()]));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      StringBuilder argTypes = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">      <span class="keyword">if</span> (constructorArgTypes != <span class="keyword">null</span> &amp;&amp; !constructorArgTypes.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; argType : constructorArgTypes) &#123;</span><br><span class="line">          argTypes.append(argType.getSimpleName());</span><br><span class="line">          argTypes.append(<span class="string">","</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        argTypes.deleteCharAt(argTypes.length() - <span class="number">1</span>); <span class="comment">// remove trailing ,</span></span><br><span class="line">      &#125;</span><br><span class="line">      StringBuilder argValues = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">      <span class="keyword">if</span> (constructorArgs != <span class="keyword">null</span> &amp;&amp; !constructorArgs.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Object argValue : constructorArgs) &#123;</span><br><span class="line">          argValues.append(String.valueOf(argValue));</span><br><span class="line">          argValues.append(<span class="string">","</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        argValues.deleteCharAt(argValues.length() - <span class="number">1</span>); <span class="comment">// remove trailing ,</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ReflectionException(<span class="string">"Error instantiating "</span> + type + <span class="string">" with invalid types ("</span> + argTypes + <span class="string">") or values ("</span> + argValues + <span class="string">"). Cause: "</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> Class&lt;?&gt; resolveInterface(Class&lt;?&gt; type) &#123;</span><br><span class="line">    Class&lt;?&gt; classToCreate;</span><br><span class="line">    <span class="keyword">if</span> (type == List.class || type == Collection.class || type == Iterable.class) &#123;</span><br><span class="line">      classToCreate = ArrayList.class;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == Map.class) &#123;</span><br><span class="line">      classToCreate = HashMap.class;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == SortedSet.class) &#123; <span class="comment">// issue #510 Collections Support</span></span><br><span class="line">      classToCreate = TreeSet.class;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == Set.class) &#123;</span><br><span class="line">      classToCreate = HashSet.class;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      classToCreate = type;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> classToCreate;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">isCollection</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Collection.class.isAssignableFrom(type);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">John Doe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">80</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
