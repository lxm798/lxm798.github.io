<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="lxm798">
<meta property="og:url" content="http://yoursite.com/page/8/index.html">
<meta property="og:site_name" content="lxm798">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="lxm798">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/8/">





  <title>lxm798</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">lxm798</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/flink/distrubuted snapshots/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/flink/distrubuted snapshots/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/devops/kebernetes/first try/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/devops/kebernetes/first try/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Kubernetes-初试"><a href="#Kubernetes-初试" class="headerlink" title="Kubernetes 初试"></a>Kubernetes 初试</h1><p>双十一打折买了本k8s权威指南,在周末尝试体验一下.按照我的尝试步骤记录一下</p>
<h2 id="ubuntu-安装-k8s"><a href="#ubuntu-安装-k8s" class="headerlink" title="ubuntu 安装 k8s"></a>ubuntu 安装 k8s</h2><p>周六尝试在ubuntu 上安装k8s,发现没有相关的源.14.04版本太老,尝试升级到16.04,果不其然,系统重启后崩溃. 然后尝试进入windows进行修复,然后打开游戏界面晚到凌晨一点多,放弃</p>
<h2 id="centos-安装k8s"><a href="#centos-安装k8s" class="headerlink" title="centos 安装k8s"></a>centos 安装k8s</h2><p>周日在一台空闲的服务器上安装<br>yum install -y etcd kubernets docker<br>然后编写rc:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"123456"</span></span><br></pre></td></tr></table></figure>

<p>运行kebectl create -f mysql-rc.yaml,发现失败端口8080没有启动,程序没有启动,然后启动程序</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl start etcd</span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl start kube-apiserver</span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<p>再次运行上述命令,成功. 接着查看rc的状态,kubectl get rc</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME      DESIRED   CURRENT   READY     AGE</span><br><span class="line">mysql     1         0         0         1h</span><br></pre></td></tr></table></figure>

<p>mysql没有部署起来…,查找后这里给出答案<a href="https://blog.csdn.net/trend_h/article/details/83824075" target="_blank" rel="noopener">https://blog.csdn.net/trend_h/article/details/83824075</a>,<br>需要跳过认证,编辑/etc/kubernetes/apiserver去除 KUBE_ADMISSION_CONTROL中的SecurityContextDeny,ServiceAccount，并重启kube-apiserver服务,状态变成了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME      DESIRED   CURRENT   READY     AGE</span><br><span class="line">mysql     1         1         0         1h</span><br></pre></td></tr></table></figure>

<p>但是依然没有ready,查看pods,一直处于ContainingCreating状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME          READY     STATUS              RESTARTS   AGE</span><br><span class="line">mysql-sr3g3   0/1       ContainerCreating   0          2h</span><br></pre></td></tr></table></figure>

<p>使用命令kubectl describe pod mysql查看详细信息,出现具体错误</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error syncing pod, skipping: failed to "StartContainer" for "POD" with ErrImagePull: "image pull failed for registry.access.redhat.com/rhel7/pod-infrastructure:latest, this may be because there are no credentials on this request.  details: (open /etc/docker/certs.d/registry.access.redhat.com/redhat-ca.crt: no such file or directory)"</span><br></pre></td></tr></table></figure>

<p>google后,缺少rhsm,安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install rhsm</span><br></pre></td></tr></table></figure>

<p>没有效果,执行以下命令:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/python-rhsm-certificates-1.19.10-1.el7_4.x86_64.rpm</span><br><span class="line">rpm2cpio python-rhsm-certificates-1.19.10-1.el7_4.x86_64.rpm | cpio -iv --to-stdout ./etc/rhsm/ca/redhat-uep.pem | tee /etc/rhsm/ca/redhat-uep.pem</span><br></pre></td></tr></table></figure>

<p>done,执行成功,docker ps 后有mysqldocker 启动</p>
<h2 id="启动service"><a href="#启动service" class="headerlink" title="启动service"></a>启动service</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">mysql</span></span><br></pre></td></tr></table></figure>

<p>开始时spec写成了sepc,查了十分钟…</p>
<h2 id="驱动myweb"><a href="#驱动myweb" class="headerlink" title="驱动myweb"></a>驱动myweb</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">kubeguide/tomcat-app:v1</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<p>开始时上面kubeguide写成了kuberguide,变成了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">myweb-d9gpk   0/1       ImagePullBackOff   0          1m</span><br><span class="line">myweb-dbq9r   0/1       ImagePullBackOff   0          1m</span><br></pre></td></tr></table></figure>

<h2 id="启动web应用"><a href="#启动web应用" class="headerlink" title="启动web应用"></a>启动web应用</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">    nodePort:</span> <span class="number">30001</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">myweb</span></span><br></pre></td></tr></table></figure>

<h2 id="概念和术语"><a href="#概念和术语" class="headerlink" title="概念和术语"></a>概念和术语</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>master:<br>node:</p>
<h3 id="service"><a href="#service" class="headerlink" title="service"></a>service</h3><p>每个pod一个IP<br>每个service 一个虚拟IP cluster IP<br>Node Ip:node所在机器的wangkaicip</p>
<h2 id="和mesos的对比"><a href="#和mesos的对比" class="headerlink" title="和mesos的对比"></a>和mesos的对比</h2><p>mesos 包含master和agent模块,但是没有提供上层类似任务pod数量维护\pod调度等功能,相比于k8s更加灵活,但是需要做的工作更多.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/devops/mesos/delay/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/devops/mesos/delay/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>  // Make sure the executor registers within the given timeout.<br>  delay(flags.executor_registration_timeout,<br>        self(),<br>        &amp;Self::registerExecutorTimeout,<br>        frameworkId,<br>        executor-&gt;id,<br>        executor-&gt;containerId);</p>
<p>  return;<br>}</p>
<p>  if (message.to.address == <strong>address</strong>) {<br>    // Local message.<br>    MessageEvent* event = new MessageEvent(std::move(message));<br>    process_manager-&gt;deliver(event-&gt;message.to, event, sender);<br>  } else {<br>    // Remote message.<br>    socket_manager-&gt;send(std::move(message));<br>  }</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/devops/mesos/mesos 源码分析-master和slave的通信/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/devops/mesos/mesos 源码分析-master和slave的通信/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#mesos 源码分析 -master 和slave 通信</p>
<h2 id="支持的消息"><a href="#支持的消息" class="headerlink" title="支持的消息"></a>支持的消息</h2><h3 id="master"><a href="#master" class="headerlink" title="master"></a>master</h3><table>
<thead>
<tr>
<th>类型</th>
<th>函数</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>SubmitSchedulerRequest</td>
<td>submitScheduler</td>
<td>??</td>
</tr>
<tr>
<td>RegisterFrameworkMessage</td>
<td>registerFramework</td>
<td>注册Framework</td>
</tr>
<tr>
<td>ReregisterFrameworkMessage</td>
<td>reregisterFramework</td>
<td>重新注册Framework</td>
</tr>
<tr>
<td>UnregisterFrameworkMessage</td>
<td>unregisterFramework</td>
<td>注销Framework</td>
</tr>
<tr>
<td>DeactivateFrameworkMessage</td>
<td>deactivateFramework</td>
<td>??</td>
</tr>
<tr>
<td>ResourceRequestMessage</td>
<td>resourceRequest</td>
<td>主动申请资源,scheudler调用</td>
</tr>
<tr>
<td>LaunchTasksMessage</td>
<td>launchTasks</td>
<td>执行task</td>
</tr>
<tr>
<td>ReviveOffersMessage</td>
<td>reviveOffers</td>
<td>??</td>
</tr>
<tr>
<td>KillTaskMessage</td>
<td>killTask</td>
<td>??</td>
</tr>
<tr>
<td>StatusUpdateAcknowledgementMessage</td>
<td>statusUpdateAcknowledgement</td>
<td>??</td>
</tr>
<tr>
<td>FrameworkToExecutorMessage</td>
<td>schedulerMessage</td>
<td>转发请求到Executor</td>
</tr>
<tr>
<td>RegisterSlaveMessage</td>
<td>registerSlave</td>
<td></td>
</tr>
<tr>
<td>ReregisterSlaveMessage</td>
<td>reregisterSlave</td>
<td></td>
</tr>
<tr>
<td>UnregisterSlaveMessage</td>
<td>unregisterSlave</td>
<td></td>
</tr>
<tr>
<td>StatusUpdateMessage</td>
<td>statusUpdate</td>
<td>Executor 发起,task状态变化</td>
</tr>
<tr>
<td>ExecutorToFrameworkMessage</td>
<td>executorMessage</td>
<td>executor 发送消息到framework</td>
</tr>
<tr>
<td>ReconcileTasksMessage</td>
<td>reconcileTasks</td>
<td>??</td>
</tr>
<tr>
<td>UpdateOperationStatusMessage</td>
<td>updateOperationStatus</td>
<td>??</td>
</tr>
<tr>
<td>ExitedExecutorMessage</td>
<td>exitedExecutor</td>
<td>??</td>
</tr>
<tr>
<td>UpdateSlaveMessage</td>
<td>updateSlave</td>
<td>slave在注册或者reconcile时发送</td>
</tr>
<tr>
<td>AuthenticateMessage</td>
<td>authenticate</td>
<td>??</td>
</tr>
</tbody></table>
<p>/**</p>
<ul>
<li><p>This message is sent by the agent to the master to inform the</p>
</li>
<li><p>master about the total amount of oversubscribed (allocated and</p>
</li>
<li><p>allocatable), or total resources. For <code>RESOURCE_PROVIDER</code> capable</p>
</li>
<li><p>agents, this message also includes the operations that are either</p>
</li>
<li><p>pending, or terminal but have unacknowledged status updates.</p>
</li>
<li><p>/<br>message UpdateSlaveMessage {<br>required SlaveID slave_id = 1;</p>
<p>// Top-level fields in this message should only contain information<br>// on the agent itself; information on local resource providers is<br>// passed explicitly in the <code>resource_providers</code> message.<br>//<br>// TODO(bbannier): Consider passing agent information inside a<br>// <code>ResourceProvider</code> value as well where applicable.</p>
<p>// Whether to update oversubscribed resources or not. If we just use<br>// <code>oversubscribed_resources</code>, we don’t have a way to tell if the<br>// intention is to update the oversubscribed resoruces to empty, or<br>// leave it unchanged. For backwards compatibility, if this field is<br>// unset (version &lt; 1.5), we treat that as if only<br>// <code>oversubscribed_resources</code> was set.<br>optional bool update_oversubscribed_resources = 5;<br>repeated Resource oversubscribed_resources = 2;</p>
<p>message Operations {<br>  repeated Operation operations = 1;<br>}</p>
<p>// Pending operations or terminal operations that have<br>// unacknowledged status updates, which are known to this agent.<br>optional Operations operations = 6;</p>
<p>// Used to establish the relationship between the operation and the<br>// resources that the operation is operating on. Each agent will<br>// keep a resource version UUID, and change it when it believes that<br>// its resources are out of sync from the master’s view. The master<br>// will keep track of the last known resource version UUID for each<br>// resource provider or agent, and attach the resource version UUID<br>// in each operation it sends out. The resource provider or agent<br>// should reject operations that have a different resource version<br>// UUID than that it maintains, because this means the operation is<br>// operating on resources that might have already been invalidated.<br>optional UUID resource_version_uuid = 7;</p>
<p>// Describes an agent-local resource provider.<br>message ResourceProvider {<br>  optional ResourceProviderInfo info = 1;<br>  repeated Resource total_resources = 2;<br>  required Operations operations = 3;<br>  required UUID resource_version_uuid = 4;<br>}</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/devops/mesos/mesos源码分析-slave注册/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/devops/mesos/mesos源码分析-slave注册/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Master::__reregisterSlave(</span><br><span class="line">    <span class="keyword">const</span> UPID&amp; pid,</span><br><span class="line">    ReregisterSlaveMessage&amp;&amp; reregisterSlaveMessage,</span><br><span class="line">    <span class="keyword">const</span> Future&lt;<span class="keyword">bool</span>&gt;&amp; future) &#123;</span><br><span class="line">      addSlave(slave, <span class="built_in">std</span>::move(completedFrameworks));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> Master::__registerSlave(</span><br><span class="line">  Slave* slave = <span class="keyword">new</span> Slave(</span><br><span class="line">      <span class="keyword">this</span>,</span><br><span class="line">      slaveInfo,</span><br><span class="line">      pid,</span><br><span class="line">      machineId,</span><br><span class="line">      registerSlaveMessage.version(),</span><br><span class="line">      <span class="built_in">std</span>::move(agentCapabilities),</span><br><span class="line">      Clock::now(),</span><br><span class="line">      <span class="built_in">std</span>::move(checkpointedResources),</span><br><span class="line">      resourceVersion);</span><br><span class="line"></span><br><span class="line">  ++metrics-&gt;slave_registrations;</span><br><span class="line"></span><br><span class="line">  addSlave(slave, &#123;&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/devops/mesos/mesos源码分析-slave recovery/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/devops/mesos/mesos源码分析-slave recovery/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="mesos-源码分析-slave-recovery"><a href="#mesos-源码分析-slave-recovery" class="headerlink" title="mesos 源码分析-slave recovery"></a>mesos 源码分析-slave recovery</h1><h2 id="slave-recovery"><a href="#slave-recovery" class="headerlink" title="slave recovery"></a>slave recovery</h2><h3 id="相关参数"><a href="#相关参数" class="headerlink" title="相关参数"></a>相关参数</h3><table>
<thead>
<tr>
<th align="center">配置</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">strict</td>
<td align="center">如果strict=true,任何recovery错误都会导致agent启动失败,如果strict=false,启动时的错误会被忽略,以便尽可能的恢复运行状态</td>
</tr>
<tr>
<td align="center">reconfiguration_policy</td>
<td align="center">如果时equal,启动选项和重启前要严格一致,如果是additive,允许增加资源或者属性</td>
</tr>
<tr>
<td align="center">recover</td>
<td align="center">如果时reconnect,允许任何executors重连,如果是clean,会直接kill之前的executor</td>
</tr>
<tr>
<td align="center">recovery_timeout</td>
<td align="center">如果agent 恢复时间超过recovery_timeout,任何executors会self-terminate. 还不清楚executor有没有回调</td>
</tr>
</tbody></table>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p>Slave 启动时在初始化阶段恢复之前executor和task的信息和状态</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Slave::initialize()</span><br><span class="line">&#123;</span><br><span class="line">      <span class="comment">// Do recovery.</span></span><br><span class="line">  async(&amp;state::recover, metaDir, flags.strict)</span><br><span class="line">    .then(defer(self(), &amp;Slave::recover, lambda::_1))</span><br><span class="line">    .then(defer(self(), &amp;Slave::_recover))</span><br><span class="line">    .onAny(defer(self(), &amp;Slave::__recover, lambda::_1));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>recover: 遍历root目录下的文件,找到executor和task的信息,同时发送之前未发送成功的消息<br>_recover: 如果recover的状态是”reconnect”,恢复executor,清除一定延时内没有恢复的executor.<br>__recover: 清楚之前slave的meta的数据,重新连接master,但是在ping超时后也没有shutdown.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">  ```cpp</span><br><span class="line">  Future&lt;Nothing&gt; TaskStatusUpdateManagerProcess::recover(</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">string</span>&amp; rootDir,</span><br><span class="line">    <span class="keyword">const</span> Option&lt;SlaveState&gt;&amp; state)</span><br><span class="line">&#123;</span><br><span class="line">  LOG(INFO) &lt;&lt; <span class="string">"Recovering task status update manager"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (state.isNone()) &#123;</span><br><span class="line">    <span class="keyword">return</span> Nothing();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  foreachvalue (<span class="keyword">const</span> FrameworkState&amp; framework, state-&gt;frameworks) &#123;</span><br><span class="line">    foreachvalue (<span class="keyword">const</span> ExecutorState&amp; executor, framework.executors) &#123;</span><br><span class="line">      LOG(INFO) &lt;&lt; <span class="string">"Recovering executor '"</span> &lt;&lt; executor.id</span><br><span class="line">                &lt;&lt; <span class="string">"' of framework "</span> &lt;&lt; framework.id;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (executor.info.isNone()) &#123;</span><br><span class="line">        LOG(WARNING) &lt;&lt; <span class="string">"Skipping recovering task status updates of"</span></span><br><span class="line">                     &lt;&lt; <span class="string">" executor '"</span> &lt;&lt; executor.id</span><br><span class="line">                     &lt;&lt; <span class="string">"' of framework "</span> &lt;&lt; framework.id</span><br><span class="line">                     &lt;&lt; <span class="string">" because its info cannot be recovered"</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (executor.latest.isNone()) &#123;</span><br><span class="line">        LOG(WARNING) &lt;&lt; <span class="string">"Skipping recovering task status updates of"</span></span><br><span class="line">                     &lt;&lt; <span class="string">" executor '"</span> &lt;&lt; executor.id</span><br><span class="line">                     &lt;&lt; <span class="string">"' of framework "</span> &lt;&lt; framework.id</span><br><span class="line">                     &lt;&lt; <span class="string">" because its latest run cannot be recovered"</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// We are only interested in the latest run of the executor!</span></span><br><span class="line">      <span class="keyword">const</span> ContainerID&amp; latest = executor.latest.get();</span><br><span class="line">      Option&lt;RunState&gt; run = executor.runs.get(latest);</span><br><span class="line">      CHECK_SOME(run);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (run-&gt;completed) &#123;</span><br><span class="line">        VLOG(<span class="number">1</span>) &lt;&lt; <span class="string">"Skipping recovering task status updates of"</span></span><br><span class="line">                &lt;&lt; <span class="string">" executor '"</span> &lt;&lt; executor.id</span><br><span class="line">                &lt;&lt; <span class="string">"' of framework "</span> &lt;&lt; framework.id</span><br><span class="line">                &lt;&lt; <span class="string">" because its latest run "</span> &lt;&lt; latest.value()</span><br><span class="line">                &lt;&lt; <span class="string">" is completed"</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      foreachvalue (<span class="keyword">const</span> TaskState&amp; task, run-&gt;tasks) &#123;</span><br><span class="line">        <span class="comment">// No updates were ever received for this task!</span></span><br><span class="line">        <span class="comment">// This means either:</span></span><br><span class="line">        <span class="comment">// 1) the executor never received this task or</span></span><br><span class="line">        <span class="comment">// 2) executor launched it but the slave died before it got any updates.</span></span><br><span class="line">        <span class="keyword">if</span> (task.updates.empty()) &#123;</span><br><span class="line">          LOG(WARNING) &lt;&lt; <span class="string">"No status updates found for task "</span> &lt;&lt; task.id</span><br><span class="line">                       &lt;&lt; <span class="string">" of framework "</span> &lt;&lt; framework.id;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create a new status update stream.</span></span><br><span class="line">        TaskStatusUpdateStream* stream = createStatusUpdateStream(</span><br><span class="line">            task.id, framework.id, state-&gt;id, <span class="literal">true</span>, executor.id, latest);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Replay the stream.</span></span><br><span class="line">        Try&lt;Nothing&gt; replay = stream-&gt;replay(task.updates, task.acks);</span><br><span class="line">        <span class="keyword">if</span> (replay.isError()) &#123;</span><br><span class="line">          <span class="keyword">return</span> Failure(</span><br><span class="line">              <span class="string">"Failed to replay status updates for task "</span> + stringify(task.id) +</span><br><span class="line">              <span class="string">" of framework "</span> + stringify(framework.id) +</span><br><span class="line">              <span class="string">": "</span> + replay.error());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// At the end of the replay, the stream is either terminated or</span></span><br><span class="line">        <span class="comment">// contains only unacknowledged, if any, pending updates. The</span></span><br><span class="line">        <span class="comment">// pending updates will be flushed after the slave</span></span><br><span class="line">        <span class="comment">// reregisters with the master.</span></span><br><span class="line">        <span class="keyword">if</span> (stream-&gt;terminated) &#123;</span><br><span class="line">          cleanupStatusUpdateStream(task.id, framework.id);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Nothing();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  slave在启动的时候检查work_dir,确定启动前的task\executor的信息. 保存在work_dir的meta 目录下</p>
<p>  // We pause the task status update manager so that it doesn’t forward any<br>  // updates while the slave is still recovering. It is unpaused/resumed when<br>  // the slave (re-)registers with the master.<br>  taskStatusUpdateManager-&gt;pause();</p>
<pre><code>// Do recovery.</code></pre><p>  async(&amp;state::recover, metaDir, flags.strict)<br>    .then(defer(self(), &amp;Slave::recover, lambda::_1))<br>    .then(defer(self(), &amp;Slave::_recover))<br>    .onAny(defer(self(), &amp;Slave::__recover, lambda::_1));</p>
<pre><code>message Task {
  required string name = 1;
  required TaskID id = 2;
  repeated Resource resources = 3;
  optional Labels labels = 4;
}

message StatusUpdateRecord {</code></pre><p>  enum Type {<br>    UPDATE = 0;<br>    ACK = 1;<br>  }</p>
<p>  required Type type = 1;</p>
<p>  // Required if type == UPDATE.<br>  optional StatusUpdate update = 2;</p>
<p>  // Required if type == ACK.<br>  optional bytes uuid = 3;<br>}</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/devops/mesos/mesos源码分析1-结构/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/devops/mesos/mesos源码分析1-结构/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Mesos-源码分析–快速入门"><a href="#Mesos-源码分析–快速入门" class="headerlink" title="Mesos 源码分析–快速入门"></a>Mesos 源码分析–快速入门</h1><h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><img src="./pic/architecture3.jpg" width="500" height="300">
mesos 由scheduler,master,agent和exeuctor组成.其中master管理在每个node中的gagent,资源由master负责分配,每份资源由类似(agent ID, resource1: amount1, resource2: amount2,...)结构描述.

<h2 id="资源分配示例"><a href="#资源分配示例" class="headerlink" title="资源分配示例"></a>资源分配示例</h2><img src="./pic/architecture-example.jpg" width="400" height="300">

<ol>
<li>Agent1 上报给master其包含(4 CPUS,4GB MEM)</li>
<li>master 按照资源分配算法分配资源</li>
<li>schdueler 回复master使用哪些资源运行task</li>
<li>master将task分发给agent</li>
</ol>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><p>以ubuntu16.04为例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">git clone git@github.com:apache/mesos.git</span><br><span class="line">cd mesos</span><br><span class="line">sudo apt-get install -y openjdk-8-jdk</span><br><span class="line">sudo apt-get install -y autoconf libtool</span><br><span class="line">sudo apt-get -y install build-essential python-dev python-six python-virtualenv libcurl4-nss-dev libsasl2-dev libsasl2-modules maven libapr1-dev libsvn-dev zlib1g-dev iputils-ping</span><br><span class="line">./bootstrap</span><br><span class="line">mkdir build</span><br><span class="line">cd build</span><br><span class="line">../configure</span><br><span class="line">make -j 4</span><br><span class="line">make check</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./bin/mesos-master.sh --ip=127.0.0.1 --work_dir=/var/lib/mesos</span><br><span class="line">./bin/mesos-agent.sh --master=127.0.0.1:5050 --work_dir=/var/lib/mesos</span><br><span class="line">./src/examples/java/test-framework 127.0.0.1:5050</span><br></pre></td></tr></table></figure>

<h2 id="编译产出"><a href="#编译产出" class="headerlink" title="编译产出"></a>编译产出</h2><p> 编译后在build目录下会有多个文件:</p>
<ul>
<li>mesos : shell 脚本,用于启动master,agent</li>
<li>mesos-master.sh : shell脚本启动master</li>
<li>mesos-agent.sh : 用于启动agent</li>
<li>mesos-execute : mesos的cli,作为mesos的framework运行</li>
<li>mesos-executor : mesos executor task的默认executor</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/devops/mesos/mesos源码分析2-libprocess/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/devops/mesos/mesos源码分析2-libprocess/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="mesos源码分析2-libprocess"><a href="#mesos源码分析2-libprocess" class="headerlink" title="mesos源码分析2-libprocess"></a>mesos源码分析2-libprocess</h1><h2 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h2><p>libprocess 以futures/promises, HTTP和actor 模型为基础,提供一套异步编程的抽象框架.</p>
<h3 id="Futures-amp-Promises-amp-Callback"><a href="#Futures-amp-Promises-amp-Callback" class="headerlink" title="Futures &amp; Promises &amp; Callback"></a>Futures &amp; Promises &amp; Callback</h3><p>并发编程中通常会用到非阻塞模型:Pormise,Future &amp; Callback.Future 表示一个还没有完成的异步任务的结果,针对这个结果可以添加Callback以便在任务执行成功或者失败后做出相应的操作.Promise 交由任务执行者,用于标记任务执行成功或者失败. 使用实例:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> process::Future;</span><br><span class="line"><span class="keyword">using</span> process::Promise;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Returns an instance of `Person` for the specified `name`.</span></span><br><span class="line">Future&lt;Person&gt; find(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Returns the mother (an instance of `Person`) of the specified `name`.</span></span><br><span class="line">Future&lt;Person&gt; mother(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// First find the person.</span></span><br><span class="line">  Future&lt;Person&gt; person = find(name);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Now create a `Promise` that we can use to compose the two asynchronous calls.</span></span><br><span class="line">  Promise&lt;Person&gt;* promise = <span class="keyword">new</span> Promise&lt;Person&gt;();</span><br><span class="line"></span><br><span class="line">  Future&lt;Person&gt; mother = promise-&gt;future();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Here is the boiler plate that can be replaced by `Future::then()`!</span></span><br><span class="line">  person.onAny([](<span class="keyword">const</span> Future&lt;Person&gt;&amp; person) &#123;</span><br><span class="line">    <span class="keyword">if</span> (person.isFailed()) &#123;</span><br><span class="line">      promise-&gt;fail(person.failure());</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (person.isDiscarded()) &#123;</span><br><span class="line">      promise-&gt;discard();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      CHECK_READY(person);</span><br><span class="line">      promise-&gt;<span class="built_in">set</span>(find(person-&gt;mother));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">delete</span> promise;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> mother;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中Promise主要结构:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Future</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// Constructs a failed future.</span></span><br><span class="line">  <span class="keyword">static</span> Future&lt;T&gt; failed(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; message);</span><br><span class="line"></span><br><span class="line">  Future();</span><br><span class="line"></span><br><span class="line">  ~Future() = <span class="keyword">default</span>;</span><br><span class="line">  <span class="function"><span class="keyword">const</span> T&amp; <span class="title">get</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">enum</span> State</span><br><span class="line">  &#123;</span><br><span class="line">    PENDING,</span><br><span class="line">    READY,</span><br><span class="line">    FAILED,</span><br><span class="line">    DISCARDED,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">Data</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    Data();</span><br><span class="line">    ~Data() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clearAllCallbacks</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::atomic_flag lock = ATOMIC_FLAG_INIT;</span><br><span class="line">    State state;</span><br><span class="line">    <span class="keyword">bool</span> discard;</span><br><span class="line">    <span class="keyword">bool</span> associated;</span><br><span class="line">    <span class="keyword">bool</span> abandoned;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// One of:</span></span><br><span class="line">    <span class="comment">//   1. None, the state is PENDING or DISCARDED.</span></span><br><span class="line">    <span class="comment">//   2. Some, the state is READY.</span></span><br><span class="line">    <span class="comment">//   3. Error, the state is FAILED; 'error()' stores the message.</span></span><br><span class="line">    Result&lt;T&gt; result;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;AbandonedCallback&gt; onAbandonedCallbacks;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;DiscardCallback&gt; onDiscardCallbacks;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;ReadyCallback&gt; onReadyCallbacks;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;FailedCallback&gt; onFailedCallbacks;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;DiscardedCallback&gt; onDiscardedCallbacks;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;AnyCallback&gt; onAnyCallbacks;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>get实现:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">const</span> T&amp; Future&lt;T&gt;::get() <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isReady()) &#123;</span><br><span class="line">    await();</span><br><span class="line">  &#125;</span><br><span class="line">  .....</span><br><span class="line">  <span class="keyword">return</span> data-&gt;result.get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">bool</span> Future&lt;T&gt;::await(<span class="keyword">const</span> Duration&amp; duration) <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">  Owned&lt;Latch&gt; latch(<span class="keyword">new</span> Latch());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">bool</span> pending = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  synchronized (data-&gt;lock) &#123;</span><br><span class="line">    <span class="keyword">if</span> (data-&gt;state == PENDING) &#123;</span><br><span class="line">      pending = <span class="literal">true</span>;</span><br><span class="line">      data-&gt;onAnyCallbacks.push_back(lambda::bind(&amp;internal::awaited, latch));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (pending) &#123;</span><br><span class="line">    <span class="keyword">return</span> latch-&gt;await(duration);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Latch 整体写法比较有意思,但是不知道为什么不直接依赖pthread_condition,可能考虑使用EventLoop降低定时器的代价(猜测),trigger通过结束pid用于触发wait :</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Latch</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  Latch();</span><br><span class="line">  <span class="keyword">virtual</span> ~Latch();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">bool</span> <span class="keyword">operator</span>==(<span class="keyword">const</span> Latch&amp; that) <span class="keyword">const</span> &#123; <span class="keyword">return</span> pid == that.pid; &#125;</span><br><span class="line">  <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Latch&amp; that) <span class="keyword">const</span> &#123; <span class="keyword">return</span> pid &lt; that.pid; &#125;+</span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">trigger</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">await</span><span class="params">(<span class="keyword">const</span> Duration&amp; duration = Seconds(<span class="number">-1</span>))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  Latch(<span class="keyword">const</span> Latch&amp; that);</span><br><span class="line">  Latch&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> Latch&amp; that);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">atomic_bool</span> triggered;</span><br><span class="line">  UPID pid;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Latch构造函数和等待</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Latch::Latch() : triggered(<span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 创建新的ProcessBase对象,用于</span></span><br><span class="line">  pid = spawn(<span class="keyword">new</span> ProcessBase(ID::generate(<span class="string">"__latch__"</span>)), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> Latch::trigger()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">bool</span> expected = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (triggered.compare_exchange_strong(expected, <span class="literal">true</span>)) &#123;</span><br><span class="line">    terminate(pid);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> Latch::await(<span class="keyword">const</span> Duration&amp; duration)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (!triggered.load()) &#123;</span><br><span class="line">    process::wait(pid, duration); <span class="comment">// Explict to disambiguate.</span></span><br><span class="line">    <span class="comment">// It's possible that we failed to wait because:</span></span><br><span class="line">    <span class="comment">//   (1) Our process has already terminated.</span></span><br><span class="line">    <span class="comment">//   (2) We timed out (i.e., duration was not "infinite").</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// In the event of (1) we might need to return 'true' since a</span></span><br><span class="line">    <span class="comment">// terminated process might imply that the latch has been</span></span><br><span class="line">    <span class="comment">// triggered. To capture this we simply return the value of</span></span><br><span class="line">    <span class="comment">// 'triggered' (which will also capture cases where we actually</span></span><br><span class="line">    <span class="comment">// timed out but have since triggered, which seems like an</span></span><br><span class="line">    <span class="comment">// acceptable semantics given such a "tie").</span></span><br><span class="line">    <span class="keyword">return</span> triggered.load();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里的利用process的wait来处理等待:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">wait</span><span class="params">(<span class="keyword">const</span> UPID&amp; pid, <span class="keyword">const</span> Duration&amp; duration)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  process::initialize();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!pid) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This could result in a deadlock if some code decides to wait on a</span></span><br><span class="line">  <span class="comment">// process that has invoked that code!</span></span><br><span class="line">  <span class="keyword">if</span> (__process__ != <span class="literal">nullptr</span> &amp;&amp; __process__-&gt;self() == pid) &#123;</span><br><span class="line">    LOG(ERROR) &lt;&lt; <span class="string">"\n**** DEADLOCK DETECTED! ****\nYou are waiting on process "</span></span><br><span class="line">               &lt;&lt; pid &lt;&lt; <span class="string">" that it is currently executing."</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (duration == Seconds(<span class="number">-1</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> process_manager-&gt;wait(pid);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">bool</span> waited = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">WaitWaiter <span class="title">waiter</span><span class="params">(pid, duration, &amp;waited)</span></span>;</span><br><span class="line">  spawn(waiter);</span><br><span class="line">  wait(waiter);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> waited;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果没有超时时间就利用processManager的wait,如果有超时就在生成一个Process,然后用定时器触发事件.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">WaitWaiter(<span class="keyword">const</span> UPID&amp; _pid, <span class="keyword">const</span> Duration&amp; _duration, <span class="keyword">bool</span>* _waited)</span><br><span class="line">  : ProcessBase(ID::generate(<span class="string">"__waiter__"</span>)),</span><br><span class="line">    pid(_pid),</span><br><span class="line">    duration(_duration),</span><br><span class="line">    waited(_waited) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  VLOG(<span class="number">3</span>) &lt;&lt; <span class="string">"Running waiter process for "</span> &lt;&lt; pid;</span><br><span class="line">  link(pid);</span><br><span class="line">  delay(duration, self(), &amp;WaitWaiter::timeout);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">timeout</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  VLOG(<span class="number">3</span>) &lt;&lt; <span class="string">"Waiter process timed out waiting for "</span> &lt;&lt; pid;</span><br><span class="line">  *waited = <span class="literal">false</span>;</span><br><span class="line">  terminate(self());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function">Timer <span class="title">delay</span><span class="params">(<span class="keyword">const</span> Duration&amp; duration,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">const</span> PID&lt;T&gt;&amp; pid,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">void</span> (T::*method)())</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Clock::timer(duration, [=]() &#123;</span><br><span class="line">    dispatch(pid, method);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Timer Clock::timer(</span><br><span class="line">    <span class="keyword">const</span> Duration&amp; duration,</span><br><span class="line">    <span class="keyword">const</span> lambda::function&lt;<span class="keyword">void</span>()&gt;&amp; thunk)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add the timer.</span></span><br><span class="line">  synchronized (timers_mutex) &#123;</span><br><span class="line">      clock::scheduleTick(*timers, clock::ticks);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> timer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleTick</span><span class="params">(<span class="keyword">const</span> <span class="built_in">map</span>&lt;Time, <span class="built_in">list</span>&lt;Timer&gt;&gt;&amp; timers, <span class="built_in">set</span>&lt;Time&gt;* ticks)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// Determine when the next 'tick' should fire.</span></span><br><span class="line">  <span class="keyword">const</span> Option&lt;Time&gt; next = clock::next(timers);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (next.isSome()) &#123;</span><br><span class="line">    <span class="comment">// Don't schedule a 'tick' if there is a 'tick' scheduled for</span></span><br><span class="line">    <span class="comment">// an earlier time, to avoid excessive pending timers.</span></span><br><span class="line">    <span class="keyword">if</span> (ticks-&gt;empty() || next.get() &lt; (*ticks-&gt;begin())) &#123;</span><br><span class="line">      ticks-&gt;insert(next.get());</span><br><span class="line"></span><br><span class="line">      <span class="comment">// The delay can be negative if the timer is expired, this</span></span><br><span class="line">      <span class="comment">// is expected will result in a 'tick' firing immediately.</span></span><br><span class="line">      <span class="keyword">const</span> Duration delay = next.get() - Clock::now(<span class="literal">nullptr</span>);</span><br><span class="line">      EventLoop::delay(delay, lambda::bind(tick, next.get()));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>绕了一大圈,超时问题依然用EventLoop的delay解决.<br>对于等待事件使用ProcessManager的wait,wait函数中最终等待的是ProcessBase中的gate,gate是对pthread_condition相关函数的封装,pthread_cond_singal,在actor收到TerminateEvent,退出时调用open,</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> ProcessManager::resume(ProcessBase* process) &#123;</span><br><span class="line">    <span class="keyword">while</span> (!terminate &amp;&amp; !blocked) &#123;</span><br><span class="line">        ...</span><br><span class="line">        terminate = event-&gt;is&lt;TerminateEvent&gt;();</span><br><span class="line">        process-&gt;serve(<span class="built_in">std</span>::move(*event));</span><br><span class="line">        <span class="keyword">delete</span> event;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    reference = ProcessReference();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (terminate) &#123;</span><br><span class="line">      cleanup(process);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    __process__ = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">if</span> (terminate &amp;&amp; manage) &#123;</span><br><span class="line">      <span class="keyword">delete</span> process;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是底层eventloop 的上层处理,process-&gt;serve(std::move(*event));terminate = event-&gt;is<terminateevent>();使用visitor模式处理.</terminateevent></p>
<p>Promise中set数据数据时调用Future<t>::set:</t></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> U&gt;</span><br><span class="line"><span class="keyword">bool</span> Future&lt;T&gt;::_set(U&amp;&amp; u)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">bool</span> result = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  synchronized (data-&gt;lock) &#123;</span><br><span class="line">    <span class="keyword">if</span> (data-&gt;state == PENDING) &#123;</span><br><span class="line">      data-&gt;result = <span class="built_in">std</span>::forward&lt;U&gt;(u);</span><br><span class="line">      data-&gt;state = READY;</span><br><span class="line">      result = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Invoke all callbacks associated with this future being READY. We</span></span><br><span class="line">  <span class="comment">// don't need a lock because the state is now in READY so there</span></span><br><span class="line">  <span class="comment">// should not be any concurrent modifications to the callbacks.</span></span><br><span class="line">  <span class="keyword">if</span> (result) &#123;</span><br><span class="line">    <span class="comment">// Grab a copy of `data` just in case invoking the callbacks</span></span><br><span class="line">    <span class="comment">// erroneously attempts to delete this future.</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;<span class="keyword">typename</span> Future&lt;T&gt;::Data&gt; copy = data;</span><br><span class="line">    <span class="comment">// 在Future::await时会将internal::awaited加入onAnyCallbacks中,awaited调用trigger发送结果</span></span><br><span class="line">    internal::run(<span class="built_in">std</span>::move(copy-&gt;onReadyCallbacks), copy-&gt;result.get());</span><br><span class="line">    internal::run(<span class="built_in">std</span>::move(copy-&gt;onAnyCallbacks), *<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    copy-&gt;clearAllCallbacks();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/devops/mesos/mesos源码分析-libprocess(1)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/devops/mesos/mesos源码分析-libprocess(1)/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T23:15:07+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lxm798">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/03/hello-world/" itemprop="url">Hello World</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-03T20:31:15+08:00">
                2019-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">John Doe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">80</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
